<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Agro Divel • Comparador PDI vs. ETIM (JS)</title>
<meta name="theme-color" content="#001439" />
<style>
  /* Seu CSS original vai aqui, sem alterações */
  :root{--bg:#f5f7fb;--card:#ffffff;--ink:#111827;--muted:#6b7280;--brand:#001439;--brand-2:#0f2a66;--ok:#0ea5e9;--shadow:0 10px 30px rgba(0,0,0,.08);--radius:14px;}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--ink);background:radial-gradient(800px 400px at 10% -10%, #e8eefc 0, transparent 60%),radial-gradient(900px 500px at 110% 10%, #e6f5ff 0, transparent 60%),var(--bg);}
  .container{max-width:800px;margin:42px auto;padding:0 18px}
  .header{display:flex;align-items:center;gap:14px;margin-bottom:20px}
  .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#0060ff,#00b7ff);display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow)}
  .title h1{font-size:22px;margin:0;color:var(--brand)}
  .title p{margin:2px 0 0;color:var(--muted);font-size:13px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
  .grid{display:grid;gap:14px}
  @media (min-width:700px){ .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))} }
  label{font-size:13px;color:var(--muted);display:block;margin:2px 2px 6px}
  .file{position:relative;border:1px dashed #cbd5e1;border-radius:12px;background:#f8fafc;padding:16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition: border-color .15s ease;}
  .file input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .file .hint{font-size:13px;color:var(--muted);pointer-events:none;}
  .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition: background-color .15s ease, filter .15s ease;}
  button:disabled{cursor:not-allowed;opacity:.7}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-primary:hover:not(:disabled){background:var(--brand-2)}
  .btn-ghost{background:#eef2ff;color:var(--brand)}
  .btn-ghost:hover:not(:disabled){filter:brightness(.97)}
  .report{margin-top:22px;display:none}
  .report-header{background:linear-gradient(135deg,#001439, #20386f);color:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
  .report-header h2{margin:0 0 6px;font-size:20px}
  .report-header p{margin:0;font-size:13px;opacity:.9}
  .footer-actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;background:rgba(255,255,255,.15);color:#fff;margin-right:6px}
  .error{margin-top:12px;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:12px;border-radius:12px;display:none;font-size: 14px; line-height: 1.5;}
  .loading{display:none;align-items:center;gap:10px;margin-top:12px;color:#334155}
  .spinner{width:16px;height:16px;border:3px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .results-table{width:100%;margin-top:16px;border-collapse:collapse;box-shadow:var(--shadow);border-radius:var(--radius);overflow:hidden}
  .results-table th, .results-table td{border:1px solid #eef2f7;padding:12px;text-align:left;font-size:14px;}
  .results-table th{background:#f8fafc;font-size:13px;color:var(--muted);font-weight:600;}
  .results-table tbody tr:nth-child(odd){background-color: #fdfdfe;}
</style>
</head>
<body>
  <div class="container">
    <!-- O HTML da interface continua o mesmo -->
    <div class="header">
      <div class="logo">AD</div>
      <div class="title">
        <h1>Comparador PDI vs. ETIM</h1>
        <p>Envie os relatórios para encontrar os chassis que faltam no ETIM.</p>
      </div>
    </div>
    <div class="card">
      <div class="grid cols-2">
        <div>
          <label>Relatório PDI (Máquinas Novas)</label>
          <div class="file" id="fileBoxPDI">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M14.5 2H6a2 2 0 0 0-2 2v12.5A3.5 3.5 0 0 0 7.5 20H18a2 2 0 0 0 2-2V7.5L14.5 2Z" stroke="#334155" stroke-width="1.6"/><path d="M14 2v4a2 2 0 0 0 2 2h4" stroke="#334155" stroke-width="1.6"/></svg>
            <div class="hint"><strong>Escolha o arquivo PDI</strong></div>
            <input type="file" id="fileInputPDI" accept=".xlsx, .xls" />
          </div>
        </div>
        <div>
          <label>Relatório ETIM (Parque de Máquinas)</label>
          <div class="file" id="fileBoxETIM">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M14.5 2H6a2 2 0 0 0-2 2v12.5A3.5 3.5 0 0 0 7.5 20H18a2 2 0 0 0 2-2V7.5L14.5 2Z" stroke="#334155" stroke-width="1.6"/><path d="M14 2v4a2 2 0 0 0 2 2h4" stroke="#334155" stroke-width="1.6"/></svg>
            <div class="hint"><strong>Escolha o arquivo ETIM</strong></div>
            <input type="file" id="fileInputETIM" accept=".xlsx, .xls" />
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn-primary" id="btnAnalisar">Analisar Agora</button>
        <button class="btn-ghost" id="btnExportar" style="display:none;">Exportar para Excel</button>
      </div>
      <div class="loading" id="loading"><span class="spinner"></span> Comparando os arquivos...</div>
      <div class="error" id="errorBox"></div>
    </div>
    <div class="report" id="report">
      <div class="report-header">
        <h2 id="repTitle">✅ Análise Concluída</h2>
        <p id="repSub"></p>
        <div class="footer-actions">
          <span class="chip" id="chipFaltantes">Chassis Faltantes: —</span>
        </div>
      </div>
      <div id="resultsHost"></div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
  const $ = (id ) => document.getElementById(id);
  // ... (código de setupFileUpload igual ao anterior) ...
  function setupFileUpload(inputId, boxId) {
    const fileInput = $(inputId);
    const fileBox = $(boxId);
    const hint = fileBox.querySelector(".hint");
    const originalHint = hint.innerHTML;

    fileInput.addEventListener("change", () => {
      const f = fileInput.files[0];
      hint.innerHTML = f ? `<strong>${f.name}</strong>` : originalHint;
    });
    ["dragenter", "dragover"].forEach(ev => fileBox.addEventListener(ev, e => { e.preventDefault(); fileBox.style.borderColor = "#93c5fd"; }));
    ["dragleave", "drop"].forEach(ev => fileBox.addEventListener(ev, e => { e.preventDefault(); fileBox.style.borderColor = "#cbd5e1"; }));
    fileBox.addEventListener("drop", e => {
      const f = e.dataTransfer.files[0];
      if (f) { fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event("change")); }
    });
  }

  setupFileUpload("fileInputPDI", "fileBoxPDI");
  setupFileUpload("fileInputETIM", "fileBoxETIM");

  let analysisResult = [];

  $("btnAnalisar").addEventListener("click", analisar);
  $("btnExportar").addEventListener("click", exportar);

  // Função para ler um arquivo Excel e converter para JSON
  function lerExcel(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(worksheet);
          resolve(json);
        } catch (err) {
          reject(err);
        }
      };
      reader.onerror = (err) => reject(err);
      reader.readAsArrayBuffer(file);
    });
  }

  async function analisar() {
    const err = $("errorBox"); err.style.display = "none";
    const loading = $("loading"); loading.style.display = "flex";
    $("btnAnalisar").disabled = true;
    $("report").style.display = "none";
    $("btnExportar").style.display = "none";

    try {
      const filePDI = $("fileInputPDI").files[0];
      const fileETIM = $("fileInputETIM").files[0];
      if (!filePDI || !fileETIM) { throw new Error("Por favor, selecione os dois arquivos."); }

      // Nomes das colunas
      const colunaPDI = 'Número de identificação do produto';
      const colunaETIM = 'PIN';

      // Ler os dois arquivos em paralelo
      const [pdiData, etimData] = await Promise.all([
        lerExcel(filePDI),
        lerExcel(fileETIM)
      ]);

      if (pdiData.length === 0) throw new Error("O arquivo PDI está vazio ou em um formato inválido.");
      if (etimData.length === 0) throw new Error("O arquivo ETIM está vazio ou em um formato inválido.");

      // Validar colunas
      if (!pdiData[0].hasOwnProperty(colunaPDI)) {
        throw new Error(`A coluna '${colunaPDI}' não foi encontrada no arquivo PDI. Colunas encontradas: ${Object.keys(pdiData[0]).join(', ')}`);
      }
      if (!etimData[0].hasOwnProperty(colunaETIM)) {
        throw new Error(`A coluna '${colunaETIM}' não foi encontrada no arquivo ETIM. Colunas encontradas: ${Object.keys(etimData[0]).join(', ')}`);
      }

      // Criar um Set com os PINs do ETIM para busca rápida
      const etimPins = new Set(etimData.map(row => String(row[colunaETIM]).trim()));

      // Filtrar os dados do PDI
      const chassisFaltantes = pdiData.filter(row => {
        const pdiPin = String(row[colunaPDI]).trim();
        return !etimPins.has(pdiPin);
      });

      analysisResult = chassisFaltantes;
      renderReport(analysisResult);

    } catch (e) {
      console.error("ERRO NA ANÁLISE:", e);
      err.textContent = e.message;
      err.style.display = "block";
    } finally {
      loading.style.display = "none";
      $("btnAnalisar").disabled = false;
    }
  }

  // A função renderReport e exportar continuam as mesmas
  function renderReport(data) { /* ...código idêntico ao anterior... */ }
  function exportar() { /* ...código idêntico ao anterior... */ }
  
  // Cole as funções renderReport e exportar da resposta anterior aqui para completar.
  // (Omitido para brevidade, mas elas são necessárias)
</script>
</body>
</html>
