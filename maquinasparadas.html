<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Controle de Máquinas Paradas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background-color: #1e1e2f; color: white; display: flex; flex-direction: column; height: 100vh; }
    header { background-color: #2c2f3f; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2 ); display: flex; align-items: center; justify-content: space-between; }
    .logo { height: 80px; margin-left: 45px; margin-right: 15px; }
    .header-center { flex: 1; text-align: center; font-size: 20px; font-weight: bold; color: #ffffff; letter-spacing: 1px; }
    #dynamic-title { margin-top: 10px; font-size: 16px; font-weight: normal; color: #ccc; font-style: italic; }
    .btn-voltar { background: linear-gradient(135deg, #00205b, #009bd6); border: none; padding: 10px 16px; border-radius: 8px; color: white; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; gap: 8px; margin-right: 20px; font-size: 14px; }
    .btn-voltar:hover { transform: scale(1.05); }
    .main { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 250px; background-color: #2c2f3f; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
    .card { padding: 20px; border-radius: 16px; color: white; background: linear-gradient(145deg, #3a3d5e, #2c2f4f); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); text-align: left; display: flex; flex-direction: column; gap: 5px; }
    .card h2 { font-size: 28px; margin: 0; }
    .card p { font-size: 14px; color: #ccc; margin: 0; display: flex; align-items: center; gap: 8px; }
    .content { flex: 1; padding: 30px; background-color: #262a3d; overflow-y: auto; }
    .filters-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; }
    .filters input, .filters select { padding: 8px; border-radius: 6px; border: none; min-width: 180px; height: 40px; background-color: #fff; color: #333; }
    .filters input::placeholder { color: #888; }
    .acoes-topo { margin-left: auto; display: flex; gap: 10px; }
    .btn-acao-topo { background: linear-gradient(135deg, #00205b, #009bd6); border: none; width: 40px; height: 40px; border-radius: 8px; color: white; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
    .btn-acao-topo:hover { transform: scale(1.05); }
    table { width: 100%; border-collapse: collapse; background-color: #2c2f3f; border-radius: 12px; overflow: hidden; }
    th, td { font-size: 12px; padding: 12px 15px; text-align: left; border-bottom: 1px solid #444; }
    th { background-color: #ffffff; color: #00205b; }
    .acoes-botoes { display: flex; gap: 8px; }
    .btn-acao { border: none; padding: 8px 12px; border-radius: 6px; color: white; font-size: 14px; cursor: pointer; transition: transform 0.2s, background-color 0.2s; }
    .btn-acao:hover { transform: scale(1.05); }
    .btn-concluir { background: #1e8a4a; }
    .btn-concluir:hover { background: #25a25a; }
    .btn-cancelar { background: #c72c41; }
    .btn-cancelar:hover { background: #e0445a; }
    .popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
    .popup-content { background: #2c2f3f; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .popup-content h3 { margin-top: 0; }
    .popup-content label { display: block; margin-bottom: 8px; font-size: 14px; }
    .popup-content input, .popup-content textarea, .popup-content select { width: 100%; padding: 10px; border-radius: 6px; border: none; margin-bottom: 15px; }
    .popup-content textarea { min-height: 80px; resize: vertical; }
    .popup-buttons { text-align: right; display: flex; gap: 10px; justify-content: flex-end; }
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: #1e1e2f; }
    ::-webkit-scrollbar-thumb { background: #009bd6; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #00bfff; }
    * { scrollbar-width: thin; scrollbar-color: #009bd6 #1e1e2f; }

    /* --- CORES PADRONIZADAS --- */
    .status-parada { background-color: #c67903; } /* Laranja para "Em Andamento" */
    .status-concluida { background-color: #193b7c; } /* Azul escuro para "Concluído" */
    .status-cancelada { background-color: #626262; } /* Cinza para "Cancelado" */

    .linha-alerta {
      animation: pulsarAlerta 1.2s ease-in-out infinite alternate;
    }

    @keyframes pulsarAlerta {
      from { background-color: #950000; } /* Vermelho escuro */
      to { background-color: #c67903; } /* Laranja (mesma cor do em andamento) */
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="Logo" class="logo">
    <div class="header-center">
        <em>Controle de Máquinas Paradas</em>
        <div id="dynamic-title">Carregando...</div>
    </div>
    <button class="btn-voltar" title="Voltar" onclick="window.history.back()">
        <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i> Voltar
    </button>
  </header>

  <div class="main">
    <div class="sidebar">
        <div class="card">
          <h2 id="card-total-aberto">0</h2>
          <p><i data-lucide="alert-circle"></i> Total em Aberto</p>
        </div>
        <div class="card">
          <h2 id="card-mes-aberto">0</h2>
          <p><i data-lucide="calendar-plus"></i> Abertas no Mês</p>
        </div>
        <div class="card">
          <h2 id="card-mes-fechado">0</h2>
          <p><i data-lucide="calendar-check"></i> Fechadas no Mês</p>
        </div>
        <div class="card">
          <h2 id="card-concluido-30d">0</h2>
          <p><i data-lucide="check-circle"></i> Concluído (30 dias)</p>
        </div>
    </div>

    <div class="content">
        <div class="filters-container">
            <div class="filters">
                <input id="filtro-cliente" type="text" placeholder="Buscar por cliente ou chassi..." />
                <input id="filtro-tecnico" type="text" placeholder="Buscar por técnico..." />
                <select id="filtro-status">
                    <option value="">Todos os Status</option>
                    <option value="parada">Em Andamento</option>
                    <option value="concluida">Concluído</option>
                    <option value="cancelada">Cancelado</option>
                </select>
                <input id="filtro-periodo" placeholder="Selecione o período" />
            </div>
            <div class="acoes-topo">
                <button class="btn-acao-topo" title="Adicionar Máquina" onclick="abrirPopup('popup-adicionar')">
                    <i data-lucide="plus"></i>
                </button>
            </div>
        </div>

      <table>
        <thead>
          <tr>
            <th>Data Parada</th>
            <th>Cliente</th>
            <th>Chassis</th>
            <th>Modelo</th>
            <th>Horas</th>
            <th>OS</th>
            <th>Técnico Responsável</th>
            <th>Máquina Parada Por</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabela-maquinas">
          <!-- Linhas serão inseridas aqui via Firebase -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- POPUPS -->
  <div id="popup-adicionar" class="popup">
    <div class="popup-content">
        <h3>Adicionar Nova Máquina Parada</h3>
        <label>Data da Parada</label>
        <input type="date" id="novo-dataParada">
        <label>Cliente</label>
        <input type="text" id="novo-cliente" placeholder="Nome do cliente ou fazenda">
        <label>Chassis</label>
        <input type="text" id="novo-chassis" placeholder="Ex: BRJ012345">
        <label>Modelo</label>
        <input type="text" id="novo-modelo" placeholder="Ex: Trator 8R">
        <label>Horas</label>
        <input type="number" id="novo-horas" placeholder="Horas de funcionamento da máquina">
        <label>OS (Ordem de Serviço)</label>
        <input type="text" id="novo-os" placeholder="Número da OS">
        <label>Técnico Responsável</label>
        <input type="text" id="novo-tecnico" placeholder="Nome do técnico">
        <label>Máquina Parada Por</label>
        <select id="novo-motivo">
            <option value="" disabled selected>Selecione o motivo...</option>
            <option value="THD">THD</option>
            <option value="APROVAÇÃO DO SEGURO">APROVAÇÃO DO SEGURO</option>
            <option value="PEÇAS">PEÇAS</option>
            <option value="SEGURO">SEGURO</option>
            <option value="APROVAÇÃO DO CLIENTE">APROVAÇÃO DO CLIENTE</option>
            <option value="FERRAMENTAS">FERRAMENTAS</option>
            <option value="SERVIÇO DE TERCEIRO">SERVIÇO DE TERCEIRO</option>
            <option value="GARANTIA DE TERCEIRO">GARANTIA DE TERCEIRO</option>
            <option value="INDISPONIBILIDADE DE TECNICO">INDISPONIBILIDADE DE TECNICO</option>
        </select>
        <div class="popup-buttons">
            <button class="btn-acao" onclick="fecharPopup('popup-adicionar')">Cancelar</button>
            <button class="btn-acao btn-concluir" onclick="salvarNovaMaquina()">Salvar</button>
        </div>
    </div>
  </div>
  <div id="popup-concluir" class="popup">
    <div class="popup-content">
      <h3>Concluir Atendimento</h3>
      <input type="hidden" id="maquina-id-concluir">
      <label for="data-resolucao">Data que foi resolvido:</label>
      <input type="date" id="data-resolucao">
      <div class="popup-buttons">
        <button class="btn-acao" onclick="fecharPopup('popup-concluir')">Cancelar</button>
        <button class="btn-acao btn-concluir" onclick="salvarConclusao()">Salvar</button>
      </div>
    </div>
  </div>
  <div id="popup-cancelar" class="popup">
    <div class="popup-content">
      <h3>Cancelar Atendimento</h3>
      <input type="hidden" id="maquina-id-cancelar">
      <label for="motivo-cancelamento">Motivo do Cancelamento:</label>
      <textarea id="motivo-cancelamento" placeholder="Descreva por que o serviço não foi realizado..."></textarea>
      <div class="popup-buttons">
        <button class="btn-acao" onclick="fecharPopup('popup-cancelar')">Fechar</button>
        <button class="btn-acao btn-cancelar" onclick="salvarCancelamento()">Salvar Cancelamento</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDcjPa9jXsCCu6lNc1fjVg4Bzz1toKWAGY",
    authDomain: "agro-divel.firebaseapp.com",
    projectId: "agro-divel"
  };

  const app = initializeApp(firebaseConfig );
  const db = getFirestore(app);
  const maquinasCollection = collection(db, "maquinasParadas");

  let dadosMaquinas = [];

  async function getFiliaisDoGestor() {
      let filiais = JSON.parse(localStorage.getItem("gestorFilial") || "[]");
      if (filiais.length > 0) return filiais;

      const emailGestor = localStorage.getItem("gestorEmail");
      if (!emailGestor) {
          console.warn("E-mail do gestor não encontrado no localStorage.");
          return [];
      }

      const gestoresRef = collection(db, "gestores");
      const q = query(gestoresRef, where("email", "==", emailGestor));
      
      try {
        const snapshot = await getDocs(q);
        if (!snapshot.empty) {
            const dadosGestor = snapshot.docs[0].data();
            filiais = dadosGestor.filial || [];
            localStorage.setItem("gestorFilial", JSON.stringify(filiais));
            return filiais;
        } else {
            console.warn("Gestor com e-mail " + emailGestor + " não encontrado no banco de dados.");
            return [];
        }
      } catch (error) {
          console.error("Erro ao buscar gestor:", error);
          return [];
      }
  }

  async function carregarDados() {
    const filiaisLogadas = await getFiliaisDoGestor();

    if (filiaisLogadas.length === 0) {
        document.getElementById("dynamic-title").textContent = "Nenhuma filial encontrada";
        document.getElementById("tabela-maquinas").innerHTML = '<tr><td colspan="9" style="text-align:center;">Nenhuma filial de gestor foi encontrada. Faça login novamente.</td></tr>';
        return;
    }
    document.getElementById("dynamic-title").textContent = `Filial: ${filiaisLogadas.join(", ")}`;

    const q = query(maquinasCollection, where("filial", "in", filiaisLogadas));
    
    try {
        const snapshot = await getDocs(q);
        dadosMaquinas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        aplicarFiltros();
    } catch (error) {
        console.error("Erro ao carregar dados do Firebase:", error);
        alert("Não foi possível carregar os dados. Verifique o console para mais detalhes.");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    lucide.createIcons();
    
    flatpickr("#filtro-periodo", {
        mode: "range",
        dateFormat: "Y-m-d",
        locale: "pt",
        onChange: () => aplicarFiltros()
    });

    document.getElementById('filtro-cliente').addEventListener('input', aplicarFiltros);
    document.getElementById('filtro-status').addEventListener('change', aplicarFiltros); // Adicionado filtro de status
    document.getElementById('filtro-tecnico').addEventListener('input', aplicarFiltros);

    carregarDados();
  });

  function aplicarFiltros() {
    const filtroCliente = document.getElementById('filtro-cliente').value.toLowerCase();
    const filtroStatus = document.getElementById('filtro-status').value; // Novo filtro
    const filtroTecnico = document.getElementById('filtro-tecnico').value.toLowerCase();
    const filtroPeriodo = document.getElementById('filtro-periodo')._flatpickr.selectedDates;

    const dadosFiltrados = dadosMaquinas.filter(dado => {
        const buscaCliente = (dado.cliente || "").toLowerCase().includes(filtroCliente) || (dado.chassis || "").toLowerCase().includes(filtroCliente);
        const buscaStatus = !filtroStatus || dado.status === filtroStatus; // Lógica do filtro de status
        const buscaTecnico = !filtroTecnico || (dado.tecnico || "").toLowerCase().includes(filtroTecnico);
        
        let buscaPeriodo = true;
        if (filtroPeriodo.length === 2) {
            const dataParada = new Date(dado.dataParada + "T00:00:00");
            buscaPeriodo = dataParada >= filtroPeriodo[0] && dataParada <= filtroPeriodo[1];
        }

        return buscaCliente && buscaStatus && buscaTecnico && buscaPeriodo;
    });

    renderizarTabela(dadosFiltrados);
    atualizarCards(dadosFiltrados);
  }

  function renderizarTabela(dados) {
    const tabela = document.getElementById('tabela-maquinas');
    tabela.innerHTML = '';

    dados.sort((a, b) => {
        const statusOrder = { 'parada': 1, 'concluida': 2, 'cancelada': 3 };
        const aIsAlert = isOverdue(a.dataParada) && a.status === 'parada';
        const bIsAlert = isOverdue(b.dataParada) && b.status === 'parada';

        if (aIsAlert && !bIsAlert) return -1;
        if (!aIsAlert && bIsAlert) return 1;
        
        const statusDiff = (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
        if (statusDiff !== 0) return statusDiff;

        return new Date(b.dataParada) - new Date(a.dataParada);
    });

    if (dados.length === 0) {
        tabela.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nenhum registro encontrado para os filtros aplicados.</td></tr>';
        return;
    }

    dados.forEach(dado => {
        let classesLinha = `status-${dado.status}`; // Aplica a cor baseada no status
        if (dado.status === 'parada' && isOverdue(dado.dataParada)) {
            classesLinha += ' linha-alerta'; // Adiciona o alerta se estiver em andamento e atrasado
        }

        const linha = `
            <tr id="maquina-${dado.id}" class="${classesLinha}">
                <td>${formatarData(dado.dataParada)}</td>
                <td>${dado.cliente || '-'}</td>
                <td>${dado.chassis || '-'}</td>
                <td>${dado.modelo || '-'}</td>
                <td>${dado.horas || '-'}</td>
                <td>${dado.os || '-'}</td>
                <td>${dado.tecnico || '-'}</td>
                <td>${dado.motivo || '-'}</td>
                <td>
                    <div class="acoes-botoes">
                        ${dado.status === 'parada' ? `
                            <button class="btn-acao btn-concluir" onclick="abrirPopup('popup-concluir', '${dado.id}')">Concluir</button>
                            <button class="btn-acao btn-cancelar" onclick="abrirPopup('popup-cancelar', '${dado.id}')">Cancelar</button>
                        ` : `<span>${dado.status.charAt(0).toUpperCase() + dado.status.slice(1)}</span>`}
                    </div>
                </td>
            </tr>
        `;
        tabela.innerHTML += linha;
    });
  }

  function isOverdue(dataParadaStr) {
      if (!dataParadaStr) return false;
      const cincoDiasEmMs = 5 * 24 * 60 * 60 * 1000;
      const dataParada = new Date(dataParadaStr + "T00:00:00");
      const hoje = new Date();
      return (hoje - dataParada) > cincoDiasEmMs;
  }
  
  function atualizarCards(dadosParaCalculo) {
      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const anoAtual = hoje.getFullYear();
      const trintaDiasAtras = new Date(hoje - 30 * 24 * 60 * 60 * 1000);

      const totalAberto = dadosParaCalculo.filter(d => d.status === 'parada').length;
      
      const abertasNoMes = dadosParaCalculo.filter(d => {
          if (d.status !== 'parada') return false;
          const dataAbertura = new Date((d.dataParada || "1970-01-01") + 'T12:00:00');
          return dataAbertura.getMonth() === mesAtual && dataAbertura.getFullYear() === anoAtual;
      }).length;

      const fechadasNoMes = dadosMaquinas.filter(d => {
          if (!d.dataFinal) return false;
          const dataFechamento = new Date(d.dataFinal + 'T12:00:00');
          return (d.status === 'concluida' || d.status === 'cancelada') &&
                 dataFechamento.getMonth() === mesAtual &&
                 dataFechamento.getFullYear() === anoAtual;
      }).length;

      const concluidas30d = dadosMaquinas.filter(d => {
          if (!d.dataFinal) return false;
          const dataFechamento = new Date(d.dataFinal + 'T12:00:00');
          return d.status === 'concluida' && dataFechamento >= trintaDiasAtras;
      }).length;
      
      document.getElementById('card-total-aberto').textContent = totalAberto;
      document.getElementById('card-mes-aberto').textContent = abertasNoMes;
      document.getElementById('card-mes-fechado').textContent = fechadasNoMes;
      document.getElementById('card-concluido-30d').textContent = concluidas30d;
  }

  function formatarData(dataString) {
    if (!dataString) return '-';
    const partes = dataString.split('-');
    if (partes.length !== 3) return dataString;
    return `${partes[2]}/${partes[1]}/${partes[0]}`;
  }

  window.abrirPopup = (popupId, maquinaId) => {
    if (maquinaId) {
        document.getElementById(`maquina-id-${popupId.split('-')[1]}`).value = maquinaId;
    }
    document.getElementById(popupId).style.display = 'flex';
  }

  window.fecharPopup = (popupId) => {
    document.getElementById(popupId).style.display = 'none';
    if (popupId === 'popup-adicionar') {
        document.getElementById('novo-dataParada').value = '';
        document.getElementById('novo-cliente').value = '';
        document.getElementById('novo-chassis').value = '';
        document.getElementById('novo-modelo').value = '';
        document.getElementById('novo-horas').value = '';
        document.getElementById('novo-os').value = '';
        document.getElementById('novo-tecnico').value = '';
        document.getElementById('novo-motivo').value = '';
    }
  }

  window.salvarNovaMaquina = async () => {
    const dataParada = document.getElementById('novo-dataParada').value;
    const cliente = document.getElementById('novo-cliente').value;
    const chassis = document.getElementById('novo-chassis').value;
    const motivo = document.getElementById('novo-motivo').value;

    if (!dataParada || !cliente || !chassis || !motivo) {
        alert('Por favor, preencha os campos obrigatórios: Data, Cliente, Chassis e Motivo.');
        return;
    }

    const filiaisLogadas = await getFiliaisDoGestor();
    if (filiaisLogadas.length === 0) {
        alert("Não foi possível identificar a filial do gestor. O registro não pode ser salvo.");
        return;
    }

    const novaMaquina = {
        dataParada,
        cliente,
        chassis,
        modelo: document.getElementById('novo-modelo').value,
        horas: parseInt(document.getElementById('novo-horas').value) || 0,
        os: document.getElementById('novo-os').value,
        tecnico: document.getElementById('novo-tecnico').value,
        motivo,
        status: 'parada',
        filial: filiaisLogadas[0]
    };

    try {
        await addDoc(maquinasCollection, novaMaquina);
        fecharPopup('popup-adicionar');
        carregarDados();
    } catch (error) {
        console.error("Erro ao salvar nova máquina:", error);
        alert("Não foi possível salvar o registro.");
    }
  }

  window.salvarConclusao = async () => {
    const id = document.getElementById('maquina-id-concluir').value;
    const dataResolucao = document.getElementById('data-resolucao').value;

    if (!dataResolucao) {
      alert('Por favor, preencha a data de resolução.');
      return;
    }
    
    const docRef = doc(db, "maquinasParadas", id);
    try {
        await updateDoc(docRef, {
            status: 'concluida',
            dataFinal: dataResolucao
        });
        fecharPopup('popup-concluir');
        carregarDados();
    } catch (error) {
        console.error("Erro ao concluir atendimento:", error);
        alert("Não foi possível atualizar o registro.");
    }
  }

  window.salvarCancelamento = async () => {
    const id = document.getElementById('maquina-id-cancelar').value;
    const motivo = document.getElementById('motivo-cancelamento').value;

    if (!motivo.trim()) {
        alert('Por favor, descreva o motivo do cancelamento.');
        return;
    }

    const paraISO = (data) => data.toISOString().split('T')[0];
    const docRef = doc(db, "maquinasParadas", id);
    try {
        await updateDoc(docRef, {
            status: 'cancelada',
            motivoCancelamento: motivo,
            dataFinal: paraISO(new Date())
        });
        fecharPopup('popup-cancelar');
        carregarDados();
    } catch (error) {
        console.error("Erro ao cancelar atendimento:", error);
        alert("Não foi possível atualizar o registro.");
    }
  }
</script>

</body>
</html>
