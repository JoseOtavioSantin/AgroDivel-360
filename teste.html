<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#2c2f3f" />
  <title>Dashboard com Filtros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <style>
    body { background-color: #1e1e2f; color: white; font-family: Arial, sans-serif; margin: 0; }
    header { background: #2c2f3f; padding: 20px; text-align: center; color: white; font-size: 20px; font-weight: bold; }
    .logo { height: 50px; }
    .main { display: flex; }
    .sidebar { width: 250px; background: #2c2f3f; padding: 20px; }
    .content { flex: 1; padding: 20px; background: #262a3d; }
    .card { background: #3a3a5d; padding: 10px; border-radius: 12px; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; background: #2c2f3f; color: white; border-radius: 8px; overflow: hidden; }
    th, td { padding: 10px; border-bottom: 1px solid #444; font-size: 12px; }
    th { background: #fff; color: #00205b; }
    .filters input, .filters select { padding: 6px; border-radius: 6px; margin-right: 10px; }
    .btn-acao { padding: 6px 10px; border-radius: 6px; background: #009bd6; color: white; border: none; cursor: pointer; }
    .status-concluido { background-color: #193b7c; }
    .status-cancelado { background-color: #626262; }
    .status-em-andamento { background-color: #c67903; }
  </style>
</head>
<body>
<header>
  <img src="assets/logo.png" class="logo" alt="Logo">
  <div>Dashboard Agro Divel 360</div>
  <div id="dynamic-title">Carregando...</div>
</header>
<div class="main">
  <div class="sidebar">
    <div class="card" id="total-clientes">Total Clientes: 0</div>
    <div class="card" id="total-concluidos">Concluídos: 0</div>
    <div class="card" id="cancelados">Cancelados: 0</div>
    <div class="card" id="valor-total">Valor Total (R$): R$ 0,00</div>
  </div>
  <div class="content">
    <div class="filters">
      <input id="filtro-cliente" placeholder="Buscar cliente...">
      <input id="filtro-consultor" placeholder="Buscar consultor...">
      <input id="filtro-municipio" placeholder="Buscar municipio...">
      <select id="filtro-status">
        <option value="">Todos os status</option>
        <option value="Concluído">Concluído</option>
        <option value="Em andamento">Em andamento</option>
        <option value="Cancelado">Cancelado</option>
      </select>
      <input id="filtro-periodo" placeholder="Selecione o período">
      <button id="btn-exportar" class="btn-acao">Exportar Excel</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Data da Visita</th><th>Cliente</th><th>Município</th><th>Consultor</th><th>Modelo</th><th>Horímetro</th><th>Troca</th><th>Telefone</th><th>Observações</th><th>Checklist</th><th>Ações</th>
        </tr>
      </thead>
      <tbody id="painel-detalhes"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const tipoChecklist = new URLSearchParams(window.location.search).get("tipo") || "checklistComercial";
const app = initializeApp({
  apiKey: "AIzaSyDcjPa9jXsCCu6lNc1fjVg4Bzz1toKWAGY",
  authDomain: "agro-divel.firebaseapp.com",
  projectId: "agro-divel"
});
const db = getFirestore(app);
let dadosTotais = [];

document.getElementById("dynamic-title").textContent =
  tipoChecklist === "checklistComercial" ? "Comercial" :
  tipoChecklist === "checklistRevisao" ? "Revisão" :
  tipoChecklist === "checklistPecas" ? "Peças" : "Painel";

async function carregarFiliaisDoGestor() {
  const emailGestor = localStorage.getItem("gestorEmail") || "";
  if (!emailGestor) return;

  const gestoresRef = collection(db, "gestores");
  const q = query(gestoresRef, where("email", "==", emailGestor));
  const snapshot = await getDocs(q);

  if (!snapshot.empty) {
    const dados = snapshot.docs[0].data();
    const filiais = dados.filial || [];
    localStorage.setItem("gestorFilial", JSON.stringify(filiais));
    document.getElementById("dynamic-title").textContent = `Filiais: ${filiais.join(", ")}`;
    carregarDados();
  } else {
    alert("Gestor não encontrado no banco.");
  }
}

async function carregarDados() {
  const querySnapshot = await getDocs(collection(db, tipoChecklist));
  dadosTotais = [];
  const filiaisLogadas = JSON.parse(localStorage.getItem("gestorFilial") || "[]");

  querySnapshot.forEach(docItem => {
    const dados = docItem.data();
    if (filiaisLogadas.map(f => f.toLowerCase().trim()).includes((dados.filial || "").toLowerCase().trim())) {
      dadosTotais.push({ id: docItem.id, ...dados });
    }
  });
  aplicarFiltros();
}

function aplicarFiltros() {
  const clienteFiltro = document.getElementById("filtro-cliente").value.toLowerCase();
  const statusFiltro = document.getElementById("filtro-status").value;
  const consultorFiltro = document.getElementById("filtro-consultor").value.toLowerCase();
  const periodo = document.getElementById("filtro-periodo")._flatpickr.selectedDates;

  let dataInicio = "", dataFim = "";
  if (periodo.length === 2) {
    dataInicio = periodo[0].toISOString().slice(0, 10);
    dataFim = periodo[1].toISOString().slice(0, 10);
  } else if (periodo.length === 1) {
    dataInicio = dataFim = periodo[0].toISOString().slice(0, 10);
  }

  const painel = document.getElementById("painel-detalhes");
  painel.innerHTML = "";

  const filtrados = dadosTotais.filter(d => {
    const cliente = (d.nomeCliente || "").toLowerCase();
    const status = d.statusChecklist || "";
    const consultor = (d.consultor || "").toLowerCase();
    const dataVisita = d.dataVisita || "";
    const dentroDoPeriodo = (!dataInicio && !dataFim) || (dataVisita >= dataInicio && dataVisita <= dataFim);
    return cliente.includes(clienteFiltro) &&
           (statusFiltro === "" || status === statusFiltro) &&
           consultor.includes(consultorFiltro) &&
           dentroDoPeriodo;
  });

  let totalValor = 0;
  filtrados.forEach(d => {
    if (!isNaN(d.valorNegociado)) totalValor += Number(d.valorNegociado);
    const statusClass = d.statusChecklist === "Concluído" ? "status-concluido" :
                        d.statusChecklist === "Cancelado" ? "status-cancelado" :
                        d.statusChecklist === "Em andamento" ? "status-em-andamento" : "";

    painel.innerHTML += `
      <tr class="${statusClass}">
        <td>${d.dataVisita || "-"}</td>
        <td>${d.nomeCliente || "-"}</td>
        <td>${d.municipio || "-"}</td>
        <td>${d.consultor || "-"}</td>
        <td>${d.modelo || "-"}</td>
        <td>${d.horimetro || "-"}</td>
        <td>${d.modeloTrator || "-"}</td>
        <td>${d.telefone || "-"}</td>
        <td data-comentario="${d.comentarioResponsavel || ''}" data-valor="${d.valorNegociado || 0}">${d.observacoes || "-"}</td>
        <td>${(d.checklist || []).join(", ")}</td>
        <td><button class="btn-acao" data-id="${d.id}">+</button></td>
      </tr>`;
  });

  document.getElementById("total-clientes").textContent = `Total Clientes: ${filtrados.length}`;
  document.getElementById("total-concluidos").textContent = `Concluídos: ${filtrados.filter(d => d.statusChecklist === "Concluído").length}`;
  document.getElementById("cancelados").textContent = `Cancelados: ${filtrados.filter(d => d.statusChecklist === "Cancelado").length}`;
  document.getElementById("valor-total").textContent = `Valor Total (R$): R$ ${totalValor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
}

window.aplicarFiltros = aplicarFiltros;

flatpickr("#filtro-periodo", {
  mode: "range",
  dateFormat: "Y-m-d",
  locale: "pt",
  onChange: aplicarFiltros
});

document.getElementById("filtro-cliente").addEventListener("input", aplicarFiltros);
document.getElementById("filtro-status").addEventListener("change", aplicarFiltros);
document.getElementById("filtro-consultor").addEventListener("input", aplicarFiltros);
document.getElementById("filtro-municipio")?.addEventListener("input", aplicarFiltros);

carregarFiliaisDoGestor();
</script>

<script>
document.getElementById("btn-exportar").addEventListener("click", () => {
  const headers = [
    "Data da Visita", "Cliente", "Município", "Consultor",
    "Modelo", "Horímetro", "Troca", "Telefone",
    "Observações", "Checklist", "Comentário", "Valor (R$)", "Status"
  ];
  const linhas = Array.from(document.querySelectorAll("#painel-detalhes tr")).map(tr => {
    const tds = tr.querySelectorAll("td");
    return [
      tds[0]?.textContent.trim(), tds[1]?.textContent.trim(), tds[2]?.textContent.trim(),
      tds[3]?.textContent.trim(), tds[4]?.textContent.trim(), tds[5]?.textContent.trim(),
      tds[6]?.textContent.trim(), tds[7]?.textContent.trim(), tds[8]?.textContent.trim(),
      tds[9]?.textContent.trim(), tds[8]?.getAttribute("data-comentario") || "",
      tds[8]?.getAttribute("data-valor") || "",
      tr.classList.contains("status-concluido") ? "Concluído" :
      tr.classList.contains("status-cancelado") ? "Cancelado" :
      tr.classList.contains("status-em-andamento") ? "Em andamento" : ""
    ];
  });
  const planilha = XLSX.utils.aoa_to_sheet([headers, ...linhas]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, planilha, "Checklist");
  XLSX.writeFile(wb, "checklists_filtrados.xlsx");
});
</script>

<script>
if (localStorage.getItem("gestorLogado") !== "true") {
  alert("Acesso restrito! Faça login como gestor.");
  window.location.href = "index.html";
}
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>
