<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de KPIs - Agro Divel 360</title>
    <link rel="icon" type="image/png" href="/assets/images/iconeaba.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c2f3f" />

    <!-- LIBS EXTERNAS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/Pages/Formularios/style-forms.css">

    <style>
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }
        .spaced-card { margin-top: 40px; }
        .textarea-lg { min-height: 80px; resize: vertical; }

        .error-container { padding: 20px; background-color: #ffdddd; border: 1px solid #ff0000; color: #D8000C; border-radius: 8px; }
        .field-error { color: #c62828; font-size: 13px; margin-top: 6px; display: none; }
        .field-error.visible { display: block; }
        .sr-only { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
        
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .badge-critico { background: #ffebee; color: #c62828; }
        .badge-alto { background: #fff3e0; color: #e65100; }
        .badge-medio { background: #fff9c4; color: #f57f17; }
        .badge-baixo { background: #e8f5e9; color: #2e7d32; }
        
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        thead { background: #f8f9fa; border-bottom: 2px solid #ddd; }
        th { padding: 15px; text-align: left; font-weight: 600; color: #333; font-size: 13px; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #eee; color: #666; }
        tr:hover { background: #f8f9fa; }
        
        .btn-action { padding: 6px 12px; border: 1px solid #ccc; background: #f0f0f0; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; margin-right: 5px; }
        .btn-action:hover { background-color: #e0e0e0; }
        .btn-delete { color: #c62828; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
    </style>
</head>
<body>

    <nav id="sidebar-placeholder"></nav>

    <section class="home">
        <div class="text">
            <h1 id="form-title">Novo KPI</h1>
            <p id="form-subtitle">Preencha os dados abaixo para cadastrar um novo KPI.</p>
        </div>

        <div class="content-card">
            <div class="content-card-body">
                <form id="form-kpi">
                    <div class="form-grid">
                        <div class="form-group"><label for="kpi-nome">Nome do KPI *</label><input type="text" id="kpi-nome" required placeholder="Ex: Taxa de Conversão de Venda"></div>
                        <div class="form-group"><label for="kpi-responsavel">Responsável</label><input type="text" id="kpi-responsavel" readonly placeholder="Preenchido automaticamente"></div>
                        <div class="form-group"><label for="kpi-meta">Meta (Valor Alvo) *</label><input type="number" id="kpi-meta" required step="0.01" placeholder="0.00"></div>
                        <div class="form-group"><label for="kpi-unidade">Unidade *</label><select id="kpi-unidade" required><option value="">Selecione uma unidade</option><option value="%">Percentual (%)</option><option value="Quantidade">Quantidade</option><option value="R$">Valor (R$)</option><option value="Dias">Dias</option><option value="Horas">Horas</option><option value="Unidades">Unidades</option></select></div>
                        <div class="form-group full-width"><label for="kpi-descricao">Descrição da Meta *</label><textarea id="kpi-descricao" class="textarea-lg" required placeholder="Ex: Aumentar a conversão para 85%" aria-describedby="kpi-descricao-error"></textarea>
                            <div id="kpi-descricao-error" class="field-error" aria-live="polite"></div>
                        </div>
                        <div class="form-group"><label for="kpi-dataInicio">Data Início *</label><input type="date" id="kpi-dataInicio" required></div>
                        <div class="form-group"><label for="kpi-dataFim">Data Fim *</label><input type="date" id="kpi-dataFim" required></div>
                    </div>
                    
                    <div class="form-actions">
                        <a href="/Pages/PlanodeAcao/GerenciarPlanosAcao.html" class="btn-secondary">Cancelar</a>
                        <button type="submit" class="btn-primary" id="btn-salvar"><i data-lucide="save"></i> Salvar KPI</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TABELA DE KPIs -->
        <div class="content-card spaced-card">
            <div class="content-card-body">
                <h2>KPIs Cadastrados</h2>
                <div id="kpis-container">
                    <div id="emptyMessage" class="empty-state" aria-live="polite" style="display: none;">
                        <i class='bx bx-inbox'></i>
                        <p>Nenhum KPI cadastrado ainda</p>
                    </div>
                    <table id="kpis-table" role="table" aria-label="Tabela de KPIs" style="display: none;">
                        <thead>
                            <tr>
                                <th scope="col">Nome</th>
                                <th scope="col">Descrição</th>
                                <th scope="col">Meta</th>
                                <th scope="col">Responsável</th>
                                <th scope="col">Validade</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="kpis-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <script type="module">
        // Importações
        import { db, auth } from "/assets/js/firebase-config.js";
        import { collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { garantirAutenticacao } from '/assets/js/auth-guard.js';

        // --- VARIÁVEIS GLOBAIS ---
        let kpiEmEdicao = null;
        let todosKPIs = [];

        const form = document.getElementById('form-kpi');
        const btnSalvar = document.getElementById('btn-salvar');

        // helper: retorna yyyy-mm-dd da data local
        function todayISO() {
            const d = new Date();
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // retorna o nome do usuário usado pelo app (mesma fonte do menu)
        function getAppUserName() {
            // 1) prioridade para valor fornecido pelo app (localStorage)
            const fromStorage = localStorage.getItem('userName');
            if (fromStorage && fromStorage.trim()) return fromStorage.trim();

            // 2) tentar ler diretamente do DOM (Menu.html -> #user-name)
            const menuEl = document.getElementById('user-name');
            if (menuEl && menuEl.textContent && menuEl.textContent.trim()) return menuEl.textContent.trim();

            // 3) fallback para auth.currentUser (displayName ou email prefix)
            const u = auth.currentUser;
            if (u) return u.displayName || (u.email && u.email.split('@')[0]) || 'Usuário';

            return 'Usuário';
        }

        // --- FUNÇÕES PRINCIPAIS ---
        async function carregarKPIs() {
            try {
                const q = query(collection(db, 'kpis'), orderBy('dataCriacao', 'desc'));
                const snapshot = await getDocs(q);
                todosKPIs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarTabela();
            } catch (error) {
                console.error("Erro ao carregar KPIs:", error);
                Swal.fire('Erro!', 'Falha ao carregar KPIs', 'error');
            }
        }

        function renderizarTabela() {
            const tbody = document.getElementById('kpis-tbody');
            const table = document.getElementById('kpis-table');
            const empty = document.getElementById('emptyMessage');

            tbody.innerHTML = '';

            if (!Array.isArray(todosKPIs) || todosKPIs.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            const fmtDate = (d) => {
                if (!d) return '-';
                const dateObj = d.toDate ? d.toDate() : new Date(d);
                if (isNaN(dateObj)) return '-';
                return dateObj.toLocaleDateString('pt-BR');
            };

            const fmtMeta = (m, u) => {
                const n = Number(m);
                if (!isFinite(n)) return '-';
                return `${n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${u || ''}`.trim();
            };

            todosKPIs.forEach(kpi => {
                const dataInicio = fmtDate(kpi.dataInicio);
                const dataFim = fmtDate(kpi.dataFim);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${kpi.nome || '-'}</strong></td>
                    <td>${kpi.descricao || '-'}</td>
                    <td>${fmtMeta(kpi.meta, kpi.unidade)}</td>
                    <td>${kpi.responsavel || '-'}</td>
                    <td>${dataInicio} a ${dataFim}</td>
                    <td>
                        <button type="button" class="btn-action" aria-label="Editar ${kpi.nome || 'KPI'}" onclick="editarKPI('${kpi.id}')">Editar</button>
                        <button type="button" class="btn-action btn-delete" aria-label="Deletar ${kpi.nome || 'KPI'}" onclick="deletarKPI('${kpi.id}')">Deletar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.editarKPI = function(id) {
            const kpi = todosKPIs.find(k => k.id === id);
            if (!kpi) return;

            const toInputDate = (d) => {
                if (!d) return '';
                const dateObj = d.toDate ? d.toDate() : new Date(d);
                if (isNaN(dateObj)) return '';
                return dateObj.toISOString().slice(0,10);
            };

            document.getElementById('kpi-nome').value = kpi.nome || '';
            document.getElementById('kpi-meta').value = (kpi.meta != null) ? String(kpi.meta) : '';
            document.getElementById('kpi-unidade').value = kpi.unidade || '';
            document.getElementById('kpi-descricao').value = kpi.descricao || '';
            document.getElementById('kpi-dataInicio').value = toInputDate(kpi.dataInicio);
            document.getElementById('kpi-dataFim').value = toInputDate(kpi.dataFim);

            kpiEmEdicao = id;
            document.getElementById('form-title').textContent = 'Editar KPI';
            document.getElementById('form-subtitle').textContent = 'Altere os dados do KPI abaixo.';
            btnSalvar.innerHTML = '<i data-lucide="save"></i> Salvar Alterações';

            window.scrollTo({ top: 0, behavior: 'smooth' });
            lucide.createIcons();
        };

        window.deletarKPI = async function(id) {
            const result = await Swal.fire({
                title: 'Tem certeza?',
                text: 'Esta ação não pode ser desfeita',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#193b7c',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, deletar!',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                try {
                    await deleteDoc(doc(db, 'kpis', id));
                    Swal.fire('Deletado!', 'KPI removido com sucesso', 'success');
                    await carregarKPIs();
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    Swal.fire('Erro!', 'Falha ao deletar KPI', 'error');
                }
            }
        };

        // --- FORM SUBMIT ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // limpa erros visuais
            document.querySelectorAll('.field-error').forEach(el => el.classList.remove('visible'));

            const originalHtml = btnSalvar.innerHTML;
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i data-lucide="loader-2" class="spin"></i> Salvando...';
            lucide.createIcons();

            try {
                // coleta e valida
                const nome = document.getElementById('kpi-nome').value.trim();
                const metaRaw = document.getElementById('kpi-meta').value;
                const meta = Number(metaRaw);
                const unidade = document.getElementById('kpi-unidade').value;
                const descricao = document.getElementById('kpi-descricao').value.trim();
                const responsavel = document.getElementById('kpi-responsavel').value;
                const dataInicioRaw = document.getElementById('kpi-dataInicio').value;
                const dataFimRaw = document.getElementById('kpi-dataFim').value;

                // validações básicas
                if (!nome) throw new Error('Preencha o nome do KPI.');
                if (!isFinite(meta)) {
                    const el = document.getElementById('kpi-meta');
                    document.getElementById('kpi-meta').focus();
                    throw new Error('Informe uma meta numérica válida.');
                }

                if (dataInicioRaw && dataFimRaw) {
                    const d1 = new Date(dataInicioRaw);
                    const d2 = new Date(dataFimRaw);
                    if (isNaN(d1) || isNaN(d2)) throw new Error('Datas inválidas.');
                    if (d2 < d1) {
                        const err = document.getElementById('kpi-dataFim');
                        err.focus();
                        throw new Error('A data final deve ser igual ou posterior à data de início.');
                    }
                }

                const dados = {
                    nome,
                    meta,
                    unidade,
                    descricao,
                    responsavel,
                    // salvar como ISO (Firestore lida bem com strings ou Timestamp se desejar converter no backend)
                    dataInicio: dataInicioRaw || null,
                    dataFim: dataFimRaw || null
                };

                if (kpiEmEdicao) {
                    dados.dataAtualizacao = new Date();
                    await updateDoc(doc(db, 'kpis', kpiEmEdicao), dados);
                    Swal.fire('Sucesso!', 'KPI atualizado com sucesso!', 'success');
                } else {
                    dados.dataCriacao = new Date();
                    await addDoc(collection(db, 'kpis'), dados);
                    Swal.fire('Sucesso!', 'KPI cadastrado com sucesso!', 'success');
                }

                form.reset();
                kpiEmEdicao = null;
                // após reset, garantir data início como hoje e preencher responsável com o nome do app
                const _dataInicio = document.getElementById('kpi-dataInicio');
                if (_dataInicio) _dataInicio.value = todayISO();
                const _resp = document.getElementById('kpi-responsavel');
                if (_resp) _resp.value = getAppUserName();
                document.getElementById('form-title').textContent = 'Novo KPI';
                document.getElementById('form-subtitle').textContent = 'Preencha os dados abaixo para cadastrar um novo KPI.';
                btnSalvar.innerHTML = '<i data-lucide="save"></i> Salvar KPI';
                await carregarKPIs();

            } catch (error) {
                console.error('Erro ao salvar:', error);
                // mensagem amigável e acessível
                const msg = (error && error.message) ? error.message : 'Falha ao salvar';
                Swal.fire('Erro', msg, 'error');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = originalHtml;
                lucide.createIcons();
            }
        });

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await garantirAutenticacao(auth);
                
                // Preencher campo responsável com o mesmo nome exibido no menu (localStorage / #user-name / auth)
                const nomeApp = getAppUserName();
                const responsavelEl = document.getElementById('kpi-responsavel');
                if (responsavelEl && !responsavelEl.value) responsavelEl.value = nomeApp;

                // observar alterações no nome do menu e sincronizar (não sobrescreve se estiver em edição)
                const menuNameEl = document.getElementById('user-name');
                if (menuNameEl) {
                    const mo = new MutationObserver(() => {
                        if (kpiEmEdicao) return; // não sobrescrever durante edição
                        const novo = getAppUserName();
                        if (responsavelEl) responsavelEl.value = novo;
                    });
                    mo.observe(menuNameEl, { childList: true, characterData: true, subtree: true });
                }

                // definir data início padrão como hoje quando o campo estiver vazio
                const dataInicioEl = document.getElementById('kpi-dataInicio');
                if (dataInicioEl && !dataInicioEl.value) dataInicioEl.value = todayISO();

                await carregarKPIs();
                lucide.createIcons();
            } catch (error) {
                console.error('Erro na inicialização:', error);
                const homeSection = document.querySelector('.home');
                if (homeSection) {
                    homeSection.innerHTML = `<div class="error-container"><h1>Erro Crítico</h1><p>${error.message}</p></div>`;
                }
            }
        });

        function showToast(message, icon = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
            });
            Toast.fire({ icon, title: message });
        }
    </script>

    <!-- Scripts Globais -->
    <script type="module" src="/assets/js/auth.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/components/Sidebar.js"></script>
</body>
</html>
