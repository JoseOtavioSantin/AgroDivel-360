<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Plano de A√ß√£o - Agro Divel 360</title>
    <link rel="icon" type="image/png" href="/assets/images/iconeaba.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c2f3f" />

    <!-- LIBS EXTERNAS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/Pages/Formularios/style-forms.css">

    <style>
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .error-container { padding: 20px; background-color: #ffdddd; border: 1px solid #ff0000; color: #D8000C; border-radius: 8px; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } } .spin { animation: spin 1s linear infinite; }
        
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .badge-critico { background: #ffebee; color: #c62828; }
        .badge-alto { background: #fff3e0; color: #e65100; }
        .badge-medio { background: #fff9c4; color: #f57f17; }
        .badge-baixo { background: #e8f5e9; color: #2e7d32; }
        
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        thead { background: #f8f9fa; border-bottom: 2px solid #ddd; }
        th { padding: 15px; text-align: left; font-weight: 600; color: #333; font-size: 13px; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #eee; color: #666; }
        tr:hover { background: #f8f9fa; }
        
        .btn-action { padding: 6px 12px; border: 1px solid #ccc; background: #f0f0f0; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; margin-right: 5px; }
        .btn-action:hover { background-color: #e0e0e0; }
        .btn-delete { color: #c62828; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
    </style>
</head>
<body>

    <nav id="sidebar-placeholder"></nav>

    <section class="home">
        <div class="text">
            <h1 id="form-title">Novo Plano de A√ß√£o</h1>
            <p id="form-subtitle">Preencha os dados abaixo para criar um novo plano de a√ß√£o.</p>
        </div>

        <div class="content-card">
            <div class="content-card-body">
                <form id="form-plano-acao">
                    <div class="form-grid">
                        <div class="form-group"><label for="plano-nome">Nome do Plano de A√ß√£o *</label><input type="text" id="plano-nome" required placeholder="Ex: Plano Q1 2026"></div>
                        <div class="form-group"><label for="plano-responsavel">Respons√°vel</label><input type="text" id="plano-responsavel" readonly placeholder="Preenchido automaticamente"></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label for="plano-kpi">KPI Associado *</label><select id="plano-kpi" required><option value="">Selecione um KPI</option></select></div>
                        <div class="form-group"><label for="plano-meta">Meta *</label><input type="text" id="plano-meta" readonly placeholder="Preenchida automaticamente"></div>
                        <div class="form-group"><label for="plano-prioridade">Prioridade *</label><select id="plano-prioridade" required><option value="">Selecione</option><option value="Baixo">üü¢ Baixa</option><option value="M√©dio">üü° M√©dia</option><option value="Alto">üü† Alta</option><option value="Cr√≠tico">üî¥ Cr√≠tica</option></select></div>
                        <div class="form-group"><label for="plano-status">Status *</label><select id="plano-status" required><option value="">Selecione</option><option value="N√£o Iniciado">N√£o Iniciado</option><option value="Em Andamento">Em Andamento</option><option value="Atrasado">Atrasado</option><option value="Conclu√≠do">Conclu√≠do</option><option value="Cancelado">Cancelado</option></select></div>
                        
                        <!-- 5W2H -->
                        <div class="form-group" style="grid-column: 1 / -1;"><h3 style="margin: 20px 0 15px 0; color: #333;">Planejamento 5W2H</h3></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label for="plano-what">O qu√™? (What) - Qual √© a a√ß√£o a ser realizada? *</label><textarea id="plano-what" required placeholder="Descreva a a√ß√£o..." style="min-height: 80px; resize: vertical;"></textarea></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label for="plano-why">Por qu√™? (Why) - Qual √© a justificativa? *</label><textarea id="plano-why" required placeholder="Qual √© o motivo/objetivo..." style="min-height: 80px; resize: vertical;"></textarea></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label for="plano-where">Onde? (Where) - Local/Departamento *</label><input type="text" id="plano-where" required placeholder="Ex: Departamento de Vendas"></div>
                        <div class="form-group"><label for="plano-whenInicio">Data In√≠cio (When) *</label><input type="date" id="plano-whenInicio" required></div>
                        <div class="form-group"><label for="plano-whenFim">Data Fim (When) *</label><input type="date" id="plano-whenFim" required></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label for="plano-how">Como? (How) - Metodologia/Processo *</label><textarea id="plano-how" required placeholder="Descreva o m√©todo..." style="min-height: 80px; resize: vertical;"></textarea></div>
                        <div class="form-group" style="grid-column: 1 / -1;"><label for="plano-howMuch">Quanto custa? (How Much) - Recursos/Investimento</label><input type="text" id="plano-howMuch" placeholder="Ex: R$ 5000 ou 40 horas"></div>
                    </div>
                    
                    <div class="form-actions">
                        <a href="/Pages/PlanodeAcao/GerenciarPlanosAcao.html" class="btn-secondary">Cancelar</a>
                        <button type="submit" class="btn-primary" id="btn-salvar"><i data-lucide="save"></i> Salvar Plano</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <script type="module">
        // Importa√ß√µes
        import { db, auth } from "/assets/js/firebase-config.js";
        import { collection, addDoc, getDocs, getDoc, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { garantirAutenticacao } from '/assets/js/auth-guard.js';

        // --- VARI√ÅVEIS GLOBAIS ---
        let planoEmEdicao = null;
        let todosPlanos = [];
        let todosKPIs = [];

        const form = document.getElementById('form-plano-acao');
        const btnSalvar = document.getElementById('btn-salvar');
        const selectKPI = document.getElementById('plano-kpi');
        const inputMeta = document.getElementById('plano-meta');

        // Retorna o nome do usu√°rio usado pelo app (prioriza sources locais para evitar 'Usu√°rio' gen√©rico)
        function getAppUserName() {
            // 1) prioridade para valor fornecido pelo app (localStorage)
            const fromStorage = localStorage.getItem('userName');
            if (fromStorage && fromStorage.trim()) return fromStorage.trim();

            // 2) tentar ler diretamente do DOM (Menu.html -> #user-name)
            const menuEl = document.getElementById('user-name');
            if (menuEl && menuEl.textContent && menuEl.textContent.trim()) return menuEl.textContent.trim();

            // 3) fallback para auth.currentUser (displayName ou email prefix)
            const u = auth.currentUser;
            if (u) return u.displayName || (u.email && u.email.split('@')[0]) || 'Usu√°rio';

            return 'Usu√°rio';
        }

        // --- FUN√á√ïES PRINCIPAIS ---
        async function carregarKPIs() {
            try {
                const q = query(collection(db, 'kpis'), orderBy('dataCriacao', 'desc'));
                const snapshot = await getDocs(q);
                todosKPIs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Preencher select de KPIs
                selectKPI.innerHTML = '<option value="">Selecione um KPI</option>';
                todosKPIs.forEach(kpi => {
                    const option = document.createElement('option');
                    option.value = kpi.id;
                    // armazenar respons√°vel no dataset para uso r√°pido sem buscar o array
                    option.dataset.responsavel = kpi.responsavel || '';
                    option.textContent = `${kpi.nome} (${kpi.meta} ${kpi.unidade})`;
                    selectKPI.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar KPIs:", error);
            }
        }

        // Atualizar meta quando KPI √© selecionado
        // NOTA: para um NOVO plano n√£o sobrescrever o respons√°vel ‚Äî deve ser o criador (auth.currentUser).
        // Apenas ao EDITAR um plano permitimos que o respons√°vel venha do KPI associado.
        selectKPI.addEventListener('change', function() {
            const respField = document.getElementById('plano-responsavel');
            if (this.value) {
                const kpiSelecionado = todosKPIs.find(k => k.id === this.value);
                if (kpiSelecionado) {
                    inputMeta.value = `${kpiSelecionado.meta} ${kpiSelecionado.unidade}`;
                    // S√≥ sobrescreve o respons√°vel com o do KPI quando estivermos editando um plano existente
                    if (planoEmEdicao) {
                        if (kpiSelecionado.responsavel) {
                            respField.value = kpiSelecionado.responsavel;
                        } else if (!respField.value) {
                            respField.value = getAppUserName();
                        }
                    }
                    // se for novo plano (planoEmEdicao falsy) n√£o alterar o campo respons√°vel ‚Äî mant√©m o criador
                }
            } else {
                inputMeta.value = '';
                // em novo plano: garantir que respons√°vel volte a ser o criador se estiver vazio
                if (!planoEmEdicao && !respField.value) {
                    respField.value = getAppUserName();
                }
            }
        });

        window.editarPlano = function(id) {
            const plano = todosPlanos.find(p => p.id === id);
            if (!plano) return;

            document.getElementById('plano-nome').value = plano.nome;
            document.getElementById('plano-kpi').value = plano.kpiId;
            // preencher respons√°vel: 1) valor salvo no plano 2) responsavel do KPI associado 3) vazio
            document.getElementById('plano-responsavel').value = plano.responsavel || (todosKPIs.find(k=>k.id===plano.kpiId)?.responsavel) || '';
            document.getElementById('plano-meta').value = plano.meta;
            document.getElementById('plano-prioridade').value = plano.prioridade;
            document.getElementById('plano-status').value = plano.status;
            // garantir que listeners relacionados ao select sincronizem os campos (meta/respons√°vel)
            if (plano.kpiId) selectKPI.dispatchEvent(new Event('change'));
            
            // Preencher 5W2H
            document.getElementById('plano-what').value = plano.what || '';
            document.getElementById('plano-why').value = plano.why || '';
            document.getElementById('plano-whenInicio').value = plano.whenInicio || '';
            document.getElementById('plano-whenFim').value = plano.whenFim || '';
            document.getElementById('plano-where').value = plano.where || '';
            document.getElementById('plano-how').value = plano.how || '';
            document.getElementById('plano-howMuch').value = plano.howMuch || '';

            planoEmEdicao = id;
            document.getElementById('form-title').textContent = 'Editar Plano de A√ß√£o';
            document.getElementById('form-subtitle').textContent = 'Altere os dados do plano de a√ß√£o abaixo.';
            btnSalvar.innerHTML = '<i data-lucide="save"></i> Salvar Altera√ß√µes';

            window.scrollTo({ top: 0, behavior: 'smooth' });
            lucide.createIcons();
        };

        window.deletarPlano = async function(id) {
            const result = await Swal.fire({
                title: 'Tem certeza?',
                text: 'Esta a√ß√£o n√£o pode ser desfeita',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#193b7c',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, deletar!',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                try {
                    await deleteDoc(doc(db, 'planos-acao', id));
                    Swal.fire('Deletado!', 'Plano de a√ß√£o removido com sucesso', 'success');
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    Swal.fire('Erro!', 'Falha ao deletar plano de a√ß√£o', 'error');
                }
            }
        };

        // --- FORM SUBMIT ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalHtml = btnSalvar.innerHTML;
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i data-lucide="loader-2" class="spin"></i> Salvando...';
            lucide.createIcons();

            try {
                const kpiSelecionado = todosKPIs.find(k => k.id === document.getElementById('plano-kpi').value);
                
                const dados = {
                    nome: document.getElementById('plano-nome').value,
                    kpiId: document.getElementById('plano-kpi').value,
                    kpiNome: kpiSelecionado?.nome || '',
                    meta: document.getElementById('plano-meta').value,
                    responsavel: document.getElementById('plano-responsavel').value,
                    prioridade: document.getElementById('plano-prioridade').value,
                    status: document.getElementById('plano-status').value,
                    what: document.getElementById('plano-what').value,
                    why: document.getElementById('plano-why').value,
                    whenInicio: document.getElementById('plano-whenInicio').value,
                    whenFim: document.getElementById('plano-whenFim').value,
                    where: document.getElementById('plano-where').value,
                    how: document.getElementById('plano-how').value,
                    howMuch: document.getElementById('plano-howMuch').value
                };

                if (planoEmEdicao) {
                    dados.dataAtualizacao = new Date();
                    await updateDoc(doc(db, 'planos-acao', planoEmEdicao), dados);
                    Swal.fire('Sucesso!', 'Plano de a√ß√£o atualizado com sucesso!', 'success');
                } else {
                    dados.dataCriacao = new Date();
                    dados.criadoPor = auth.currentUser?.uid || null;
                    dados.criadoPorNome = getAppUserName();
                    dados.progresso = 0; // Progresso inicial
                    await addDoc(collection(db, 'planos-acao'), dados);
                    Swal.fire('Sucesso!', 'Plano de a√ß√£o cadastrado com sucesso!', 'success');
                }

                form.reset();
                planoEmEdicao = null;
                inputMeta.value = '';
                const _resp = document.getElementById('plano-responsavel');
                if (_resp) _resp.value = getAppUserName();
                document.getElementById('form-title').textContent = 'Novo Plano de A√ß√£o';
                document.getElementById('form-subtitle').textContent = 'Preencha os dados abaixo para criar um novo plano de a√ß√£o.';
                btnSalvar.innerHTML = '<i data-lucide="save"></i> Salvar Plano';

            } catch (error) {
                console.error('Erro ao salvar:', error);
                Swal.fire('Erro!', `Falha ao salvar: ${error.message}`, 'error');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = originalHtml;
                lucide.createIcons();
            }
        });

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await garantirAutenticacao(auth);

                // Preencher campo respons√°vel com o nome do criador (fonte consistente do app)
                const nomeApp = getAppUserName();
                const responsavelEl = document.getElementById('plano-responsavel');
                if (responsavelEl && !responsavelEl.value) responsavelEl.value = nomeApp;

                // observar altera√ß√µes no nome exibido no menu e sincronizar (n√£o sobrescreve durante edi√ß√£o)
                const menuNameEl = document.getElementById('user-name');
                if (menuNameEl) {
                    const mo = new MutationObserver(() => {
                        if (planoEmEdicao) return; // n√£o sobrescrever durante edi√ß√£o
                        const novo = getAppUserName();
                        if (responsavelEl) responsavelEl.value = novo;
                    });
                    mo.observe(menuNameEl, { childList: true, characterData: true, subtree: true });
                }

                await carregarKPIs();

                // Se houver pedido expl√≠cito para editar (vindo da lista), carregar o plano solicitado
                const planToEditId = sessionStorage.getItem('planToEditId') || new URLSearchParams(location.search).get('id');
                if (planToEditId) {
                    try {
                        const snap = await getDoc(doc(db, 'planos-acao', planToEditId));
                        if (snap && snap.exists()) {
                            const plano = { id: snap.id, ...snap.data() };

                            // Verificar se o usu√°rio √© o criador do plano
                            const currentUserId = auth.currentUser?.uid || null;
                            if (plano.criadoPor && plano.criadoPor !== currentUserId) {
                                Swal.fire('Acesso negado', 'Voc√™ s√≥ pode editar planos criados por voc√™.', 'warning');
                                sessionStorage.removeItem('planToEditId');
                                location.href = '/Pages/PlanodeAcao/GerenciarPlanosAcao.html';
                                return;
                            }

                            // preencher campos (mesma l√≥gica de editarPlano)
                            document.getElementById('plano-nome').value = plano.nome || '';
                            document.getElementById('plano-kpi').value = plano.kpiId || '';
                            document.getElementById('plano-responsavel').value = plano.responsavel || (todosKPIs.find(k=>k.id===plano.kpiId)?.responsavel) || getAppUserName();
                            document.getElementById('plano-meta').value = plano.meta || '';
                            document.getElementById('plano-prioridade').value = plano.prioridade || '';
                            document.getElementById('plano-status').value = plano.status || '';

                            document.getElementById('plano-what').value = plano.what || '';
                            document.getElementById('plano-why').value = plano.why || '';
                            document.getElementById('plano-whenInicio').value = plano.whenInicio || '';
                            document.getElementById('plano-whenFim').value = plano.whenFim || '';
                            document.getElementById('plano-where').value = plano.where || '';
                            document.getElementById('plano-how').value = plano.how || '';
                            document.getElementById('plano-howMuch').value = plano.howMuch || '';
                            document.getElementById('plano-objetivos').value = plano.objetivos || '';
                            document.getElementById('plano-criteriosSucesso').value = plano.criteriosSucesso || '';

                            planoEmEdicao = plano.id;
                            document.getElementById('form-title').textContent = 'Editar Plano de A√ß√£o';
                            document.getElementById('form-subtitle').textContent = 'Altere os dados do plano de a√ß√£o abaixo.';
                            btnSalvar.innerHTML = '<i data-lucide="save"></i> Salvar Altera√ß√µes';

                            // garantir sincroniza√ß√£o de meta/respons√°vel
                            if (plano.kpiId) selectKPI.dispatchEvent(new Event('change'));

                            // limpar sinaliza√ß√£o de navega√ß√£o para edi√ß√£o
                            try { sessionStorage.removeItem('planToEditId'); } catch (e) { /* silencioso */ }
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    } catch (err) {
                        console.error('Falha ao carregar plano para edi√ß√£o:', err);
                    }
                }

                // sincronizar campos com o KPI selecionado (√∫til quando estamos em edi√ß√£o)
                if (selectKPI.value) selectKPI.dispatchEvent(new Event('change'));
                lucide.createIcons();
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                const homeSection = document.querySelector('.home');
                if (homeSection) {
                    homeSection.innerHTML = `<div class="error-container"><h1>Erro Cr√≠tico</h1><p>${error.message}</p></div>`;
                }
            }
        });

        function showToast(message, icon = 'info') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
            });
            Toast.fire({ icon, title: message });
        }
    </script>

    <!-- Scripts Globais -->
    <script type="module" src="/assets/js/auth.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/components/Sidebar.js"></script>
</body>
</html>
