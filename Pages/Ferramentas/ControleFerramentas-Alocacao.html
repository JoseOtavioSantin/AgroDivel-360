<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Controle de Ferramentas - Aloca√ß√£o</title>
    <link rel="icon" type="image/png" href="/assets/images/iconeaba.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c2f3f" />

    <!-- LIBS EXTERNAS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/Pages/Dashboard/Principal.css">
    <link rel="stylesheet" href="/assets/css/Pages/Controles/ControleFerramentas.css">

    <!-- ========== CSS PARA OS MODAIS E SPINNER DE CARREGAMENTO ========== -->
    <style>
        .error-container { padding: 20px; background-color: #ffdddd; border: 1px solid #ff0000; color: #D8000C; border-radius: 8px; margin: 20px; }

        /* Estilo do Overlay (fundo escuro) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Estilos para o modal de devolu√ß√£o */
        .modal-ferramentas .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-ferramentas .modal-body {
            padding: 20px;
        }

        .radio-option {
            transition: all 0.2s ease;
        }

        .radio-option:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Estilos para grupos de OS */
        .grupo-os:hover {
            background-color: #34495e !important;
        }

        .grupo-os td {
            font-weight: 500;
        }

        .detalhes-os table {
            font-size: 0.9rem;
            background-color: #ffffff;
        }

        .detalhes-os tbody tr {
            background-color: #ffffff !important;
        }

        .detalhes-os tbody tr:hover {
            background-color: #e3f2fd !important;
        }

        .detalhes-os td {
            color: #fff !important;
        }

        /* Estilos simplificados para a tabela de aloca√ß√µes */
        .os-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #bbdefb;
        }

        .btn-pdf-header {
            background-color: #d32f2f !important;
        }

        .btn-pdf-header:hover {
            background-color: #b71c1c !important;
        }
    </style>
</head>
<body>

    <nav id="sidebar-placeholder"></nav>

    <section class="home">
        <div class="text">
            <h1>Controle de Ferramentas - Aloca√ß√£o</h1>
            <p id="dynamic-title">Gest√£o de ferramentas alocadas e devolu√ß√µes</p>
        </div>
        
        <!-- ABA ALOCA√á√ÉO -->
        <div class="tab-content active">
            <div class="content-card">
                <div class="content-card-header">
                    <h3>Ferramentas Alocadas</h3>
                    <div class="header-actions">
                        <a href="/Pages/Formularios/form-alocacao.html" class="btn-acao" title="Alocar Nova Ferramenta">
                            <i data-lucide="plus"></i>
                        </a>
                        <a href="/Pages/Formularios/GerarRelatorio.html" class="btn-acao btn-pdf-header" title="Gerar PDF por OS">
                            <i data-lucide="file-text"></i>
                        </a>
                    </div>
                </div>
                <div class="content-card-body">
                    <div class="filters">
                        <select id="filtro-aloc-filial">
                            <option value="">Todas as Filiais</option>
                            <option value="Campos Novos">Campos Novos</option>
                            <option value="Rio do Sul">Rio do Sul</option>
                            <option value="Lages">Lages</option>
                        </select>
                        <input id="filtro-aloc-ferramenta" type="text" placeholder="Buscar por ferramenta..." />
                        <input id="filtro-aloc-funcionario" type="text" placeholder="Buscar por funcion√°rio..." />
                        <input id="filtro-aloc-os" type="text" placeholder="Buscar por OS..." />
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>OS</th>
                                    <th>Ferramenta</th>
                                    <th>Funcion√°rio</th>
                                    <th>Data Aloca√ß√£o</th>
                                    <th style="text-align: center;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-alocacao"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- MODAL DE DEVOLU√á√ÉO INTELIGENTE -->
    <div id="modal-devolucao" class="modal-ferramentas">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Devolu√ß√£o de Ferramenta</h3>
                <span class="close-button" onclick="fecharModalDevolucao()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="info-ferramenta-devolucao" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #333;">
                    <!-- Informa√ß√µes da ferramenta ser√£o inseridas aqui -->
                </div>

                <div id="selecao-devolucao" style="margin-bottom: 20px; color: #333;">
                    <!-- Op√ß√µes de sele√ß√£o ser√£o inseridas dinamicamente -->
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="checkbox-avaria" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: #d32f2f;">A ferramenta possui avaria?</span>
                    </label>
                </div>

                <div id="container-avaria" style="display: none; margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Descri√ß√£o da Avaria:</label>
                    <textarea id="textarea-avaria" 
                              placeholder="Descreva a avaria encontrada na ferramenta..." 
                              style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; resize: vertical; color: #333;"></textarea>
                    
                    <label style="display: flex; align-items: center; gap: 8px; margin-top: 12px; cursor: pointer;">
                        <input type="checkbox" id="checkbox-inativa" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: #f57c00;">Marcar ferramenta como inativa (n√£o dispon√≠vel para aloca√ß√£o)</span>
                    </label>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-secundario" onclick="fecharModalDevolucao()">Cancelar</button>
                    <button class="btn btn-sucesso" onclick="confirmarDevolucao()">
                        <i data-lucide="check"></i> Confirmar Devolu√ß√£o
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toast-container"></div>

    <!-- SCRIPT COMPLETO -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { garantirAutenticacao } from '/assets/js/auth-guard.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDcjPa9jXsCCu6lNc1fjVg4Bzz1toKWAGY",
            authDomain: "agro-divel.firebaseapp.com",
            projectId: "agro-divel",
            storageBucket: "agro-divel.appspot.com",
            messagingSenderId: "583977436505",
            appId: "1:583977436505:web:3754ec029aebb3d9d67848"
        };

        let app, db, auth;
        let todasFerramentas = [], todasAlocacoes = [];

        async function iniciarPagina() {
            try {
                if (!getApps().length) { 
                    app = initializeApp(firebaseConfig); 
                } else { 
                    app = getApp(); 
                }
                db = getFirestore(app);
                auth = getAuth(app);
                await garantirAutenticacao(auth);
                carregarDados();
                configurarEventListeners();
                lucide.createIcons();
            } catch (error) {
                console.error("Falha na inicializa√ß√£o:", error);
                const homeSection = document.querySelector('.home');
                if (homeSection) {
                    homeSection.innerHTML = `<div class="error-container"><h1>Erro</h1><p>N√£o foi poss√≠vel carregar os dados.</p></div>`;
                }
            }
        }

        // FUN√á√ÉO MELHORADA PARA RENDERIZAR ALOCA√á√ïES AGRUPADAS POR OS
        function renderizarTabelaAlocacao(alocacoes) {
            const tabelaBody = document.getElementById('tabela-alocacao');
            tabelaBody.innerHTML = '';
            
            if (alocacoes.length === 0) {
                tabelaBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                            <i data-lucide="inbox"></i>
                            <br>Nenhuma ferramenta alocada
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }

            // Agrupar aloca√ß√µes por OS
            const alocacoesPorOS = {};
            alocacoes.forEach(a => {
                const os = a.ordemServico || 'Sem OS';
                if (!alocacoesPorOS[os]) {
                    alocacoesPorOS[os] = [];
                }
                alocacoesPorOS[os].push(a);
            });

            // Renderizar cada grupo de OS
            Object.keys(alocacoesPorOS).forEach(os => {
                const alocacoesOS = alocacoesPorOS[os];
                const primeiraAlocacao = alocacoesOS[0];
                const dataAlocacao = formatarDataHora(primeiraAlocacao.dataAlocacao);
                const funcionario = primeiraAlocacao.funcionario;
                
                // Pegar a primeira ferramenta para mostrar a filial
                const primeiraFerramenta = todasFerramentas.find(f => f.id === primeiraAlocacao.ferramentaId);
                const filial = primeiraFerramenta ? primeiraFerramenta.filial : '';

                // Linha principal do grupo (cabe√ßalho clic√°vel)
                const trGrupo = document.createElement('tr');
                trGrupo.className = 'grupo-os';
                trGrupo.style.cursor = 'pointer';
                trGrupo.style.backgroundColor = '#2c3e50';
                trGrupo.style.borderLeft = '4px solid #3498db';
                trGrupo.style.color = '#ffffff';
                
                trGrupo.innerHTML = `
                    <td style="padding: 15px 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i data-lucide="chevron-right" class="chevron-icon" style="width: 20px; height: 20px; transition: transform 0.3s; color: #3498db;"></i>
                            <span class="os-badge" style="font-size: 14px; font-weight: 700; background: #3498db; color: white; border: none;">${os}</span>
                        </div>
                    </td>
                    <td style="padding: 15px 10px;">
                        <div>
                            <strong style="color: #ffffff;">${alocacoesOS.length} ferramenta${alocacoesOS.length > 1 ? 's' : ''} alocada${alocacoesOS.length > 1 ? 's' : ''}</strong>
                            <div style="font-size: 0.85em; color: #bdc3c7; margin-top: 2px;">
                                ${filial ? `Filial: ${filial}` : ''}
                            </div>
                        </div>
                    </td>
                    <td style="padding: 15px 10px;">
                        <strong style="color: #ffffff;">${funcionario}</strong>
                    </td>
                    <td style="padding: 15px 10px; color: #ecf0f1;">${dataAlocacao}</td>
                    <td style="text-align: center; padding: 15px 10px;">
                        <button class="btn btn-sucesso btn-devolver-os" 
                                data-os="${os}"
                                title="Devolver todas as ferramentas desta OS"
                                style="font-size: 0.85rem;">
                            <i data-lucide="arrow-left-circle"></i> Devolver Todas
                        </button>
                    </td>
                `;

                trGrupo.addEventListener('click', (e) => {
                    // N√£o expandir se clicar no bot√£o
                    if (e.target.closest('.btn-devolver-os')) return;
                    
                    const detalhesRow = trGrupo.nextElementSibling;
                    const chevron = trGrupo.querySelector('.chevron-icon');
                    
                    if (detalhesRow && detalhesRow.classList.contains('detalhes-os')) {
                        const isVisible = detalhesRow.style.display !== 'none';
                        detalhesRow.style.display = isVisible ? 'none' : 'table-row';
                        chevron.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(90deg)';
                    }
                });

                tabelaBody.appendChild(trGrupo);

                // Linha de detalhes (expand√≠vel)
                const trDetalhes = document.createElement('tr');
                trDetalhes.className = 'detalhes-os';
                trDetalhes.style.display = 'none';
                trDetalhes.style.backgroundColor = '#ffffff';
                
                let detalhesHTML = '<td colspan="5" style="padding: 0;"><div style="padding: 15px 20px; border-left: 4px solid #3498db; margin-left: 4px; background: #f8f9fa;">';
                detalhesHTML += '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">';
                detalhesHTML += '<thead><tr style="background: #1a252f; color: white; font-size: 0.9rem;">';
                detalhesHTML += '<th style="padding: 14px; text-align: left; font-weight: 600;">Ferramenta</th>';
                detalhesHTML += '<th style="padding: 14px; text-align: left; font-weight: 600;">C√≥digo</th>';
                detalhesHTML += '<th style="padding: 14px; text-align: left; font-weight: 600;">Localiza√ß√£o</th>';
                detalhesHTML += '<th style="padding: 14px; text-align: center; font-weight: 600;">A√ß√µes</th>';
                detalhesHTML += '</tr></thead><tbody>';

                alocacoesOS.forEach(a => {
                    const ferramenta = todasFerramentas.find(f => f.id === a.ferramentaId);
                    const descricao = ferramenta ? ferramenta.descricao : 'Ferramenta n√£o encontrada';
                    const codigo = ferramenta ? ferramenta.codigo : 'N/A';
                    const localizacao = ferramenta ? (ferramenta.localizacao || '-') : '-';
                    
                    detalhesHTML += `
                        <tr style="border-bottom: 1px solid #dee2e6; background-color: #ffffff;">
                            <td style="padding: 14px; color: #1a252f; font-size: 0.95rem;">
                                <strong>${descricao}</strong>
                            </td>
                            <td style="padding: 14px; color: #1a252f; font-weight: 500; font-size: 0.95rem;">${codigo}</td>
                            <td style="padding: 14px; color: #1a252f; font-weight: 500; font-size: 0.95rem;">${localizacao}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button class="btn btn-secundario btn-devolver" 
                                        data-id="${a.id}" 
                                        data-ferramenta-id="${a.ferramentaId}" 
                                        data-funcionario="${a.funcionario}"
                                        title="Devolver apenas esta ferramenta"
                                        style="font-size: 0.8rem; padding: 6px 12px;">
                                    <i data-lucide="arrow-left-circle" style="width: 14px; height: 14px;"></i> Devolver
                                </button>
                            </td>
                        </tr>
                    `;
                });

                detalhesHTML += '</tbody></table></div></td>';
                trDetalhes.innerHTML = detalhesHTML;
                tabelaBody.appendChild(trDetalhes);
            });
            
            lucide.createIcons();
        }

        // FUN√á√ÉO PARA FILTRAR ALOCA√á√ïES
        function aplicarFiltrosAlocacao() {
            const filial = document.getElementById('filtro-aloc-filial').value;
            const ferramenta = document.getElementById('filtro-aloc-ferramenta').value.toLowerCase();
            const funcionario = document.getElementById('filtro-aloc-funcionario').value.toLowerCase();
            const os = document.getElementById('filtro-aloc-os').value.toLowerCase();
            
            const filtrado = todasAlocacoes.filter(a => {
                const ferramentaObj = todasFerramentas.find(f => f.id === a.ferramentaId);
                const descricaoFerramenta = ferramentaObj ? ferramentaObj.descricao.toLowerCase() : '';
                const codigoFerramenta = ferramentaObj ? ferramentaObj.codigo.toLowerCase() : '';
                const filialFerramenta = ferramentaObj ? ferramentaObj.filial : '';
                
                return (
                    (!filial || filialFerramenta === filial) &&
                    (!ferramenta || descricaoFerramenta.includes(ferramenta) || codigoFerramenta.includes(ferramenta)) &&
                    (!funcionario || a.funcionario.toLowerCase().includes(funcionario)) &&
                    (!os || (a.ordemServico && a.ordemServico.toLowerCase().includes(os)))
                );
            });
            
            filtrado.sort((a, b) => {
                const dataA = a.dataAlocacao?.toDate?.() || new Date(0);
                const dataB = b.dataAlocacao?.toDate?.() || new Date(0);
                return dataB - dataA;
            });
            
            renderizarTabelaAlocacao(filtrado);
        }

        // FUN√á√ÉO PARA CARREGAR DADOS (apenas aloca√ß√µes e ferramentas)
        async function carregarDados() {
            try {
                // Carregar ferramentas
                const qFerramentas = query(collection(db, 'ferramentas'), orderBy('codigo'));
                const snapshotFerramentas = await getDocs(qFerramentas);
                todasFerramentas = snapshotFerramentas.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Carregar aloca√ß√µes
                const qAlocacoes = query(collection(db, 'alocacoes'), orderBy('dataAlocacao', 'desc'));
                const snapshotAlocacoes = await getDocs(qAlocacoes);
                todasAlocacoes = snapshotAlocacoes.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                aplicarFiltrosAlocacao();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // FUN√á√ÉO PARA CONFIGURAR EVENT LISTENERS
        function configurarEventListeners() {
            // Fechar modal
            document.querySelectorAll('.modal-ferramentas .close-button').forEach(btn => {
                btn.addEventListener('click', () => fecharModal(btn.closest('.modal-ferramentas')));
            });

            // Devolver ferramenta (Modal Inteligente)
            document.getElementById('tabela-alocacao').addEventListener('click', async (e) => {
                // Bot√£o devolver todas as ferramentas da OS
                const btnDevolverOS = e.target.closest('.btn-devolver-os');
                if (btnDevolverOS) {
                    const os = btnDevolverOS.dataset.os;
                    const alocacoesOS = todasAlocacoes.filter(a => a.ordemServico === os);
                    
                    if (alocacoesOS.length > 0) {
                        // Pega qualquer aloca√ß√£o para abrir o modal
                        const primeiraAlocacao = alocacoesOS[0];
                        abrirModalDevolucao(primeiraAlocacao.id, primeiraAlocacao.ferramentaId, primeiraAlocacao.funcionario);
                    }
                    return;
                }

                // Bot√£o devolver ferramenta individual
                const btnDev = e.target.closest('.btn-devolver');
                if (btnDev) {
                    abrirModalDevolucao(btnDev.dataset.id, btnDev.dataset.ferramentaId, btnDev.dataset.funcionario);
                }
            });

            // Checkbox de avaria
            document.getElementById('checkbox-avaria').addEventListener('change', (e) => {
                const containerAvaria = document.getElementById('container-avaria');
                if (e.target.checked) {
                    containerAvaria.style.display = 'block';
                } else {
                    containerAvaria.style.display = 'none';
                    document.getElementById('textarea-avaria').value = '';
                    document.getElementById('checkbox-inativa').checked = false;
                }
            });

            // Filtros
            document.querySelectorAll('#filtro-aloc-filial, #filtro-aloc-ferramenta, #filtro-aloc-funcionario, #filtro-aloc-os').forEach(el => {
                el.addEventListener('input', aplicarFiltrosAlocacao);
            });

            // Auto-refresh a cada 120 segundos
            setInterval(carregarDados, 120000);
        }

        // FUN√á√ïES UTILIT√ÅRIAS
        function showToast(message, type = 'info') {
            const c = document.getElementById('toast-container');
            if (!c) return;
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = message;
            c.appendChild(t);
            setTimeout(() => t.classList.add('show'), 100);
            setTimeout(() => {
                t.classList.remove('show');
                setTimeout(() => c.removeChild(t), 300);
            }, 3000);
        }

        function formatarDataHora(timestamp) {
            if (!timestamp) return 'Data inv√°lida';
            const data = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            return data.toLocaleString('pt-BR');
        }

        async function adicionarHistorico(tipo, ferramentaId, detalhes = {}) {
            const f = todasFerramentas.find(fer => fer.id === ferramentaId);
            if (!f) return;
            await addDoc(collection(db, 'historico'), {
                tipo,
                ferramentaId,
                ferramentaCodigo: f.codigo,
                ferramentaDescricao: f.descricao,
                filial: f.filial,
                timestamp: new Date(),
                detalhes
            });
        }

        // VARI√ÅVEL GLOBAL PARA ARMAZENAR DADOS DA DEVOLU√á√ÉO
        let dadosDevolucaoAtual = null;

        // FUN√á√ÉO PARA ABRIR MODAL DE DEVOLU√á√ÉO INTELIGENTE
        window.abrirModalDevolucao = function(alocacaoId, ferramentaId, funcionario) {
            const alocacaoAtual = todasAlocacoes.find(a => a.id === alocacaoId);
            const ferramenta = todasFerramentas.find(f => f.id === ferramentaId);
            
            if (!ferramenta || !alocacaoAtual) {
                showToast('Dados n√£o encontrados!', 'error');
                return;
            }

            const osAtual = alocacaoAtual.ordemServico;
            
            // Buscar todas as aloca√ß√µes desta OS (mesmo n√∫mero de OS)
            const alocacoesDaOS = todasAlocacoes.filter(a => a.ordemServico === osAtual);
            
            // Armazenar dados para uso posterior
            dadosDevolucaoAtual = {
                alocacaoId: alocacaoId,
                ferramentaId: ferramentaId,
                funcionario: funcionario,
                ferramenta: ferramenta,
                ordemServico: osAtual,
                alocacoes: alocacoesDaOS
            };

            // Preencher informa√ß√µes da ferramenta
            const infoContainer = document.getElementById('info-ferramenta-devolucao');
            infoContainer.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 2.5rem;">üîß</div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0; color: #333;">${ferramenta.descricao}</h4>
                        <p style="margin: 0; color: #666; font-size: 0.9rem;">
                            <strong>C√≥digo:</strong> ${ferramenta.codigo} | 
                            <strong>Filial:</strong> ${ferramenta.filial} | 
                            <strong>OS:</strong> ${osAtual || 'N/A'}
                        </p>
                    </div>
                </div>
            `;

            // Preencher op√ß√µes de sele√ß√£o
            const selecaoContainer = document.getElementById('selecao-devolucao');
            
            if (alocacoesDaOS.length > 1) {
                // M√∫ltiplas ferramentas na mesma OS - mostrar op√ß√µes
                const listaFerramentasOS = alocacoesDaOS.map(a => {
                    const f = todasFerramentas.find(fer => fer.id === a.ferramentaId);
                    return f ? f.descricao : 'Ferramenta desconhecida';
                }).join(', ');

                selecaoContainer.innerHTML = `
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 15px; color: #333;">
                        <strong style="color: #856404;">‚ö†Ô∏è Esta OS possui ${alocacoesDaOS.length} ferramentas alocadas</strong>
                        <p style="margin: 5px 0 0 0; font-size: 0.85rem; color: #856404;">
                            ${alocacoesDaOS.map(a => {
                                const f = todasFerramentas.find(fer => fer.id === a.ferramentaId);
                                return f ? `‚Ä¢ ${f.descricao}` : '';
                            }).filter(t => t).join('<br>')}
                        </p>
                    </div>
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">Selecione o que deseja devolver:</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #2c5aa0; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: #f0f7ff;" class="radio-option">
                            <input type="radio" name="tipo-devolucao" value="unica" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <div>
                                <div style="font-weight: 600; color: #333;">Devolver apenas esta ferramenta</div>
                                <div style="font-size: 0.85rem; color: #666;">${ferramenta.descricao} - ${funcionario}</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white;" class="radio-option">
                            <input type="radio" name="tipo-devolucao" value="todas-os" style="width: 18px; height: 18px; cursor: pointer;">
                            <div>
                                <div style="font-weight: 600; color: #333;">Devolver todas as ${alocacoesDaOS.length} ferramentas da OS ${osAtual}</div>
                                <div style="font-size: 0.85rem; color: #666;">Todas as ferramentas desta ordem de servi√ßo</div>
                            </div>
                        </label>
                    </div>
                `;

                // Adicionar efeito hover nas op√ß√µes
                document.querySelectorAll('.radio-option').forEach(label => {
                    label.addEventListener('mouseenter', () => {
                        if (!label.querySelector('input[type="radio"]').checked) {
                            label.style.borderColor = '#2c5aa0';
                            label.style.backgroundColor = '#f0f7ff';
                        }
                    });
                    label.addEventListener('mouseleave', () => {
                        const input = label.querySelector('input[type="radio"]');
                        if (!input.checked) {
                            label.style.borderColor = '#ddd';
                            label.style.backgroundColor = 'white';
                        }
                    });
                    label.querySelector('input[type="radio"]').addEventListener('change', () => {
                        document.querySelectorAll('.radio-option').forEach(l => {
                            l.style.borderColor = '#ddd';
                            l.style.backgroundColor = 'white';
                        });
                        label.style.borderColor = '#2c5aa0';
                        label.style.backgroundColor = '#f0f7ff';
                    });
                });
            } else {
                // Apenas uma aloca√ß√£o
                selecaoContainer.innerHTML = `
                    <div style="background: #e8f5e9; padding: 12px; border-radius: 6px; border-left: 4px solid #4caf50; color: #333;">
                        <strong style="color: #2e7d32;">‚úì Aloca√ß√£o √∫nica</strong>
                        <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #2e7d32;">
                            Esta √© a √∫nica aloca√ß√£o ativa desta ferramenta.
                        </p>
                    </div>
                `;
            }

            // Resetar campos de avaria
            document.getElementById('checkbox-avaria').checked = false;
            document.getElementById('container-avaria').style.display = 'none';
            document.getElementById('textarea-avaria').value = '';
            document.getElementById('checkbox-inativa').checked = false;

            // Abrir modal
            abrirModal(document.getElementById('modal-devolucao'));
            lucide.createIcons();
        };

        // FUN√á√ÉO PARA FECHAR MODAL DE DEVOLU√á√ÉO
        window.fecharModalDevolucao = function() {
            fecharModal(document.getElementById('modal-devolucao'));
            dadosDevolucaoAtual = null;
        };

        // FUN√á√ÉO PARA CONFIRMAR DEVOLU√á√ÉO
        window.confirmarDevolucao = async function() {
            if (!dadosDevolucaoAtual) return;

            try {
                const temAvaria = document.getElementById('checkbox-avaria').checked;
                const descricaoAvaria = document.getElementById('textarea-avaria').value.trim();
                const marcarInativa = document.getElementById('checkbox-inativa').checked;

                // Valida√ß√£o
                if (temAvaria && !descricaoAvaria) {
                    showToast('Por favor, descreva a avaria encontrada', 'error');
                    return;
                }

                // Determinar quais aloca√ß√µes devolver
                let alocacoesParaDevolver = [];
                const radioSelecionado = document.querySelector('input[name="tipo-devolucao"]:checked');
                
                if (radioSelecionado && radioSelecionado.value === 'todas-os') {
                    // Devolver todas as ferramentas da OS
                    alocacoesParaDevolver = dadosDevolucaoAtual.alocacoes;
                } else {
                    // Devolver apenas esta ferramenta espec√≠fica
                    alocacoesParaDevolver = [todasAlocacoes.find(a => a.id === dadosDevolucaoAtual.alocacaoId)];
                }

                // Processar devolu√ß√µes
                const promises = [];
                const ferramentasDevolvidas = new Set();
                
                for (const alocacao of alocacoesParaDevolver) {
                    if (alocacao) {
                        promises.push(deleteDoc(doc(db, 'alocacoes', alocacao.id)));
                        
                        const detalhes = { 
                            funcionario: alocacao.funcionario,
                            ordemServico: alocacao.ordemServico
                        };
                        if (temAvaria) {
                            detalhes.avaria = descricaoAvaria;
                        }
                        promises.push(adicionarHistorico('devolucao', alocacao.ferramentaId, detalhes));
                        ferramentasDevolvidas.add(alocacao.ferramentaId);
                    }
                }

                // Se houver avaria e marcar como inativa (apenas na ferramenta clicada)
                if (temAvaria && marcarInativa) {
                    const ferramentaRef = doc(db, 'ferramentas', dadosDevolucaoAtual.ferramentaId);
                    promises.push(updateDoc(ferramentaRef, {
                        inativa: true,
                        motivoInativa: descricaoAvaria,
                        dataInativa: new Date()
                    }));
                }

                // Executar todas as opera√ß√µes
                await Promise.all(promises);

                let mensagem = '';
                if (alocacoesParaDevolver.length > 1) {
                    mensagem = `${alocacoesParaDevolver.length} ferramentas da OS ${dadosDevolucaoAtual.ordemServico} devolvidas com sucesso!`;
                } else {
                    mensagem = 'Ferramenta devolvida com sucesso!';
                }
                
                showToast(mensagem, 'success');
                
                if (temAvaria && marcarInativa) {
                    showToast('Ferramenta marcada como inativa', 'info');
                }

                fecharModalDevolucao();
                await carregarDados();
            } catch (error) {
                console.error('Erro ao devolver ferramenta:', error);
                showToast('Erro ao processar devolu√ß√£o', 'error');
            }
        };

        function abrirModal(modal) {
            modal.classList.add('active');
        }

        function fecharModal(modal) {
            modal.classList.remove('active');
        }

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', iniciarPagina);
    </script>

    <!-- Scripts Globais -->
    <script type="module" src="/assets/js/auth.js"></script>
    <script src="/assets/js/main.js"></script> 
    <script src="/assets/js/components/Sidebar.js"></script>
</body>
</html>
