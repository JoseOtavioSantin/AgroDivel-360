<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Controle de Ferramentas - Grupos</title>
    <link rel="icon" type="image/png" href="/assets/images/iconeaba.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c2f3f" />

    <!-- LIBS EXTERNAS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/Pages/Dashboard/Principal.css">
    <link rel="stylesheet" href="/assets/css/Pages/Controles/ControleFerramentas.css">

    <!-- ========== CSS PARA OS MODAIS ========== -->
    <style>
        .error-container { padding: 20px; background-color: #ffdddd; border: 1px solid #ff0000; color: #D8000C; border-radius: 8px; margin: 20px; }
    </style>
</head>
<body>

    <nav id="sidebar-placeholder"></nav>

    <section class="home">
        <div class="text">
            <h1>Controle de Ferramentas - Grupos</h1>
            <p id="dynamic-title">Gerenciamento de grupos de ferramentas</p>
        </div>
        
        <!-- ABA GRUPOS -->
        <div class="tab-content active">
            <div class="content-card" style="max-width: 700px; margin: 0 auto;">
                <div class="content-card-header">
                    <h3>Gerenciar Grupos de Ferramentas</h3>
                </div>
                <div class="content-card-body">
                    <form id="form-grupo" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="grupo-nome" placeholder="Nome do novo grupo" required style="flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #555; background-color: var(--cor-fundo); color: var(--cor-texto);">
                        <button type="submit" class="btn btn-primario">Adicionar</button>
                    </form>
                    <ul id="lista-grupos" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>
        </div>
    </section>
    
    <div class="toast-container" id="toast-container"></div>

    <!-- SCRIPT COMPLETO -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { garantirAutenticacao } from '/assets/js/auth-guard.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDcjPa9jXsCCu6lNc1fjVg4Bzz1toKWAGY",
            authDomain: "agro-divel.firebaseapp.com",
            projectId: "agro-divel",
            storageBucket: "agro-divel.appspot.com",
            messagingSenderId: "583977436505",
            appId: "1:583977436505:web:3754ec029aebb3d9d67848"
        };

        let app, db, auth;
        let todosGrupos = [], todasFerramentas = [];

        async function iniciarPagina() {
            try {
                if (!getApps().length) { 
                    app = initializeApp(firebaseConfig); 
                } else { 
                    app = getApp(); 
                }
                db = getFirestore(app);
                auth = getAuth(app);
                await garantirAutenticacao(auth);
                carregarDados();
                configurarEventListeners();
                lucide.createIcons();
            } catch (error) {
                console.error("Falha na inicialização:", error);
                const homeSection = document.querySelector('.home');
                if (homeSection) {
                    homeSection.innerHTML = `<div class="error-container"><h1>Erro</h1><p>Não foi possível carregar os dados.</p></div>`;
                }
            }
        }

        // FUNÇÃO PARA RENDERIZAR LISTA DE GRUPOS
        function renderizarListaGrupos() {
            const lista = document.getElementById('lista-grupos');
            lista.innerHTML = '';
            todosGrupos.forEach(g => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${g.nome}</span>
                    <div>
                        <button class="btn btn-alerta btn-remover-grupo" data-id="${g.id}" title="Remover">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                `;
                lista.appendChild(li);
            });
            lucide.createIcons();
        }

        // FUNÇÃO PARA CARREGAR DADOS (apenas grupos e ferramentas para validação)
        async function carregarDados() {
            try {
                // Carregar grupos
                const qGrupos = query(collection(db, 'grupos'), orderBy('nome'));
                const snapshotGrupos = await getDocs(qGrupos);
                todosGrupos = snapshotGrupos.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Carregar ferramentas para validação (verificar se grupo está em uso)
                const qFerramentas = query(collection(db, 'ferramentas'), orderBy('codigo'));
                const snapshotFerramentas = await getDocs(qFerramentas);
                todasFerramentas = snapshotFerramentas.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderizarListaGrupos();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // FUNÇÃO PARA CONFIGURAR EVENT LISTENERS
        function configurarEventListeners() {
            // Formulário de grupo
            document.getElementById('form-grupo').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nome = document.getElementById('grupo-nome').value.trim().toUpperCase();
                if (nome) {
                    try {
                        await addDoc(collection(db, 'grupos'), { nome });
                        document.getElementById('grupo-nome').value = '';
                        showToast('Grupo adicionado!', 'success');
                        await carregarDados();
                    } catch (error) {
                        showToast('Erro ao adicionar grupo', 'error');
                    }
                }
            });

            // Remover grupo
            document.getElementById('lista-grupos').addEventListener('click', async (e) => {
                const btn = e.target.closest('.btn-remover-grupo');
                if (btn) {
                    if (todasFerramentas.some(f => f.grupoId === btn.dataset.id)) {
                        showToast('Grupo em uso!', 'error');
                        return;
                    }
                    if (confirm('Remover este grupo?')) {
                        await deleteDoc(doc(db, 'grupos', btn.dataset.id));
                        await carregarDados();
                    }
                }
            });

            // Auto-refresh a cada 120 segundos
            setInterval(carregarDados, 120000);
        }

        // FUNÇÕES UTILITÁRIAS
        function showToast(message, type = 'info') {
            const c = document.getElementById('toast-container');
            if (!c) return;
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = message;
            c.appendChild(t);
            setTimeout(() => t.classList.add('show'), 100);
            setTimeout(() => {
                t.classList.remove('show');
                setTimeout(() => c.removeChild(t), 300);
            }, 3000);
        }

        // INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', iniciarPagina);
    </script>

    <!-- Scripts Globais -->
    <script type="module" src="/assets/js/auth.js"></script>
    <script src="/assets/js/main.js"></script> 
    <script src="/assets/js/components/Sidebar.js"></script>
</body>
</html>
