<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>An√°lise de Vendas - Lubrificantes</title>
  <link rel="icon" type="image/png" href="/assets/images/iconeaba.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/Pages/Dashboard/Principal.css">
  <style>
    body { background: #f5f7fa; }
    .content-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,.1); margin-bottom: 20px; overflow: hidden; }
    .content-card-header { background: #00205b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .content-card-header h3 { margin: 0; font-size: 18px; font-weight: 600; }
    .content-card-body { padding: 20px; }
    .header-actions { display: flex; gap: 10px; }
    .btn-acao {
      display: inline-flex; align-items: center; justify-content: center;
      background-color: transparent; color: white; border: none;
      border-radius: 6px; padding: 7px 12px; cursor: pointer;
      margin: 0 2px;
      font-size: 1.05em;
      transition: background-color .18s;
    }
    .btn-acao:hover { background-color: rgba(255,255,255,0.1); }
    .btn-acao i { width: 20px; height: 20px; pointer-events:none;}
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr ));
      gap: 20px;
      margin-bottom: 20px;
    }
    .dashboard-card {
      margin-top:20px; padding: 20px; border-radius: 8px; color: white; background: #2c2f3f;
      box-shadow: 0 2px 4px rgba(0,0,0,.1); transition: transform .2s, box-shadow .2s;
      display: flex; flex-direction: column; gap: 6px; border-left: 4px solid;
      min-height: 120px; max-height: 120px;
    }
    .dashboard-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,.2); }
    .dashboard-card h2 { 
      margin: 0; font-size: 25px; font-weight: bold;
      overflow: hidden; text-overflow: ellipsis; display: -webkit-box;
      -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.2;
    }
    .dashboard-card p { 
      margin: 0; font-size: 15px; color: #eee; display: flex; align-items: center; gap: 8px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .dashboard-card.pink-card { border-left-color: #193b7c; }
    .dashboard-card.orange-card { border-left-color: #c67903; }
    .dashboard-card.green-card { border-left-color: #047857; }
    .dashboard-card.blue-card { border-left-color: #009bd6; }
    .filters {
      display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center;
      background: #2c2f3f; padding: 15px; border-radius: 8px;
    }
    .filters > div { display: flex; flex-direction: column; gap: 4px; }
    .filters label {
      font-size: 13px; color: #ccc; font-weight: 500;
    }
    .filters input, .filters select {
      padding: 8px 12px; border-radius: 6px; border: 1px solid #444;
      min-width: 180px; background: #1e1e2f; color: white;
    }
    .filters input::placeholder { color: #666; }
    .filters input:focus, .filters select:focus { border-color: #009bd6; outline: none; }
    .graficos-grid {
      display: grid; 
      grid-template-columns: repeat(2, 1fr);
      gap: 30px; 
      margin: 25px 0;
    }
    .grafico-card {
      background: linear-gradient(145deg, #ffffff, #f8f9fc);
      padding: 24px 20px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(25, 59, 124, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
      min-height: 380px;
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      border: 1px solid rgba(25, 59, 124, 0.08);
      transition: all 0.3s ease;
    }
    .grafico-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(25, 59, 124, 0.18), 0 2px 8px rgba(0, 0, 0, 0.12);
    }
    .grafico-card canvas {
      flex: 1;
      width: 100% !important;
      height: 300px !important;
      max-height: 300px;
    }
    .grafico-card h4 { 
      color: #193b7c; 
      text-align: center; 
      margin-bottom: 18px; 
      font-size: 1.1em; 
      font-weight: 700;
      letter-spacing: -0.3px;
    }
    .expand-btn {
      position:absolute; top:13px; right:15px; border:none;
      background:transparent; color:#193b7c; cursor:pointer; font-size:20px; z-index:3;
      transition: color .19s;
    }
    .expand-btn:hover { color:#5271ff; }
    .modal-overlay {
      display:none; position:fixed; top:0;left:0;right:0;bottom:0;
      background:rgba(25,59,124,0.35);
      z-index:99999; /* elevar prioridade */
      align-items:center; justify-content:center;
      animation:fadeIn .25s;
      visibility:hidden; opacity:0;
    }
    .modal-overlay.active { display:flex; visibility:visible; opacity:1; }
    .modal-content {
      background:#fff; border-radius:18px; box-shadow:0 3px 32px #193b7c70;
      padding:26px 32px; max-width: 950px; width:90vw; min-width: 330px;
      display:flex; flex-direction:column; align-items:center; position:relative;
      animation:scalein .23s;
      opacity:1; visibility:visible;
    }
    .modal-close {
      position:absolute;top:14px;right:17px;font-size:22px;
      color:#193b7c; background:none;border:none;cursor:pointer;
    }
    .modal-content h4 {margin:0 0 19px 0;font-size:1.15em;}
    .modal-graph-canvas { width: 850px !important; height: 500px !important; max-width: 90vw; background: #fff;}
    @keyframes fadeIn { 0%{opacity:0;} 100%{opacity:1;} }
    @keyframes scalein { 0%{transform:scale(.89);} 100%{transform:scale(1);} }
    /* Importa√ß√£o CSV estilos */
    .upload-container {
      display: none;
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin: 15px 0;
      background: #f9f9f9;
      transition: all 0.3s ease;
    }
    .upload-container.dragover {
      border-color: #193b7c;
      background: #e0e8ff;
    }
    .file-info {
      margin-top: 10px;
      padding: 10px;
      background: #e8f4fd;
      border-radius: 5px;
      display: none;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 10px;
    }
    .spin {animation: spin 1s linear infinite;}
    @keyframes spin {from {transform: rotate(0deg);} to {transform: rotate(360deg);}}
    @media (max-width: 800px) {
      .dashboard-cards {flex-direction:column;}
      .graficos-grid {grid-template-columns:1fr;}
      .ranking-table-wrapper {padding:9px 2px;}
      .modal-content {padding:11px 3vw;}
    }
    
    /* Estilos para An√°lise de Estoque */
    .badge-status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge-suficiente {
      background: #d1f4e0;
      color: #193b7c ;
      border: 2px solid #2d5aa0 100%;
      font-weight: 700;
    }
    .badge-falta {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
      font-weight: 700;
    }
    .badge-sem-historico {
      background: #f1f5f9;
      color: #475569;
      border: 2px solid #94a3b8;
      font-weight: 600;
    }
    .tabela-analise-header {
      background: linear-gradient(135deg, #193b7c 0%, #2d5aa0 100%);
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .info-box {
      background: linear-gradient(135deg, #e8f0ff, #f0f7ff);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 4px solid #193b7c;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .info-item-label {
      font-size: 12px;
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .info-item-value {
      font-size: 24px;
      color: #193b7c;
      font-weight: 700;
    }
    .search-box {
      padding: 10px 16px;
      border: 2px solid #e0e6f0;
      border-radius: 8px;
      font-size: 14px;
      width: 300px;
      transition: all 0.3s;
    }
    .search-box:focus {
      outline: none;
      border-color: #193b7c;
      box-shadow: 0 0 0 3px rgba(25, 59, 124, 0.1);
    }
    .produto-row {
      transition: all 0.2s;
    }
    .produto-row:hover {
      background: #f8f9fc !important;
      transform: scale(1.01);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .vendas-historicas {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .vendas-ano {
      padding: 4px 8px;
      background: #e8f0fe;
      border: 1px solid #4285f4;
      border-radius: 6px;
      font-size: 13px;
      color: #1a73e8;
      font-weight: 600;
    }
    .vendas-media {
      padding: 6px 10px;
      background: #193b7c;
      color: white;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(61, 52, 168, 0.3);
    }
  </style>
</head>
<body>
  <nav id="sidebar-placeholder"></nav>  
  <section class="home">
    <div class="text">
      <h1>An√°lise de Vendas - Lubrificantes</h1>
      <p id="dynamic-title" style="color:#363739;font-weight:500;">Carregando...</p>
    </div>
    
    <!-- DASHBOARD CARDS -->
    <div class="dashboard-cards">
      <div class="dashboard-card pink-card">
        <h2 id="kpi-total-litros">0L</h2>
        <p><i data-lucide="droplet"></i> Total vendido em litros</p>
      </div>
      <div class="dashboard-card orange-card">
        <h2 id="kpi-total-vendas">0</h2>
        <p><i data-lucide="shopping-cart"></i> Unidades vendidas</p>
      </div>
      <div class="dashboard-card green-card">
        <h2 id="kpi-produto-top">-</h2>
        <p><i data-lucide="star"></i> Mais Vendido</p>
      </div>
      <div class="dashboard-card blue-card">
        <h2 id="kpi-top-filial">-</h2>
        <p><i data-lucide="award"></i> Maior participa√ß√£o nas vendas</p>
      </div>
    </div>
    
    <div class="content-card">
      <div class="content-card-header">
        <h3>An√°lise Avan√ßada</h3>
        <div class="header-actions">
          <!-- Bot√£o An√°lise de Estoque -->
          <button id="btn-analise-estoque" class="btn-acao" title="An√°lise de Estoque Atual">
            <i data-lucide="bar-chart-3"></i>
          </button>
          <!-- Bot√£o Estoque -->
          <button id="btn-estoque" class="btn-acao" title="Lan√ßar Estoque (CSV)">
            <i data-lucide="package"></i>
          </button>
          <!-- Bot√£o Importar CSV -->
          <button id="btn-importar" class="btn-acao" title="Importar CSV">
            <i data-lucide="upload"></i>
          </button>
          <!-- Bot√£o Metas Mensais -->
          <button id="btn-metas-mensais" class="btn-acao" title="Configurar Metas Mensais">
            <i data-lucide="target"></i>
          </button>
        </div>
      </div>
      <div class="content-card-body">
        <!-- √ÅREA DE UPLOAD (importa√ß√£o CSV) -->
        <div class="upload-container" id="upload-container">
          <i data-lucide="file-up" style="width: 48px; height: 48px; color: #193b7c; margin-bottom: 10px;"></i>
          <h4>Selecione o arquivo CSV</h4>
          <p>Arraste e solte o arquivo aqui ou clique para selecionar</p>
          <p style="font-size: 12px; color: #666; margin-top: 10px;">Formato esperado: CSV exportado do sistema</p>
          <input type="file" id="csv-file" accept=".csv" style="display: none;">
          <button class="btn-acao" style="margin-top: 15px;" id="btn-select-file">
            <i data-lucide="folder-open"></i>
            Selecionar Arquivo
          </button>
        </div>
        <div class="file-info" id="file-info">
          <i data-lucide="file-text"></i>
          <span id="file-name"></span>
          <span id="file-size"></span>
        </div>
        <div class="loading" id="loading">
          <i data-lucide="loader-2" class="spin"></i>
          <span>Processando arquivo...</span>
        </div>
        <!-- Input oculto para importa√ß√£o de estoque (m√∫ltiplos arquivos) -->
        <input type="file" id="csv-estoque-file" accept=".csv" style="display:none;" multiple>
        <!-- Input oculto para an√°lise de estoque -->
        <input type="file" id="csv-analise-estoque-file" accept=".csv" style="display:none;">
        <!-- FILTROS -->
        <div class="filters">
          <div>
            <label for="data-inicio">Data In√≠cio</label>
            <input type="date" id="data-inicio">
          </div>
          <div>
            <label for="data-fim">Data Fim</label>
            <input type="date" id="data-fim">
          </div>
          <div>
            <label for="filtro-filial">Filial</label>
            <select id="filtro-filial">
              <option value="">Todas as Filiais</option>
              <option value="2">Campos Novos</option>
              <option value="6">Rio do Sul</option>
              <option value="7">Lages</option>
            </select>
          </div>
          <div>
            <label for="filtro-produto">C√≥digo do Produto</label>
            <input type="text" id="filtro-produto" placeholder="Ex.: NH410H, 76176R61BR...">
          </div>
        </div>
        <!-- GR√ÅFICOS -->
        <div class="graficos-grid">
          <div class="grafico-card" id="bloco-grafico-filiais">
            <button type="button" class="expand-btn" data-grafico="graficoFiliais"><i data-lucide="maximize"></i></button>
            <h4>Filiais (Litros e Unidades)</h4>
            <canvas id="graficoFiliais"></canvas>
          </div>
          <div class="grafico-card" id="bloco-grafico-mensal">
            <button type="button" class="expand-btn" data-grafico="graficoMensal"><i data-lucide="maximize"></i></button>
            <h4>Evolu√ß√£o Mensal - Vendas</h4>
            <canvas id="graficoMensal"></canvas>
          </div>
          <div class="grafico-card" id="bloco-grafico-participacao">
            <button type="button" class="expand-btn" data-grafico="graficoParticipacaoFiliais"><i data-lucide="maximize"></i></button>
            <h4>Participa√ß√£o de Vendas por Filial (%)</h4>
            <canvas id="graficoParticipacaoFiliais"></canvas>
          </div>
          <div class="grafico-card" id="bloco-grafico-distribuicao">
            <button type="button" class="expand-btn" data-grafico="graficoDistribuicao"><i data-lucide="maximize"></i></button>
            <h4>Distribui√ß√£o por Tipo Produto</h4>
            <canvas id="graficoDistribuicao"></canvas>
          </div>
          <div class="grafico-card" id="bloco-grafico-original-fleetpro" style="grid-column: span 2;">
            <button type="button" class="expand-btn" data-grafico="graficoOriginalFleetpro"><i data-lucide="maximize"></i></button>
            <h4>üì¶ Estoque Mensal: Genu√≠no | FleetPro </h4>
            <canvas id="graficoOriginalFleetpro"></canvas>
          </div>
        </div>
        
        <!-- SE√á√ÉO DE AN√ÅLISE DE ESTOQUE -->
        <div id="secao-analise-estoque" style="display:none; margin-top:30px;">
          <div style="background:#fff; padding:24px; border-radius:16px; box-shadow:0 4px 20px rgba(25,59,124,0.12);">
            <div class="tabela-analise-header">
              <div style="display:flex; align-items:center; gap:12px;">
                <i data-lucide="trending-up" style="width:28px;height:28px;color:white;"></i>
                <div>
                  <h3 style="color:white; margin:0; font-size:1.3em;">An√°lise Comparativa de Estoque</h3>
                  <p style="color:#e8f0ff; margin:4px 0 0 0; font-size:0.9em;">Compara√ß√£o com vendas de <span id="ano-comparacao">2024 e 2025</span></p>
                </div>
              </div>
              <div style="display:flex; gap:10px; align-items:center;">
                <input 
                  type="text" 
                  id="search-analise" 
                  class="search-box" 
                  placeholder="üîç Buscar produto..."
                  style="background:white;"
                />
                <button id="btn-fechar-analise" class="btn-acao" style="background:#dc3545; padding:10px 16px;" title="Fechar">
                  <i data-lucide="x"></i>
                </button>
              </div>
            </div>
            
            <div class="info-box" id="info-totalizadores">
              <div class="info-item">
                <span class="info-item-label">üì¶ Total de Produtos</span>
                <span class="info-item-value" id="total-produtos">0</span>
              </div>
              <div class="info-item">
                <span class="info-item-label">‚úÖ Estoque Suficiente</span>
                <span class="info-item-value" id="total-suficiente" style="color:#28a745;">0</span>
              </div>
              <div class="info-item">
                <span class="info-item-label">‚ö†Ô∏è Estoque Insuficiente</span>
                <span class="info-item-value" id="total-falta" style="color:#dc3545;">0</span>
              </div>
              <div class="info-item">
                <span class="info-item-label">‚ö™ Sem Hist√≥rico</span>
                <span class="info-item-value" id="total-sem-historico" style="color:#999;">0</span>
              </div>
            </div>
            
            <div style="max-height:600px; overflow-y:auto; border-radius:12px; border:1px solid #e0e6f0;">
              <table id="tabela-analise-estoque" style="width:100%; border-collapse:collapse;">
                <thead style="position:sticky; top:0; background:linear-gradient(135deg, #193b7c 0%, #2d5aa0 100%); color:#fff; z-index:10;">
                  <tr>
                    <th style="padding:16px 20px; text-align:left; font-weight:700; font-size:0.95em;">Produto</th>
                    <th style="padding:16px 20px; text-align:center; font-weight:700; font-size:0.95em;">Estoque (L)</th>
                    <th style="padding:16px 20px; text-align:center; font-weight:700; font-size:0.95em;">Estoque (Und)</th>
                    <th style="padding:16px 20px; text-align:center; font-weight:700; font-size:0.95em;">Vendas Hist√≥ricas</th>
                    <th style="padding:16px 20px; text-align:center; font-weight:700; font-size:0.95em;">Estimativa</th>
                    <th style="padding:16px 20px; text-align:center; font-weight:700; font-size:0.95em;">Status</th>
                  </tr>
                </thead>
                <tbody id="corpo-tabela-analise">
                  <tr>
                    <td colspan="6" style="text-align:center; padding:60px; color:#999;">
                      <i data-lucide="inbox" style="width:48px;height:48px;margin-bottom:10px;"></i><br>
                      <strong>Nenhuma an√°lise dispon√≠vel</strong><br>
                      <small>Importe um arquivo CSV de estoque para come√ßar</small>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- MODAL EXPAND -->
        <div class="modal-overlay" id="modalOverlay">
          <div class="modal-content">
            <button type="button" class="modal-close" id="modalClose" title="Fechar">&times;</button>
            <h4 id="modalTitle"></h4>
            <canvas id="modalGraph" class="modal-graph-canvas"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>
  <script type="module">
    import { garantirAutenticacao } from '/assets/js/auth-guard.js';
    import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, query, where, Timestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // Testar acesso aos imports Firebase
    console.log('[Init] Testando acesso a Firebase...');
    console.log('[Init] getFirestore dispon√≠vel?', typeof getFirestore === 'function');
    console.log('[Init] getApp dispon√≠vel?', typeof getApp === 'function');
    console.log('[Init] collection dispon√≠vel?', typeof collection === 'function');
    console.log('[Init] getDocs dispon√≠vel?', typeof getDocs === 'function');
    
    const FILIAIS = ['2', '6', '7'];
    const NOMES_FILIAIS = { '2': 'Campos Novos', '6': 'Rio do Sul', '7': 'Lages' };
    let dadosCompletos=[], charts={}, chartsOpts={};
    let estoqueMensal = {}; // { 'YYYY-MM': { litrosTotal, litrosFleetpro, updatedAt } }
    let userData;

    // ========== METAS FIREBASE ==========
    const METAS_KEY = 'metas_lubrificantes_filiais';
    const filiaisMeta = [
      { id: '2', nome: 'Campos Novos' },
      { id: '6', nome: 'Rio do Sul' },
      { id: '7', nome: 'Lages' }
    ];
    
    const METAS_MENSAIS_KEY = 'lubri_metas_mensais';
    
    // Cache local para metas
    let metasFixasCache = {};
    let metasMensaisCache = {};
    
    // ID da filial Lages corrigido para '7' (consistente com FILIAIS)
    
    // Firebase - Metas Fixas
    async function getMetasFirebase() {
      try {
        console.log('[getMetasFirebase] Iniciando carregamento...');
        console.log('[getMetasFirebase] typeof getFirestore:', typeof getFirestore);
        const db = getFirestore(getApp());
        console.log('[getMetasFirebase] DB conectado:', db);
        const docSnap = await getDocs(collection(db, 'metasLubrificantes'));
        metasFixasCache = {};
        docSnap.forEach(doc => {
          const id = doc.id;
          const data = doc.data();
          metasFixasCache[id] = data.valor || 0;
        });
        console.log('[getMetasFirebase] Metas carregadas:', metasFixasCache);
        return metasFixasCache;
      } catch (e) {
        console.error('[getMetasFirebase] Erro:', e);
        return metasFixasCache;
      }
    }
    
    async function salvarMetasFirebase(metas) {
      try {
        console.log('[salvarMetasFirebase] Iniciando salvamento de:', metas);
        const db = getFirestore(getApp());
        for (const [filialId, valor] of Object.entries(metas)) {
          await setDoc(doc(db, 'metasLubrificantes', filialId), {
            filialId: filialId,
            valor: Number(valor) || 0,
            atualizadoEm: Timestamp.now()
          }, { merge: true });
        }
        metasFixasCache = metas;
        console.log('[salvarMetasFirebase] Salvo com sucesso!');
        return true;
      } catch (e) {
        console.error('[salvarMetasFirebase] Erro:', e);
        Swal.fire('Erro', 'Falha ao salvar metas: ' + e.message, 'error');
        return false;
      }
    }
    
    // Firebase - Metas Mensais
    async function getMetasMensaisFirebase() {
      try {
        const db = getFirestore(getApp());
        const docSnap = await getDocs(collection(db, 'metasMensaisLubrificantes'));
        metasMensaisCache = {};
        docSnap.forEach(doc => {
          const data = doc.data();
          metasMensaisCache[doc.id] = data.filiais || {};
        });
        return metasMensaisCache;
      } catch (e) {
        console.error('Erro ao carregar metas mensais do Firebase:', e);
        return metasMensaisCache;
      }
    }
    
    async function salvarMetasMensaisFirebase(metas) {
      try {
        console.log('[salvarMetasMensaisFirebase] Iniciando salvamento de:', metas);
        const db = getFirestore(getApp());
        for (const [mesAno, filiais] of Object.entries(metas)) {
          await setDoc(doc(db, 'metasMensaisLubrificantes', mesAno), {
            mesAno: mesAno,
            filiais: filiais,
            atualizadoEm: Timestamp.now()
          }, { merge: true });
        }
        metasMensaisCache = metas;
        console.log('[salvarMetasMensaisFirebase] Salvo com sucesso!');
        return true;
      } catch (e) {
        console.error('[salvarMetasMensaisFirebase] Erro:', e);
        return false;
      }
    }
    
    // Fallbacks para localStorage (compatibilidade)
    function getMetasStorage() {
      return metasFixasCache || {};
    }
    function setMetasStorage(metas) {
      metasFixasCache = metas;
    }
    
    function getMetasMensaisStorage() {
      return metasMensaisCache || {};
    }
    function setMetasMensaisStorage(metas) {
      metasMensaisCache = metas;
    }
    
    function getMetaParaMes(ano, mes, filialId) {
      const chave = `${ano}-${String(mes).padStart(2, '0')}`;
      if (metasMensaisCache[chave] && metasMensaisCache[chave][filialId] !== undefined) {
        return Number(metasMensaisCache[chave][filialId]);
      }
      return Number(metasFixasCache[filialId] || 0);
    }
    // ===================================

    // Convers√£o de volume por c√≥digo com tipo de produto (Op√ß√£o 1: Unified Object)
    const conversaoLubrificantes = {
      '81153R61BR': { litros: 20, tipo: 'Transmiss√£o' },
      '74514R61BR': { litros: 20, tipo: 'Motor' },
      '76176R61BR': { litros: 20, tipo: 'Transmiss√£o' },
      '76486R61BR': { litros: 20, tipo: 'Hidr√°ulico' },
      '81053R61BR': { litros: 20, tipo: 'Transmiss√£o' },
      'NH330G*': { litros: 20, tipo: 'Motor' },
      'NH410B*': { litros: 20, tipo: 'Transmiss√£o' },
      'MS1216': { litros: 20, tipo: 'Hidr√°ulico' },
      '76175R61BR': { litros: 20, tipo: 'Transmiss√£o' },
      '81048R61BR': { litros: 20, tipo: 'Hidr√°ulico' },
      '81157R61BR': { litros: 20, tipo: 'Hidr√°ulico' },
      '81232R41BR': { litros: 20, tipo: 'Graxa' },
      'MAT3505': { litros: 20, tipo: 'Transmiss√£o' },
      'MAT3521': { litros: 20, tipo: 'Motor' },
      'NH410H': { litros: 20, tipo: 'Transmiss√£o' },
      'NH646A': { litros: 20, tipo: 'Freio' },
      'NH668': { litros: 20, tipo: 'Hidr√°ulico' },
      'NH668SP': { litros: 20, tipo: 'Hidr√°ulico' },
      '74514K13BR': { litros: 4, tipo: 'Motor' },
      '76176K13BR': { litros: 4, tipo: 'Transmiss√£o' },
      'NH410B4L': { litros: 4, tipo: 'Transmiss√£o' },
      '81053K13BR': { litros: 4, tipo: 'Transmiss√£o' },
      '76486K13BR': { litros: 4, tipo: 'Hidr√°ulico' },
      '77412K13BR': { litros: 4, tipo: 'Arrefecimento' },
      '81048E19BR': { litros: 1, tipo: 'Hidr√°ulico' },
      'NH610A': { litros: 1, tipo: 'Freio' },
      '77409E19BR': { litros: 1, tipo: 'Freio' },
      '71104731': { litros: 1, tipo: 'Tratamento' },
      '81050E19BR': { litros: 1, tipo: 'Hidr√°ulico' },
      'NH632': { litros: 1, tipo: 'Hidr√°ulico' },
      'NH710AL': { litros: 1, tipo: 'Graxa' },
      'NH800SE': { litros: 1, tipo: 'Motor' },
      'NH800A': { litros: 0.5, tipo: 'Freio' },
      'MAT355510K': { litros: 10, tipo: 'Graxa' },
      '76486251BRSP': { litros: 200, tipo: 'Hidr√°ulico' },
      '76176251BRSP': { litros: 200, tipo: 'Transmiss√£o' },
      'default': { litros: 1, tipo: 'Outros' }
    };

    // ==== MAPEAMENTO DE C√ìDIGOS EQUIVALENTES ====
    // Produtos que mudaram de c√≥digo ao longo do tempo
    // Cada array cont√©m c√≥digos que representam o mesmo produto
    const codigosEquivalentes = [
      ['76176R61BR', 'NH410B'],     // Transmiss√£o 20L - c√≥digo novo e antigo
      ['76176K13BR', 'NH410B4L'],   // Transmiss√£o 4L - c√≥digo novo e antigo
      ['74514R61BR', 'NH330H'],     // Motor 20L - c√≥digo novo e antigo
      ['74514K13BR', 'NH330H4L'],   // Motor 4L - c√≥digo novo e antigo
      ['76486R61BR', 'NH668'],      // Hidr√°ulico 20L - c√≥digo novo e antigo
      ['76486K13BR', 'NH6684L'],    // Hidr√°ulico 4L - c√≥digo novo e antigo
      ['81153R61BR', 'NH410B*'],    // Transmiss√£o 20L - c√≥digo novo e antigo
      ['71939R61BR', 'NH330G*'],    // 
      ['81048R61BR', 'NH520A'],     // 
      ['81050E19BR', 'NH520AL'],    //
      ['76175R61BR', 'MAT3505'],    //
      ['81053K13BR', 'NH410H4L'],   //
      ['81053R61BR', 'NH410H'],     // 
      ['81050E19BR', 'NH140BR'],    //
      ['81232R41BR', 'MAT3555'],    //
      ['77412K13BR', 'MAT3724'],    //
      ['81048E19BR', 'NH520AL'],    //
      ['77409E19BR', 'NH610A'],     //
      ['81157R61BR', 'NH668*'],     //
      
      ];

    // Mapa reverso para busca r√°pida: qualquer c√≥digo -> array com todos equivalentes
    const mapaEquivalentes = {};
    codigosEquivalentes.forEach(grupo => {
      grupo.forEach(codigo => {
        mapaEquivalentes[codigo.toUpperCase()] = grupo.map(c => c.toUpperCase());
      });
    });

    function obterCodigosEquivalentes(codigo) {
      const codigoUpper = (codigo || '').toUpperCase();
      return mapaEquivalentes[codigoUpper] || [codigoUpper];
    }

    // Heur√≠stica de convers√£o para itens n√£o mapeados: tenta extrair volume e tipo do texto
    function obterLitrosPorUnidade(codProduto, descricao='', grupo='') {
      // 1) Mapa conhecido
      if (conversaoLubrificantes[codProduto] !== undefined) return conversaoLubrificantes[codProduto];

      const txt = `${descricao} ${grupo}`.toLowerCase();
      // 2) ML -> L
      const mlMatch = txt.match(/(\d{2,4})(?:\s)?ml\b/);
      if (mlMatch) {
        const ml = parseFloat(mlMatch[1].replace(',', '.'));
        if (!isNaN(ml)) return { litros: +(ml/1000).toFixed(3), tipo: inferirTipo(txt) };
      }
      // 3) Litros expl√≠citos
      const lMatch = txt.match(/(\d{1,3}(?:[\.,]\d{1,2})?)\s?(?:l|litro|litros)\b/);
      if (lMatch) {
        const val = parseFloat(lMatch[1].replace(',', '.'));
        if (!isNaN(val)) return { litros: val, tipo: inferirTipo(txt) };
      }
      // 4) Sufixos comuns tipo "20L" sem espa√ßo
      const lxMatch = txt.match(/(\d{1,3})(?:l)\b/);
      if (lxMatch) {
        const val = parseFloat(lxMatch[1]);
        if (!isNaN(val)) return { litros: val, tipo: inferirTipo(txt) };
      }
      // 5) Itens em KG (graxa) n√£o convertem para litros
      if (/\bkg\b/.test(txt)) return { litros: 0, tipo: 'Outros' };
      // 6) Padr√£o
      return conversaoLubrificantes['default'];
    }
    
    // Fun√ß√£o auxiliar para inferir tipo de produto a partir da descri√ß√£o
    function inferirTipo(descricao='') {
      const txt = (descricao || '').toLowerCase();
      if (/graxa|grease|nlgi/.test(txt)) return 'Graxa';
      if (/motor|multi-g|15w40|15w30|multigrade/.test(txt)) return 'Motor';
      if (/transmiss|thf|gear|cambio/.test(txt)) return 'Transmiss√£o';
      if (/hidraul|hydraulic|hfa|hfb/.test(txt)) return 'Hidr√°ulico';
      if (/freio|break|brakes/.test(txt)) return 'Freio';
      return 'Outros';
    }

    // ==== CONTROLE DE ESTOQUE ====
    let dadosEstoque = [];

    /**
     * Processa m√∫ltiplos arquivos CSV de estoque (um por filial)
     * Formato esperado (separado por ponto-e-v√≠rgula):
     * - Coluna 0: Filial (2, 6 ou 7)
     * - Coluna 2: C√≥digo do Produto
     * - Coluna 3: Descri√ß√£o
     * - Coluna 4: Grupo
     * - Coluna 5: Descri√ß√£o do Grupo
     * - Coluna 6: Prateleira
     * - Coluna 11: Estoque Fiscal (quantidade)
     * - Coluna 12: Valor do Estoque
     * M√≠nimo de 13 colunas por linha
     */
    async function processarCSVEstoque(files) {
      // Converter FileList para Array
      const arquivos = Array.from(files);
      
      if (arquivos.length === 0) {
        Swal.fire('Erro!', 'Nenhum arquivo selecionado.', 'error');
        return;
      }
      
      // Mostrar loading
      Swal.fire({
        title: 'Processando Estoque...',
        html: `<p>Consolidando <strong>${arquivos.length}</strong> arquivo(s)</p><p>Aguarde...</p>`,
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });
      
      // Detectar automaticamente o m√™s atual
      const hoje = new Date();
      const mesRef = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
      const mesesNomes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      const nomeMesAtual = mesesNomes[hoje.getMonth()];
      
      console.log(`[Estoque] Lan√ßando estoque para: ${nomeMesAtual}/${hoje.getFullYear()} (${mesRef})`);
      console.log(`[Estoque] Processando ${arquivos.length} arquivo(s): ${arquivos.map(f => f.name).join(', ')}`);
      
      // Acumuladores consolidados das 3 filiais
      let litrosTotal = 0;
      let litrosFleetpro = 0;
      let litrosOriginal = 0;
      const porFilial = { 
        '2': { litrosTotal: 0, litrosFleetpro: 0, litrosOriginal: 0 }, 
        '6': { litrosTotal: 0, litrosFleetpro: 0, litrosOriginal: 0 }, 
        '7': { litrosTotal: 0, litrosFleetpro: 0, litrosOriginal: 0 } 
      };
      
      let linhasProcessadasTotal = 0;
      let linhasInvalidasTotal = 0;
      const filiaisProcessadas = new Set();
      
      // Processar cada arquivo
      for (const file of arquivos) {
        try {
          const csvData = await lerArquivoCSV(file);
          const resultado = processarConteudoCSVEstoque(csvData, porFilial);
          
          linhasProcessadasTotal += resultado.linhasProcessadas;
          linhasInvalidasTotal += resultado.linhasInvalidas;
          resultado.filiaisEncontradas.forEach(f => filiaisProcessadas.add(f));
          
          console.log(`[Estoque] Arquivo ${file.name}: ${resultado.linhasProcessadas} linhas processadas`);
        } catch (error) {
          console.error(`[Estoque] Erro ao processar ${file.name}:`, error);
        }
      }
      
      // Somar totais consolidados
      FILIAIS.forEach(f => {
        litrosTotal += porFilial[f].litrosTotal;
        litrosFleetpro += porFilial[f].litrosFleetpro;
        litrosOriginal += porFilial[f].litrosOriginal;
      });
      
      if (litrosTotal === 0 && litrosFleetpro === 0 && litrosOriginal === 0) {
        Swal.fire('Aviso!', 'Nenhum dado v√°lido encontrado nos arquivos CSV de estoque.', 'warning');
        return;
      }
      
      // Salvar no Firebase
      try {
        await setDoc(doc(getFirestore(getApp()), 'estoqueMensalLubrificantes', mesRef), {
          mes: mesRef,
          litrosTotal,
          litrosFleetpro,
          litrosOriginal,
          porFilial,
          atualizadoEm: Timestamp.now()
        }, { merge: true });
        
        console.log(`[Estoque] Consolidado salvo: Total=${litrosTotal}L, Original(301)=${litrosOriginal}L, FleetPro(303)=${litrosFleetpro}L`);
        
        // Recarregar e atualizar
        await carregarEstoqueMensal();
        analisarDashboard();
        
        // Mostrar sucesso
        const filiaisNomes = Array.from(filiaisProcessadas).map(f => NOMES_FILIAIS[f] || f).join(', ');
        
        Swal.fire({
          icon: 'success',
          title: `Estoque ${nomeMesAtual}/${hoje.getFullYear()} Salvo!`,
          html: `
            <div style="text-align:left; margin-top:10px;">
              <p><strong>üìÅ Arquivos processados:</strong> ${arquivos.length}</p>
              <p><strong>üè¢ Filiais:</strong> ${filiaisNomes || 'Nenhuma identificada'}</p>
              <hr style="margin:10px 0;">
              <p><strong>Total Geral:</strong> ${litrosTotal.toLocaleString()}L</p>
              <p><strong>Original (301):</strong> ${litrosOriginal.toLocaleString()}L</p>
              <p><strong>FleetPro (303):</strong> ${litrosFleetpro.toLocaleString()}L</p>
              <hr style="margin:10px 0;">
              <small>${linhasProcessadasTotal} linhas processadas</small>
            </div>
          `,
          confirmButtonColor: '#193b7c'
        });
      } catch (error) {
        console.error('Erro ao salvar estoque:', error);
        Swal.fire('Erro!', 'Falha ao salvar no Firebase: ' + error.message, 'error');
      }
    }
    
    // Fun√ß√£o auxiliar para ler arquivo como texto
    function lerArquivoCSV(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(e);
        reader.readAsText(file, 'UTF-8');
      });
    }
    
    // Fun√ß√£o para processar conte√∫do de um CSV de estoque
    function processarConteudoCSVEstoque(csvData, porFilial) {
      const resultado = {
        linhasProcessadas: 0,
        linhasInvalidas: 0,
        filiaisEncontradas: new Set()
      };
      
      if (!csvData || csvData.trim().length === 0) {
        return resultado;
      }
      
      const linhas = csvData.split('\n').filter(linha => linha.trim() !== '');
      
      if (linhas.length < 2) {
        return resultado;
      }
      
      // Pular primeira linha (cabe√ßalho)
      for (let i = 1; i < linhas.length; i++) {
        const linha = linhas[i].trim();
        if (!linha || linha.startsWith('TOTAL')) continue;
        
        const colunas = linha.split(';');
        
        if (colunas.length < 13) {
          resultado.linhasInvalidas++;
          continue;
        }
        
        const filial = colunas[0]?.trim();
        const codProduto = colunas[2]?.trim();
        const descricao = colunas[3]?.trim();
        const grupo = colunas[4]?.trim();
        const descGrupo = colunas[5]?.trim();
        const fiscal = parseInt(colunas[11]?.trim()) || 0;
        
        if (!codProduto || fiscal === 0) {
          resultado.linhasInvalidas++;
          continue;
        }
        if (!FILIAIS.includes(filial)) {
          resultado.linhasInvalidas++;
          continue;
        }
        
        resultado.linhasProcessadas++;
        resultado.filiaisEncontradas.add(filial);
        
        // Calcular litros
        const conversoesInfo = obterLitrosPorUnidade(codProduto, descricao, descGrupo);
        const litrosPorUnidade = conversoesInfo.litros;
        const totalLitros = fiscal * litrosPorUnidade;
        
        // Considera "√≥leo" se mencionar lubrificante/√≥leo
        const ehOleo = /(oleo|√≥leo|lubrificante|oil)/i.test(`${descricao} ${descGrupo}`) && !/(graxa|grease)/i.test(`${descricao} ${descGrupo}`);
        if (ehOleo) {
          porFilial[filial].litrosTotal += totalLitros;
        }
        
        // Detectar FleetPro (grupo 303) ou Original (grupo 301)
        const grupoNum = grupo ? grupo.trim() : '';
        const ehFleetpro = grupoNum === '303' || /fleetpro/i.test(descricao) || /fleetpro/i.test(descGrupo);
        const ehOriginal = grupoNum === '301' || (!ehFleetpro && /original|√≥leo lubrificante/i.test(descGrupo));
        
        if (ehFleetpro) {
          porFilial[filial].litrosFleetpro += totalLitros;
        }
        if (ehOriginal) {
          porFilial[filial].litrosOriginal += totalLitros;
        }
      }
      
      return resultado;
    }
    
    async function carregarEstoqueMensal() {
      try {
        const app = getApp();
        const db = getFirestore(app);
        const snap = await getDocs(collection(db, 'estoqueMensalLubrificantes'));
        estoqueMensal = {};
        snap.forEach(docSnap => {
          const d = docSnap.data();
          estoqueMensal[d.mes] = {
            litrosTotal: Number(d.litrosTotal)||0,
            litrosFleetpro: Number(d.litrosFleetpro)||0,
            litrosOriginal: Number(d.litrosOriginal)||0,
            porFilial: d.porFilial || {},
            updatedAt: d.atualizadoEm
          };
        });
        console.log('[Estoque] Estoque mensal carregado:', Object.keys(estoqueMensal).length, 'meses');
      } catch (e) {
        console.error('Erro ao carregar estoque mensal:', e);
      }
    }

    // ==== IMPORTA√á√ÉO DE ARQUIVO CSV VENDAS, SALVAR FIREBASE E RECARREGAR BOARD ====
    function exibirInfoArquivo(file) {
      const fileInfo = document.getElementById('file-info');
      const loading = document.getElementById('loading');
      fileInfo.style.display = 'block';
      loading.style.display = 'block';
      document.getElementById('file-name').textContent = file.name;
      document.getElementById('file-size').textContent = ` (${(file.size / 1024).toFixed(2)} KB)`;
      const uploadIcon = document.querySelector('#btn-importar i');
      if (uploadIcon) {
        uploadIcon.setAttribute('data-lucide', 'loader-2');
        uploadIcon.classList.add('spin');
        lucide.createIcons();
      }
    }

    async function salvarDadosFirebase(dadosProcessados) {
      try {
        let salvosCount = 0;
        let duplicatasCount = 0;
        const app = getApp();
        const db = getFirestore(app);
        
        // OTIMIZA√á√ÉO: Verificar duplicatas no frontend usando dados j√° carregados
        const chavesExistentes = new Set(
          dadosCompletos.map(d => `${d.filial}_${d.data}_${d.numeroNF}_${d.codProduto}`)
        );
        
        console.log(`[salvarDados] Verificando ${dadosProcessados.length} registros contra ${chavesExistentes.size} existentes`);
        
        // Batch writes para melhor performance
        const batch = [];
        
        for (const item of dadosProcessados) {
          if (FILIAIS.includes(item.filial)) {
            const chaveUnica = `${item.filial}_${item.data}_${item.numeroNF}_${item.codProduto}`;
            
            // Verificar duplicata no cache local (SEM query Firebase)
            if (!chavesExistentes.has(chaveUnica)) {
              const dadosParaSalvar = {
                filial: item.filial,
                data: item.data,
                dataYYYYMMDD: ddmmaaaaToYyyymmdd(item.data), // Para filtros r√°pidos
                grupo: item.grupo || '',
                numeroNF: item.numeroNF,
                codProduto: item.codProduto,
                descricao: item.descricao,
                quantNF: item.quantNF,
                unidadeNF: item.unidadeNF,
                quantConvertida: item.quantConvertida,
                unidade: item.unidade,
                litros: item.litros,
                totalLitros: item.totalLitros,
                chaveUnica: chaveUnica,
                usuarioImportacao: userData?.nome || userData?.email || '',
                dataImportacao: Timestamp.now(),
                timestamp: Timestamp.now()
              };
              
              batch.push(dadosParaSalvar);
              chavesExistentes.add(chaveUnica); // Adicionar ao cache
              salvosCount++;
            } else {
              duplicatasCount++;
            }
          }
        }
        
        // Salvar em lote (mais eficiente)
        for (const dados of batch) {
          await addDoc(collection(db, "relatorioLubrificantes"), dados);
        }
        
        if (duplicatasCount > 0) {
          console.log(`‚ÑπÔ∏è ${duplicatasCount} registro(s) duplicado(s) ignorado(s) (valida√ß√£o local)`);
        }
        
        return { salvos: salvosCount, duplicatas: duplicatasCount };
      } catch (error) {
        console.error('‚ùå Erro ao salvar:', error);
        throw error;
      }
    }

    /**
     * Processa arquivo CSV de vendas
     * Formato esperado (separado por ponto-e-v√≠rgula):
     * - Coluna 0: Filial (2, 6 ou 7)
     * - Coluna 1: Data (DD/MM/AAAA)
     * - Coluna 2: Grupo
     * - Coluna 3: N√∫mero NF
     * - Coluna 4: C√≥digo do Produto
     * - Coluna 5: Descri√ß√£o
     * - Coluna 6: Quantidade NF
     * - Coluna 7: Unidade NF
     * - Coluna 8: Quantidade Convertida
     * - Coluna 9: Unidade
     * M√≠nimo de 10 colunas por linha
     * Cabe√ßalho deve conter: 'Filial', 'Data', 'Descri'
     */
    async function processarCSV(file) {
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const csvData = e.target.result;
          
          // Validar se o CSV n√£o est√° vazio
          if (!csvData || csvData.trim().length === 0) {
            Swal.fire('Erro!', 'O arquivo CSV est√° vazio.', 'error');
            document.getElementById('loading').style.display = 'none';
            return;
          }
          
          const linhas = csvData.split('\n').filter(linha => linha.trim() !== '');
          
          // Validar se h√° linhas suficientes
          if (linhas.length < 2) {
            Swal.fire('Erro!', 'O arquivo CSV deve conter pelo menos um cabe√ßalho e uma linha de dados.', 'error');
            document.getElementById('loading').style.display = 'none';
            return;
          }
          
          const dadosProcessados = [];
          let linhasProcessadas = 0;
          let linhasInvalidas = 0;
          
          // Encontrar cabe√ßalho
          let cabecalhoIndex = -1;
          for (let i = 0; i < linhas.length; i++) {
            if (linhas[i].includes('Filial') && linhas[i].includes('Data') && linhas[i].includes('Descri')) {
              cabecalhoIndex = i; break;
            }
          }
          if (cabecalhoIndex === -1) {
            Swal.fire({
              icon: 'error',
              title: 'Erro!',
              html: 'Cabe√ßalho do CSV n√£o encontrado.<br><small>Esperado: colunas contendo "Filial", "Data" e "Descri"</small>',
            });
            document.getElementById('loading').style.display = 'none';
            return;
          }
          
          // Processar linhas
          for (let i = cabecalhoIndex + 1; i < linhas.length; i++) {
            const linha = linhas[i].trim();
            if (!linha || linha.includes('Total Convertido') || linha.startsWith(';;;;')) continue;
            const colunas = linha.split(';').map(col => col.trim());
            
            // Validar n√∫mero m√≠nimo de colunas
            if (colunas.length < 6) {
              linhasInvalidas++;
              console.warn(`Linha ${i + 1} ignorada: n√∫mero insuficiente de colunas (${colunas.length} de 6+ esperadas)`);
              continue;
            }
            
            // Validar dados essenciais
            if (colunas.length >= 6 && colunas[0] && !isNaN(colunas[0]) && colunas[4]) {
              const item = {
                filial: colunas[0] || '',
                data: colunas[1] || '',
                grupo: colunas[2] || '',
                numeroNF: colunas[3] || '',
                codProduto: colunas[4] || '',
                descricao: colunas[5] || '',
                quantNF: parseFloat(colunas[6]?.replace(',', '.')) || parseFloat(colunas[6]) || 0,
                unidadeNF: colunas[7] || '',
                quantConvertida: parseFloat(colunas[8]?.replace(',', '.')) || parseFloat(colunas[8]) || 0,
                unidade: colunas[9] || ''
              };
              // Calcular litros usando fun√ß√£o de convers√£o unificada
              const conversoesInfo = obterLitrosPorUnidade(item.codProduto, item.descricao, item.grupo);
              item.litros = conversoesInfo.litros;
              item.totalLitros = item.quantConvertida * item.litros;
              
              if (FILIAIS.includes(item.filial)) {
                dadosProcessados.push(item);
                linhasProcessadas++;
              } else {
                linhasInvalidas++;
              }
            } else {
              linhasInvalidas++;
            }
          }
          
          // Log de processamento
          console.log(`CSV Vendas: ${linhasProcessadas} linhas processadas, ${linhasInvalidas} linhas inv√°lidas`);
          
          if (dadosProcessados.length === 0) {
            let mensagem = 'Nenhum dado v√°lido encontrado para as filiais 2, 6 ou 7.';
            if (linhasInvalidas > 0) {
              mensagem += ` ${linhasInvalidas} linha(s) foram ignoradas por estarem incompletas ou inv√°lidas.`;
            }
            Swal.fire('Aviso!', mensagem, 'warning');
            document.getElementById('loading').style.display = 'none';
            return;
          }
          const resultado = await salvarDadosFirebase(dadosProcessados);
          document.getElementById('loading').style.display = 'none';
          document.getElementById('upload-container').style.display = 'none';
          const uploadIcon = document.querySelector('#btn-importar i');
          if (uploadIcon) {
            uploadIcon.setAttribute('data-lucide', 'check-circle');
            uploadIcon.classList.remove('spin');
            lucide.createIcons();
          }
          
          // Mensagem com detalhes de salvos e duplicatas
          let mensagem = `${resultado.salvos} registro(s) importado(s) com sucesso!`;
          if (resultado.duplicatas > 0) {
            mensagem += `\n${resultado.duplicatas} registro(s) duplicado(s) foram ignorados.`;
          }
          if (linhasInvalidas > 0) {
            mensagem += `\n${linhasInvalidas} linha(s) inv√°lidas foram ignoradas.`;
          }
          
          Swal.fire({
            icon: resultado.salvos > 0 ? 'success' : 'info',
            title: 'Importa√ß√£o Conclu√≠da',
            text: mensagem,
            showConfirmButton: true,
            timer: resultado.duplicatas > 0 || linhasInvalidas > 0 ? 5000 : 3000
          });
          await carregarDados();
          analisarDashboard();
        } catch (error) {
          console.error('Erro ao processar CSV vendas:', error);
          document.getElementById('loading').style.display = 'none';
          let mensagemErro = 'Falha ao processar o arquivo CSV.';
          if (error.message) {
            mensagemErro += ' Detalhes: ' + error.message;
          }
          Swal.fire('Erro!', mensagemErro, 'error');
        }
      };
      reader.onerror = function(error) {
        console.error('Erro ao ler arquivo CSV vendas:', error);
        document.getElementById('loading').style.display = 'none';
        Swal.fire('Erro!', 'Falha ao ler o arquivo CSV. Verifique se o arquivo est√° corrompido.', 'error');
      };
      // Tentar UTF-8 primeiro, com fallback para ISO-8859-1 se necess√°rio
      try {
        reader.readAsText(file, 'UTF-8');
      } catch (e) {
        console.warn('Falha ao ler como UTF-8, tentando ISO-8859-1');
        reader.readAsText(file, 'ISO-8859-1');
      }
    }
    // ---

    function ddmmaaaaToYyyymmdd(dataStr) {
      if (!dataStr) return "";
      if (dataStr.length === 10 && dataStr.includes('/')) {
        const [dd, mm, yyyy] = dataStr.split('/');
        return `${yyyy}-${mm}-${dd}`;
      }
      return dataStr; // Retornar como est√° se j√° estiver em YYYY-MM-DD
    }

    function setDatasPadrao() {
      const hoje = new Date();
      const primeiro = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      document.getElementById('data-inicio').value = primeiro.toISOString().split('T')[0];
      document.getElementById('data-fim').value = hoje.toISOString().split('T')[0];
    }

    async function carregarDados() {
      const app = getApp();
      const db = getFirestore(app);
      
      // OTIMIZA√á√ÉO: Filtro de 2 anos ser√° feito no frontend (dados antigos n√£o t√™m dataYYYYMMDD)
      const doisAnosAtras = new Date();
      doisAnosAtras.setFullYear(doisAnosAtras.getFullYear() - 2);
      const dataLimite = doisAnosAtras.toISOString().split('T')[0]; // YYYY-MM-DD
      
      console.log(`[carregarDados] Carregando vendas e filtrando desde: ${dataLimite}`);
      
      const q = query(
        collection(db, "relatorioLubrificantes"),
        where("filial", "in", FILIAIS)
      );
      
      const snap = await getDocs(q);
      dadosCompletos = [];
      let filtrados = 0;
      
      snap.forEach(doc=>{
        const d = doc.data();
        const dataYYYYMMDD = d.dataYYYYMMDD || ddmmaaaaToYyyymmdd(d.data);
        
        // Filtrar √∫ltimos 2 anos no frontend
        if (dataYYYYMMDD && dataYYYYMMDD < dataLimite) {
          filtrados++;
          return; // Ignorar dados muito antigos
        }
        
        dadosCompletos.push({
          ...d,
          quantNF: Number(d.quantNF)||0,
          litros: Number(d.litros)||0,
          totalLitros: Number(d.totalLitros)||0,
          data: d.data || '',
          dataYYYYMMDD: dataYYYYMMDD,
          filial: d.filial || '',
          descricao: d.descricao || '',
          codProduto: d.codProduto || ''
        });
      });
      
      console.log(`[carregarDados] ${dadosCompletos.length} registros carregados (${filtrados} antigos ignorados)`);
    }

    function filtrar() {
      let ini = elDataInicio.value;
      let fim = elDataFim.value;
      let filial = elFiltroFilial.value;
      let codFilterRaw = (elFiltroProduto?.value || '').trim();
      let codigos = codFilterRaw
        ? codFilterRaw.split(/[\s,;]+/).map(s => s.toUpperCase()).filter(Boolean)
        : [];
      return dadosCompletos.filter(d => {
        const yyyymmdd = d.dataYYYYMMDD || ddmmaaaaToYyyymmdd(d.data);
        if (ini && (!yyyymmdd || yyyymmdd < ini)) return false;
        if (fim && (!yyyymmdd || yyyymmdd > fim)) return false;
        if (filial && d.filial !== filial) return false;
        if (codigos.length) {
          const cod = (d.codProduto || '').toUpperCase();
          const ok = codigos.some(c => cod.includes(c));
          if (!ok) return false;
        }
        return true;
      });
    }

    function atualizarKPIs(filtrados) {
      let totalLitros = filtrados.reduce((a,b)=>a+b.totalLitros,0);
      let totalVendas = filtrados.reduce((a,b)=>a+b.quantNF,0);
      let produtoMap = {};
      filtrados.forEach(d=>produtoMap[d.descricao]=(produtoMap[d.descricao]||0)+d.totalLitros);
      let topProd = Object.entries(produtoMap).sort((a,b)=>b[1]-a[1])[0];
      let filialMap = {};
      filtrados.forEach(d=>filialMap[d.filial]=(filialMap[d.filial]||0)+d.totalLitros);
      let topFilial = Object.entries(filialMap).sort((a,b)=>b[1]-a[1])[0];
      document.getElementById('kpi-total-litros').textContent = totalLitros.toLocaleString()+'L';
      document.getElementById('kpi-total-vendas').textContent = totalVendas.toLocaleString();
      var produtoElem = document.getElementById('kpi-produto-top');
      if (topProd) {
        var nomeProduto = topProd[0];
        produtoElem.textContent = nomeProduto.length > 50 ? nomeProduto.substring(0,50)+'...' : nomeProduto;
        produtoElem.setAttribute('title', nomeProduto);
      } else {
        produtoElem.textContent = '-';
        produtoElem.removeAttribute('title');
      }
      document.getElementById('kpi-top-filial').textContent = topFilial ? ((NOMES_FILIAIS[topFilial[0]]||topFilial[0])) : "-";
      lucide.createIcons();
    }

    function atualizarGraficos(filtrados) {
      // Gr√°fico de Filiais: Barras agrupadas (Litros e Unidades)
      let filialMap = {};
      let filialUnMap = {};
      filtrados.forEach(d => {
        filialMap[d.filial] = (filialMap[d.filial] || 0) + d.totalLitros;
        filialUnMap[d.filial] = (filialUnMap[d.filial] || 0) + d.quantNF;
      });
      let filiaisOrdenadas = Object.entries(filialMap).sort((a, b) => b[1] - a[1]);
      let labels = filiaisOrdenadas.map(([f]) => NOMES_FILIAIS[f] || f);
      let litros = filiaisOrdenadas.map(([f]) => filialMap[f]);
      let unidades = filiaisOrdenadas.map(([f]) => filialUnMap[f] || 0);

      // Calcular metas baseadas no per√≠odo selecionado (soma das metas mensais)
      const dataInicio = document.getElementById('data-inicio').value;
      const dataFim = document.getElementById('data-fim').value;
      
      function labelToId(lbl){
        if (/campos/i.test(lbl)) return '2';
        if (/rio.*sul/i.test(lbl)) return '6';
        if (/lages/i.test(lbl)) return '7';
        return '7';
      }
      
      function calcularMetaPeriodo(filialId) {
        if (!dataInicio || !dataFim) {
          const metasFixas = getMetasStorage();
          return Number(metasFixas[filialId] || 0);
        }
        const inicio = new Date(dataInicio);
        const fim = new Date(dataFim);
        let metaTotal = 0;
        let mesAtual = new Date(inicio.getFullYear(), inicio.getMonth(), 1);
        const mesFim = new Date(fim.getFullYear(), fim.getMonth(), 1);
        while (mesAtual <= mesFim) {
          const ano = mesAtual.getFullYear();
          const mes = mesAtual.getMonth() + 1;
          const metaMes = getMetaParaMes(ano, mes, filialId);
          metaTotal += metaMes;
          mesAtual.setMonth(mesAtual.getMonth() + 1);
        }
        return metaTotal;
      }
      
      const metasData = labels.map(l => calcularMetaPeriodo(labelToId(l)));

      // Acrescentar coluna "Geral" ao final: totais de Meta e Vendas(L)
      const totalMetaFiliais = metasData.reduce((a,b)=>a+(b||0),0);
      const totalVendasFiliais = litros.reduce((a,b)=>a+(b||0),0);
      labels = [...labels, 'Geral'];
      metasData.push(totalMetaFiliais);
      litros.push(totalVendasFiliais);
      unidades.push(unidades.reduce((a,b)=>a+(b||0),0));

      chartsOpts['graficoFiliais'] = {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Meta (L)',
              data: metasData,
              backgroundColor: 'rgba(249,168,37,0.6)',
              borderColor: 'rgba(249,168,37,1)',
              borderRadius: 7,
              barPercentage: 0.7,
              categoryPercentage: 0.6
            },
            {
              label: 'Litros',
              data: litros,
              backgroundColor: '#193b7c',
              borderRadius: 7,
              barPercentage: 0.7,
              categoryPercentage: 0.6
            },
            {
              label: 'Unidades',
              data: unidades,
              backgroundColor: '#ff497a',
              borderRadius: 7,
              barPercentage: 0.7,
              categoryPercentage: 0.6
            }
          ]
        },
        options: {
          devicePixelRatio: window.devicePixelRatio || 2,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.toLocaleString()}`
              }
            }
          },
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { 
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          },
          layout: {
            padding: {
              top: 65
            }
          }
        },
        plugins: [{
          id: 'barLabels',
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach(function(dataset, datasetIndex) {
              const meta = chart.getDatasetMeta(datasetIndex);
              if (!meta.hidden) {
                meta.data.forEach(function(bar, index) {
                  const value = dataset.data[index];
                  if (value > 0) {
                    ctx.save();
                    // Cor do texto baseada no dataset
                    ctx.fillStyle = datasetIndex === 0 ? '#193b7c' : '#ff497a';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    const x = bar.x;
                    const y = bar.y - 5;
                    ctx.fillText(value.toLocaleString(), x, y);
                    ctx.restore();
                  }
                });
              }
            });
          }
        },{
          id: 'sobrouFaltouIndicator',
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            const idxMeta = chart.data.datasets.findIndex(d=>d.label==='Meta (L)');
            const idxVendas = chart.data.datasets.findIndex(d=>d.label==='Litros');
            if (idxMeta === -1 || idxVendas === -1) return;
            const metaData = chart.getDatasetMeta(idxMeta).data;
            const vendasData = chart.getDatasetMeta(idxVendas).data;
            const unidadesData = chart.getDatasetMeta(2).data; // Unidades √© o 3¬∫ dataset
            // Desenhar seta e valor √† direita de cada grupo
            metaData.forEach((barMeta, i) => {
              const barVenda = vendasData[i];
              const barUnidades = unidadesData[i];
              if (!barMeta || !barVenda) return;
              const metaVal = chart.data.datasets[idxMeta].data[i] || 0;
              const vendasVal = chart.data.datasets[idxVendas].data[i] || 0;
              const diferenca = vendasVal - metaVal;
              const sobrou = diferenca >= 0;
              const color = sobrou ? '#28a745' : '#dc3545';
              const seta = sobrou ? '‚ñ≤' : '‚ñº';
              const valor = Math.abs(diferenca).toLocaleString();
              
              // Posicionar acima da barra mais alta do grupo
              const maxBarY = Math.min(barMeta.y, barVenda.y, barUnidades.y);
              const centerX = (barMeta.x + barVenda.x + barUnidades.x) / 3;
              const indicatorY = maxBarY - 50;
              
              ctx.save();
              // Fundo semi-transparente
              ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
              ctx.fillRect(centerX - 28, indicatorY - 18, 56, 38);
              // Seta
              ctx.font = 'bold 16px Arial';
              ctx.fillStyle = color;
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText(seta, centerX, indicatorY - 6);
              // Valor
              ctx.font = 'bold 10px Arial';
              ctx.fillText(valor, centerX, indicatorY + 14);
              ctx.restore();
            });
          }
        }]
      };

      // Gr√°fico de Participa√ß√£o (Pizza) das Filiais - SEM Geral
      const labelsParticipacao = filiaisOrdenadas.map(([f]) => NOMES_FILIAIS[f] || f);
      const litrosParticipacao = filiaisOrdenadas.map(([f]) => filialMap[f]);
      
      chartsOpts['graficoParticipacaoFiliais'] = {
        type: 'pie',
        data: {
          labels: labelsParticipacao,
          datasets: [{
            data: litrosParticipacao,
            backgroundColor: ['#193b7c', '#ff497a', '#f9a825'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          devicePixelRatio: window.devicePixelRatio || 2,
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  var total = ctx.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                  var pct = ((ctx.parsed / total) * 100).toFixed(1);
                  return ctx.label + ': ' + ctx.parsed.toLocaleString() + 'L (' + pct + '%)';
                }
              }
            }
          },
          layout: {
            padding: 10
          }
        },
        plugins: [{
          id: 'percentageLabelsFiliais',
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach(function(dataset, i) {
              const meta = chart.getDatasetMeta(i);
              if (!meta.hidden) {
                meta.data.forEach(function(element, index) {
                  ctx.fillStyle = '#fff';
                  ctx.font = 'bold 16px Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  const total = dataset.data.reduce((a, b) => a + b, 0);
                  const value = dataset.data[index];
                  const pct = ((value / total) * 100).toFixed(1);
                  const position = element.tooltipPosition();
                  ctx.fillText(pct + '%', position.x, position.y);
                });
              }
            });
          }
        }]
      };

      // Gr√°fico Mensal - Evolu√ß√£o de vendas no per√≠odo filtrado
      let mensalMap = {};
      // Usar as vari√°veis dataInicio e dataFim j√° declaradas acima
      
      console.log('[DEBUG Mensal] Data In√≠cio:', dataInicio, 'Data Fim:', dataFim);
      console.log('[DEBUG Mensal] Filtrados length:', filtrados.length);
      
      // Usar dados filtrados
      filtrados.forEach(d => {
        const dataConverted = ddmmaaaaToYyyymmdd(d.data);
        if (!dataConverted) return;
        const mesKey = dataConverted.slice(0, 7); // YYYY-MM
        mensalMap[mesKey] = (mensalMap[mesKey] || 0) + d.totalLitros;
      });
      
      console.log('[DEBUG Mensal] MensalMap:', mensalMap);
      
      // Gerar lista de meses no intervalo do filtro
      let mesesOrdenados = [];
      if (dataInicio && dataFim) {
        const [anoIni, mesIni] = dataInicio.split('-').map(Number);
        const [anoFim, mesFim] = dataFim.split('-').map(Number);
        
        let dataAtual = new Date(anoIni, mesIni - 1, 1);
        const dataLimite = new Date(anoFim, mesFim - 1, 1);
        
        while (dataAtual <= dataLimite) {
          const ano = dataAtual.getFullYear();
          const mes = String(dataAtual.getMonth() + 1).padStart(2, '0');
          mesesOrdenados.push(`${ano}-${mes}`);
          dataAtual.setMonth(dataAtual.getMonth() + 1);
        }
      } else {
        // Se n√£o houver filtro, usar todos os meses com dados
        mesesOrdenados = Object.keys(mensalMap).sort();
      }
      
      console.log('[DEBUG Mensal] Meses Ordenados:', mesesOrdenados);
      
      // Calcular cores baseadas na varia√ß√£o (verde subiu, vermelho desceu)
      let coresPontos = [];
      let valoresMensais = mesesOrdenados.map(m => mensalMap[m] || 0);
      
      console.log('[DEBUG Mensal] Valores Mensais:', valoresMensais);
      
      for (let i = 0; i < valoresMensais.length; i++) {
        if (i === 0) {
          coresPontos.push('#888'); // Primeiro m√™s cinza
        } else {
          coresPontos.push(valoresMensais[i] >= valoresMensais[i-1] ? '#28a745' : '#dc3545');
        }
      }
      
      chartsOpts['graficoMensal'] = {
        type: 'line',
        data: {
          labels: mesesOrdenados.map(m => formatarMes(m)),
          datasets: [{
            label: 'Litros/M√™s',
            data: valoresMensais,
            backgroundColor: 'rgba(25,59,124,0.09)',
            borderColor: '#193b7c',
            pointBackgroundColor: coresPontos,
            pointBorderColor: coresPontos,
            pointRadius: 6,
            pointHoverRadius: 8,
            borderWidth: 2,
            tension: .27,
            fill: true
          }]
        },
        options: { 
          devicePixelRatio: window.devicePixelRatio || 2,
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  return 'Litros: ' + (ctx.parsed.y || ctx.parsed).toLocaleString();
                },
                afterLabel: function(ctx) {
                  if (ctx.dataIndex > 0) {
                    const atual = ctx.parsed.y || ctx.parsed;
                    const anterior = ctx.dataset.data[ctx.dataIndex - 1];
                    const variacao = atual - anterior;
                    const variacaoPct = anterior > 0 ? ((variacao / anterior) * 100).toFixed(1) : '0.0';
                    const sinal = variacao >= 0 ? '+' : '';
                    return 'Varia√ß√£o: ' + sinal + variacao.toLocaleString() + 'L (' + sinal + variacaoPct + '%)';
                  }
                  return 'Primeiro per√≠odo';
                }
              }
            }
          }, 
          scales: { 
            y: { 
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + 'L';
                }
              }
            } 
          } 
        },
        plugins: [{
          id: 'trendArrows',
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            const dataset = chart.data.datasets[0];
            const meta = chart.getDatasetMeta(0);
            
            meta.data.forEach(function(point, index) {
              if (index > 0) {
                const prevValue = dataset.data[index - 1];
                const currValue = dataset.data[index];
                const variacaoPct = prevValue !== 0 ? (((currValue - prevValue) / prevValue) * 100).toFixed(1) : '0.0';
                const sinal = currValue - prevValue >= 0 ? '+' : '';
                ctx.save();
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                // Seta
                if (currValue > prevValue) {
                  ctx.fillStyle = '#28a745';
                  ctx.fillText('‚ñ≤', point.x, point.y - 25);
                } else if (currValue < prevValue) {
                  ctx.fillStyle = '#dc3545';
                  ctx.fillText('‚ñº', point.x, point.y - 25);
                }
                // Valor percentual
                ctx.font = 'bold 13px Arial';
                ctx.fillStyle = currValue > prevValue ? '#28a745' : (currValue < prevValue ? '#dc3545' : '#888');
                ctx.fillText(sinal + variacaoPct + '%', point.x, point.y - 40);
                ctx.restore();
              }
            });
          }
        }]
      };
      
      // Gr√°fico de Distribui√ß√£o usa dados filtrados normalmente
      let mensalMapFiltrado = {};
      filtrados.forEach(d => {
        let mes = ddmmaaaaToYyyymmdd(d.data).slice(0, 7);
        if (mes) { mensalMapFiltrado[mes] = (mensalMapFiltrado[mes] || 0) + d.totalLitros; }
      });

      // Usar mapeamento de tipos do conversaoLubrificantes (Op√ß√£o 1)
      var tiposMap = { 'Motor': 0, 'Transmiss√£o': 0, 'Hidr√°ulico': 0, 'Freio': 0, 'Graxa': 0, 'Outros': 0 };
      filtrados.forEach(function(item) {
        const conversoesInfo = obterLitrosPorUnidade(item.codProduto, item.descricao, item.grupo || '');
        const tipo = conversoesInfo.tipo || 'Outros';
        if (tiposMap[tipo] !== undefined) {
          tiposMap[tipo] += item.totalLitros;
        } else {
          tiposMap.Outros += item.totalLitros;
        }
      });
      Object.keys(tiposMap).forEach(function(k) { if (tiposMap[k] === 0) delete tiposMap[k]; });
      chartsOpts['graficoDistribuicao'] = {
        type: 'doughnut',
        data: { labels: Object.keys(tiposMap), datasets: [{ data: Object.values(tiposMap), backgroundColor: ['#193b7c', '#f9a825', '#28a745', '#ff497a', '#6f42c1', '#dc3545'] }] },
        options: {
          devicePixelRatio: window.devicePixelRatio || 2,
          responsive: true,
          maintainAspectRatio: false,
          plugins:
          {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0); let pct = ((ctx.parsed / total) * 100).toFixed(1);
                  return `${ctx.label}: ${ctx.parsed.toLocaleString()}L (${pct}%)`;
                }
              }
            }
          },
          layout: {
            padding: 10
          }
        },
        plugins: [{
          id: 'percentageLabels',
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach(function(dataset, i) {
              const meta = chart.getDatasetMeta(i);
              if (!meta.hidden) {
                meta.data.forEach(function(element, index) {
                  ctx.fillStyle = '#fff';
                  ctx.font = 'bold 16px Arial';
                  ctx.textAlign = 'center';
                  ctx.textBaseline = 'middle';
                  const total = dataset.data.reduce((a, b) => a + b, 0);
                  const value = dataset.data[index];
                  const pct = ((value / total) * 100).toFixed(1);
                  if (pct > 5) {
                    const position = element.tooltipPosition();
                    ctx.fillText(pct + '%', position.x, position.y);
                  }
                });
              }
            });
          }
        }]
      };
      
      // Gr√°fico de Estoque: Original (301) vs FleetPro (303)
      const mesesEstoque = Object.keys(estoqueMensal).sort();
      const labelsEstoque = mesesEstoque.map(m => formatarMes(m));
      const dadosOriginal = mesesEstoque.map(m => estoqueMensal[m].litrosOriginal || 0);
      const dadosFleetpro = mesesEstoque.map(m => estoqueMensal[m].litrosFleetpro || 0);
      const dadosTotal = mesesEstoque.map(m => estoqueMensal[m].litrosTotal || 0);
      
      chartsOpts['graficoOriginalFleetpro'] = {
        type: 'bar',
        data: {
          labels: labelsEstoque.length > 0 ? labelsEstoque : ['Sem dados'],
          datasets: [
            {
              label: 'Original (301)',
              data: dadosOriginal.length > 0 ? dadosOriginal : [0],
              backgroundColor: '#193b7c',
              borderRadius: 6,
              barPercentage: 0.7,
              categoryPercentage: 0.75
            },
            {
              label: 'FleetPro (303)',
              data: dadosFleetpro.length > 0 ? dadosFleetpro : [0],
              backgroundColor: '#28a745',
              borderRadius: 6,
              barPercentage: 0.7,
              categoryPercentage: 0.75
            },
            {
              label: 'Total Estoque',
              data: dadosTotal.length > 0 ? dadosTotal : [0],
              backgroundColor: '#f9a825',
              borderRadius: 6,
              barPercentage: 0.7,
              categoryPercentage: 0.75
            }
          ]
        },
        options: {
          devicePixelRatio: window.devicePixelRatio || 2,
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString()}L`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + 'L';
                }
              }
            }
          },
          layout: {
            padding: {
              top: 30
            }
          }
        },
        plugins: [{
          id: 'estoqueBarLabels',
          afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach(function(dataset, datasetIndex) {
              const meta = chart.getDatasetMeta(datasetIndex);
              if (!meta.hidden) {
                meta.data.forEach(function(bar, index) {
                  const value = dataset.data[index];
                  if (value > 0) {
                    ctx.save();
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 11px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    const x = bar.x;
                    const y = bar.y - 5;
                    ctx.fillText(value.toLocaleString(), x, y);
                    ctx.restore();
                  }
                });
              }
            });
          }
        }]
      };
      
      // Se n√£o houver dados de estoque, mostrar mensagem no gr√°fico
      if (mesesEstoque.length === 0) {
        chartsOpts['graficoOriginalFleetpro'].options.plugins.title = {
          display: true,
          text: 'Importe um CSV de estoque para visualizar os dados',
          color: '#999',
          font: { size: 14 }
        };
      }
      
      for (const id of Object.keys(chartsOpts)) atualizarGrafico(id, chartsOpts[id]);
    }

    // ==== AN√ÅLISE DE ESTOQUE COMPARATIVA ====
    async function processarAnaliseEstoque(file) {
      Swal.fire({title:'Processando...', text:'Analisando estoque...', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const csvData = e.target.result;
          const linhas = csvData.split('\n').filter(linha => linha.trim() !== '');
          
          if (linhas.length < 2) {
            Swal.fire('Erro!', 'Arquivo CSV vazio ou inv√°lido.', 'error');
            return;
          }
          
          // Pegar m√™s atual para buscar hist√≥rico e prever pr√≥ximo m√™s
          const hoje = new Date();
          const mesAtual = hoje.getMonth() + 1; // M√™s atual (1-12)
          const anoAtual = hoje.getFullYear();
          
          // M√™s que queremos prever (pr√≥ximo m√™s)
          const proximoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 1);
          const mesPrevisao = proximoMes.getMonth() + 1;
          const anoPrevisao = proximoMes.getFullYear();
          
          // Buscar hist√≥rico do M√äS ATUAL nos anos anteriores (n√£o do m√™s de previs√£o)
          const anoUmAnoAtras = anoAtual - 1;
          const anoDoisAnosAtras = anoAtual - 2;
          
          console.log(`[AN√ÅLISE] Prevendo necessidade para: ${mesPrevisao}/${anoPrevisao}`);
          console.log(`[AN√ÅLISE] Usando hist√≥rico de vendas de: ${mesPrevisao}/${anoDoisAnosAtras} e ${mesPrevisao}/${anoUmAnoAtras}`);
          
          // Atualizar texto informativo
          const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
          document.getElementById('ano-comparacao').textContent = `${anoDoisAnosAtras} e ${anoUmAnoAtras} (Previs√£o para ${meses[mesPrevisao - 1]}/${anoPrevisao} baseada em ${meses[mesPrevisao - 1]})`;
          
          // Processar estoque atual
          const estoqueAtual = [];
          const filiaisEncontradas = new Set(); // Debug: rastrear quais filiais aparecem no CSV
          let linhasIgnoradas = { total: 0, semFilial: 0, semCodigo: 0, fiscalZero: 0, filialInvalida: 0, colunasFaltando: 0 };
          
          for (let i = 1; i < linhas.length; i++) {
            const linha = linhas[i].trim();
            if (!linha || linha.startsWith('TOTAL')) continue;
            
            const colunas = linha.split(';');
            if (colunas.length < 13) {
              linhasIgnoradas.colunasFaltando++;
              console.warn(`[AN√ÅLISE] Linha ${i+1}: apenas ${colunas.length} colunas (m√≠nimo: 13)`);
              continue;
            }
            
            const filial = colunas[0]?.trim();
            filiaisEncontradas.add(filial); // Debug
            
            const codProduto = colunas[2]?.trim().replace(/[="()]/g, '');
            const descricao = colunas[3]?.trim();
            const grupo = colunas[4]?.trim();
            const descGrupo = colunas[5]?.trim();
            const fiscalStr = colunas[11]?.trim();
            const fiscal = parseFloat(fiscalStr?.replace(',', '.')) || 0;
            
            // Debug detalhado para as primeiras 3 linhas
            if (i <= 3) {
              console.log(`[AN√ÅLISE] Linha ${i+1}: Filial="${filial}", Cod="${codProduto}", Fiscal="${fiscalStr}" -> ${fiscal}`);
            }
            
            if (!codProduto) {
              linhasIgnoradas.semCodigo++;
              continue;
            }
            if (fiscal === 0) {
              linhasIgnoradas.fiscalZero++;
              if (i <= 5) console.log(`[AN√ÅLISE] Linha ${i+1} ignorada: fiscal = 0 (string original: "${fiscalStr}")`);
              continue;
            }
            if (!FILIAIS.includes(filial)) {
              linhasIgnoradas.filialInvalida++;
              console.warn(`[AN√ÅLISE] Filial "${filial}" n√£o est√° em FILIAIS (permitidas: ${FILIAIS.join(', ')})`);
              continue;
            }
            
            // Calcular litros
            const conversoesInfo = obterLitrosPorUnidade(codProduto, descricao, descGrupo);
            const litrosPorUnidade = conversoesInfo.litros;
            const totalLitros = fiscal * litrosPorUnidade;
            
            estoqueAtual.push({
              codProduto,
              descricao,
              filial,
              unidades: fiscal,
              litrosPorUnidade,
              totalLitros
            });
          }
          
          // Debug: mostrar estat√≠sticas de processamento
          console.log('[AN√ÅLISE] Estat√≠sticas de processamento do CSV:');
          console.log('  Total de linhas ignoradas:', linhasIgnoradas.total);
          console.log('  - Colunas faltando (<13):', linhasIgnoradas.colunasFaltando);
          console.log('  - Sem c√≥digo de produto:', linhasIgnoradas.semCodigo);
          console.log('  - Fiscal = 0:', linhasIgnoradas.fiscalZero);
          console.log('  - Filial inv√°lida:', linhasIgnoradas.filialInvalida);
          console.log('[AN√ÅLISE] Filiais encontradas no CSV:', Array.from(filiaisEncontradas).join(', '));
          console.log('[AN√ÅLISE] Total de itens de estoque processados:', estoqueAtual.length);
          console.log('[AN√ÅLISE] Distribui√ß√£o por filial:', 
            FILIAIS.map(f => `${NOMES_FILIAIS[f]}: ${estoqueAtual.filter(e => e.filial === f).length} itens`).join(', ')
          );
          
          // Buscar vendas de 2 anos atr√°s E 1 ano atr√°s do MESMO M√äS que queremos prever
          const mesKey2AnosAtras = `${anoDoisAnosAtras}-${String(mesPrevisao).padStart(2, '0')}`;
          const mesKey1AnoAtras = `${anoUmAnoAtras}-${String(mesPrevisao).padStart(2, '0')}`;
          
          // OTIMIZA√á√ÉO: Usar dados j√° carregados ao inv√©s de query nova
          console.log('[AN√ÅLISE] Usando dados j√° carregados em mem√≥ria (sem query adicional)');
          
          // Se dadosCompletos estiver vazio, carregar
          if (dadosCompletos.length === 0) {
            await carregarDados();
          }
          
          // Buscar vendas e consolidar por c√≥digos equivalentes E FILIAL
          // Estrutura: vendas2AnosAtras[filial][codigo] = { litros, unidades }
          const vendas2AnosAtras = {};
          const vendas1AnoAtras = {};
          
          // Inicializar estrutura por filial
          FILIAIS.forEach(f => {
            vendas2AnosAtras[f] = {};
            vendas1AnoAtras[f] = {};
          });
          
          // OTIMIZA√á√ÉO: Processar dados j√° em mem√≥ria
          dadosCompletos.forEach(d => {
            const dataConverted = d.dataYYYYMMDD || ddmmaaaaToYyyymmdd(d.data);
            if (!dataConverted) return;
            const mesAno = dataConverted.slice(0, 7);
            const cod = d.codProduto || '';
            const filial = d.filial || '';
            
            if (!FILIAIS.includes(filial)) return;
            
            // Vendas de 2 anos atr√°s
            if (mesAno === mesKey2AnosAtras) {
              if (!vendas2AnosAtras[filial][cod]) {
                vendas2AnosAtras[filial][cod] = { litros: 0, unidades: 0 };
              }
              vendas2AnosAtras[filial][cod].litros += (d.totalLitros || 0);
              vendas2AnosAtras[filial][cod].unidades += (d.quantConvertida || 0);
            }
            
            // Vendas de 1 ano atr√°s
            if (mesAno === mesKey1AnoAtras) {
              if (!vendas1AnoAtras[filial][cod]) {
                vendas1AnoAtras[filial][cod] = { litros: 0, unidades: 0 };
              }
              vendas1AnoAtras[filial][cod].litros += (d.totalLitros || 0);
              vendas1AnoAtras[filial][cod].unidades += (d.quantConvertida || 0);
            }
          });
          
          // Debug: verificar vendas carregadas
          console.log('[AN√ÅLISE] Vendas carregadas por filial:');
          FILIAIS.forEach(f => {
            const count2Anos = Object.keys(vendas2AnosAtras[f] || {}).length;
            const count1Ano = Object.keys(vendas1AnoAtras[f] || {}).length;
            console.log(`  ${NOMES_FILIAIS[f]}: ${count2Anos} produtos em ${anoDoisAnosAtras}, ${count1Ano} produtos em ${anoUmAnoAtras}`);
            
            // Debug espec√≠fico para c√≥digos equivalentes
            const codsDebug = ['76176R61BR', 'NH410B'];
            codsDebug.forEach(cod => {
              if (vendas1AnoAtras[f] && vendas1AnoAtras[f][cod]) {
                console.log(`    ${cod} em ${anoUmAnoAtras}: ${Math.round(vendas1AnoAtras[f][cod].litros)}L`);
              }
              if (vendas2AnosAtras[f] && vendas2AnosAtras[f][cod]) {
                console.log(`    ${cod} em ${anoDoisAnosAtras}: ${Math.round(vendas2AnosAtras[f][cod].litros)}L`);
              }
            });
          });
          
          // Consolidar vendas de c√≥digos equivalentes POR FILIAL
          // Para cada c√≥digo no estoque, somar vendas de todos seus equivalentes NA MESMA FILIAL
          function obterVendasConsolidadas(codigo, filial, vendasMap) {
            const equivalentes = obterCodigosEquivalentes(codigo);
            let totalLitros = 0;
            let totalUnidades = 0;
            
            if (!vendasMap[filial]) return { litros: 0, unidades: 0 };
            
            // Debug para c√≥digos espec√≠ficos
            const debugCodigos = ['76176R61BR', 'NH410B'];
            const isDebug = debugCodigos.some(d => codigo.toUpperCase().includes(d));
            
            if (isDebug) {
              console.log(`[CONSOLIDA√á√ÉO] C√≥digo: ${codigo}, Filial: ${NOMES_FILIAIS[filial]}`);
              console.log(`  Equivalentes encontrados:`, equivalentes);
            }
            
            equivalentes.forEach(codEquiv => {
              if (vendasMap[filial][codEquiv]) {
                const litros = vendasMap[filial][codEquiv].litros;
                const unidades = vendasMap[filial][codEquiv].unidades;
                totalLitros += litros;
                totalUnidades += unidades;
                
                if (isDebug) {
                  console.log(`    ${codEquiv}: ${Math.round(litros)}L, ${Math.round(unidades)} unid`);
                }
              }
            });
            
            if (isDebug) {
              console.log(`  Total consolidado: ${Math.round(totalLitros)}L, ${Math.round(totalUnidades)} unid`);
            }
            
            return { litros: totalLitros, unidades: totalUnidades };
          }
          
          // Montar tabela de an√°lise
          const tbody = document.getElementById('corpo-tabela-analise');
          tbody.innerHTML = '';
          
          // Agrupar estoque por produto E FILIAL
          // Chave: 'filial|codProduto'
          const estoquePorProdutoFilial = {};
          estoqueAtual.forEach(item => {
            const chave = `${item.filial}|${item.codProduto}`;
            if (!estoquePorProdutoFilial[chave]) {
              estoquePorProdutoFilial[chave] = {
                descricao: item.descricao,
                filial: item.filial,
                codProduto: item.codProduto,
                litros: 0,
                unidades: 0,
                litrosPorUnidade: item.litrosPorUnidade
              };
            }
            estoquePorProdutoFilial[chave].litros += item.totalLitros;
            estoquePorProdutoFilial[chave].unidades += item.unidades;
          });
          
          // Criar linhas da tabela
          const chaves = Object.keys(estoquePorProdutoFilial);
          let totalLinhas = 0;
          let totalSuficiente = 0;
          let totalFalta = 0;
          let totalSemHistorico = 0;
          
          // Preparar array com dados para ordena√ß√£o
          const produtosComStatus = chaves.map(chave => {
            const estoque = estoquePorProdutoFilial[chave];
            const cod = estoque.codProduto;
            const filial = estoque.filial;
            
            // Buscar vendas consolidadas considerando c√≥digos equivalentes DA MESMA FILIAL
            const vendas2Anos = obterVendasConsolidadas(cod, filial, vendas2AnosAtras);
            const vendas1Ano = obterVendasConsolidadas(cod, filial, vendas1AnoAtras);
            
            // Calcular m√©dia de vendas dos 2 anos
            const mediaLitros = (vendas2Anos.litros + vendas1Ano.litros) / 2;
            const mediaUnidades = (vendas2Anos.unidades + vendas1Ano.unidades) / 2;
            
            // Calcular estimativa (m√©dia √ó 1.2 para margem de seguran√ßa)
            const estimativaLitros = Math.ceil(mediaLitros * 1.2);
            const diferencaLitros = estoque.litros - estimativaLitros;
            
            // Determinar status e prioridade
            let status, badgeClass, iconeStatus, prioridade;
            if (vendas2Anos.litros === 0 && vendas1Ano.litros === 0) {
              status = 'Sem hist√≥rico';
              badgeClass = 'badge-sem-historico';
              iconeStatus = '‚ö™';
              prioridade = 3; // Por √∫ltimo
            } else if (diferencaLitros >= 0) {
              status = `‚úì Suficiente (+${Math.round(diferencaLitros)}L)`;
              badgeClass = 'badge-suficiente';
              iconeStatus = '‚úì';
              prioridade = 2; // Por segundo
            } else {
              status = `‚ö† Falta ${Math.abs(Math.round(diferencaLitros))}L`;
              badgeClass = 'badge-falta';
              iconeStatus = '‚ö†';
              prioridade = 1; // Por primeiro
            }
            
            return {
              cod,
              estoque,
              vendas2Anos,
              vendas1Ano,
              mediaLitros,
              estimativaLitros,
              status,
              badgeClass,
              iconeStatus,
              prioridade,
              diferencaLitros: Math.abs(diferencaLitros)
            };
          });
          
          // Ordenar: primeiro por prioridade (falta=1, suficiente=2, sem hist√≥rico=3),
          // depois por diferen√ßa (maior falta primeiro, maior suficiente primeiro)
          produtosComStatus.sort((a, b) => {
            if (a.prioridade !== b.prioridade) {
              return a.prioridade - b.prioridade;
            }
            // Dentro do mesmo status, ordenar por diferen√ßa (maior diferen√ßa primeiro)
            return b.diferencaLitros - a.diferencaLitros;
          });
          
          // Criar linhas
          produtosComStatus.forEach((produto, index) => {
            const { cod, estoque, vendas2Anos, vendas1Ano, mediaLitros, estimativaLitros, status, badgeClass } = produto;
            const filial = estoque.filial;
            const nomeFilial = NOMES_FILIAIS[filial] || `Filial ${filial}`;
            
            // Contar por status
            if (produto.prioridade === 1) totalFalta++;
            else if (produto.prioridade === 2) totalSuficiente++;
            else totalSemHistorico++;
            
            const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fc';
            
            const tr = document.createElement('tr');
            tr.className = 'produto-row';
            tr.style.background = bgColor;
            tr.style.borderBottom = '1px solid #e8ecf3';
            tr.dataset.codigo = cod.toLowerCase();
            tr.dataset.descricao = estoque.descricao.toLowerCase();
            tr.innerHTML = `
              <td style="padding:16px 20px;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                  <strong style="color:#193b7c; font-size:14px; font-weight:700;">${cod}</strong>
                  <small style="color:#666; font-size:12px;">${estoque.descricao}</small>
                  <span style="display:inline-block; margin-top:4px; padding:4px 10px; background:#193b7c; color:white; border-radius:12px; font-size:11px; font-weight:600; width:fit-content;">${nomeFilial}</span>
                </div>
              </td>
              <td style="padding:16px 20px; text-align:center;">
                <strong style="color:#193b7c; font-size:17px; font-weight:700;">${Math.round(estoque.litros)}L</strong>
              </td>
              <td style="padding:16px 20px; text-align:center;">
                <span style="color:#193b7c; font-size:15px; font-weight:600;">${Math.round(estoque.unidades)}</span>
              </td>
              <td style="padding:16px 20px; text-align:center;">
                <div class="vendas-historicas">
                  <span class="vendas-ano">${Math.round(vendas2Anos.litros)}L (${anoDoisAnosAtras})</span>
                  <span class="vendas-ano">${Math.round(vendas1Ano.litros)}L (${anoUmAnoAtras})</span>
                  <span class="vendas-media">M√©dia: ${Math.round(mediaLitros)}L</span>
                </div>
              </td>
              <td style="padding:16px 20px; text-align:center;">
                <strong style="color:#ffd700; font-size:17px; font-weight:700;">${estimativaLitros}L</strong>
              </td>
              <td style="padding:16px 20px; text-align:center;">
                <span class="badge-status ${badgeClass}">${status}</span>
              </td>
            `;
            tbody.appendChild(tr);
            totalLinhas++;
          });
          
          // Atualizar totalizadores
          document.getElementById('total-produtos').textContent = totalLinhas;
          document.getElementById('total-suficiente').textContent = totalSuficiente;
          document.getElementById('total-falta').textContent = totalFalta;
          document.getElementById('total-sem-historico').textContent = totalSemHistorico;
          
          if (totalLinhas === 0) {
            tbody.innerHTML = '<tr><td colspan=\"6\" style=\"text-align:center; padding:40px; color:#999;\">Nenhum produto encontrado para an√°lise</td></tr>';
          }
          
          // Implementar busca
          const searchInput = document.getElementById('search-analise');
          searchInput.addEventListener('input', function() {
            const termo = this.value.toLowerCase();
            const linhas = tbody.querySelectorAll('.produto-row');
            
            linhas.forEach(linha => {
              const codigo = linha.dataset.codigo;
              const descricao = linha.dataset.descricao;
              
              if (codigo.includes(termo) || descricao.includes(termo)) {
                linha.style.display = '';
              } else {
                linha.style.display = 'none';
              }
            });
          });
          
          // Exibir se√ß√£o
          document.getElementById('secao-analise-estoque').style.display = 'block';
          lucide.createIcons();
          
          Swal.fire({
            icon: 'success',
            title: 'An√°lise Conclu√≠da!',
            text: `${totalLinhas} produtos analisados`,
            timer: 2000,
            showConfirmButton: false
          });
          
        } catch (error) {
          console.error('Erro ao processar an√°lise:', error);
          Swal.fire('Erro!', 'Falha ao processar an√°lise: ' + error.message, 'error');
        }
      };
      
      reader.onerror = function(error) {
        console.error('Erro ao ler arquivo:', error);
        Swal.fire('Erro!', 'Falha ao ler o arquivo CSV.', 'error');
      };
      
      reader.readAsText(file, 'UTF-8');
    }

    function atualizarGrafico(id, config) {
      const canvas = document.getElementById(id);
      if (!canvas) {
        console.warn('[atualizarGrafico] Canvas n√£o encontrado:', id);
        return;
      }
      if (charts[id]) charts[id].destroy();
      console.log('[atualizarGrafico] Renderizando:', id);
      charts[id] = new Chart(canvas.getContext('2d'), config);
    }

    function formatarMes(mes) {
      if (!mes) return '-';
      let [y,m]=mes.split('-');
      const nomes=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      if(!y||!m) return mes;
      return nomes[Number(m)-1]+'/'+y.substr(2,2);
    }

    async function analisarDashboard() {
      if (!dadosCompletos.length) await carregarDados();
      const filtrados = filtrar();
      atualizarKPIs(filtrados);
      atualizarGraficos(filtrados);
    }

    // EXPANDIR GR√ÅFICOS - √Ä PROVA DE FECHA SOZINHO
    let modalOverlay = document.getElementById('modalOverlay');
    let modalCanvas = document.getElementById('modalGraph');
    let modalTitle = document.getElementById('modalTitle'); 
    let modalChart = null;
    let modalOpen = false;

    // Clone profundo preservando fun√ß√µes (evita perder callbacks ao usar JSON.stringify)
    function deepClonePreservandoFuncoes(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (Array.isArray(obj)) return obj.map(item => deepClonePreservandoFuncoes(item));
      const cloned = {};
      for (const key in obj) {
        const val = obj[key];
        // Preserva fun√ß√µes diretamente
        if (typeof val === 'function') {
          cloned[key] = val;
        } else if (val && typeof val === 'object') {
          cloned[key] = deepClonePreservandoFuncoes(val);
        } else {
          cloned[key] = val;
        }
      }
      return cloned;
    }

    function expandirGrafico(event) {
      event.preventDefault();
      // Evita que o clique continue propagando e acione listeners externos
      event.stopPropagation();
      if (modalOpen) { console.log('[EXPAND] Ignorado: modal j√° aberto'); return; }
      const graficoId = event.currentTarget.getAttribute('data-grafico');
      console.log('[EXPAND] In√≠cio expans√£o para', graficoId);
      // Garantir que configs existem
      if (!chartsOpts[graficoId]) {
        try { analisarDashboard(); } catch(e) { console.error('Falha ao gerar configs antes de expandir', e); }
      }
      if (!chartsOpts[graficoId]) { console.warn('Config do gr√°fico n√£o encontrada:', graficoId); return; }
      modalOpen = true;
      // Desabilita bot√µes de expandir enquanto modal est√° aberto
      document.querySelectorAll('.expand-btn').forEach(b=>{ b.disabled = true; b.style.opacity='.35'; });
      const tituloElemento = document.querySelector(`[data-grafico="${graficoId}"]`);
      const origTitle = tituloElemento ? tituloElemento.parentElement.querySelector('h4').textContent : 'Gr√°fico';
      modalTitle.textContent = origTitle + ' (Expandido)';
      // Recriar canvas para evitar tamanho preso
      try {
        const antigo = modalCanvas;
        const novoCanvas = document.createElement('canvas');
        novoCanvas.id = 'modalGraph';
        novoCanvas.className = 'modal-graph-canvas';
        antigo.parentElement.replaceChild(novoCanvas, antigo);
        modalCanvas = novoCanvas;
        console.log('[EXPAND] Canvas recriado');
      } catch(e) { console.error('Erro recriando canvas modal', e); }
      modalOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      // Destruir chart anterior se existir
      if (modalChart) { try { modalChart.destroy(); } catch(e) { console.error('Erro destruindo chart antigo', e); } modalChart = null; }
      requestAnimationFrame(()=>{
        try {
          // Clonar preservando fun√ß√µes para manter callbacks e plugins
          const originalConfig = chartsOpts[graficoId];
          // Simplifica√ß√£o: usar shallow clone e manter refer√™ncia de plugins
          const configClonado = {
            type: originalConfig.type,
            data: deepClonePreservandoFuncoes(originalConfig.data),
            options: Object.assign({}, originalConfig.options || {}),
            plugins: originalConfig.plugins
          };
          // Ajustar op√ß√µes para modal (mantendo callbacks originais)
          configClonado.options = Object.assign({}, configClonado.options, {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 250 }
          });
          console.log('[EXPAND] Criando Chart modal com tipo', configClonado.type);
          // Try/catch em plugins para impedir colapso
          if (Array.isArray(configClonado.plugins)) {
            configClonado.plugins = configClonado.plugins.map(p => {
              if (p && typeof p.afterDatasetsDraw === 'function') {
                const originalFn = p.afterDatasetsDraw;
                p.afterDatasetsDraw = function(chart) {
                  try { originalFn(chart); } catch(err) { console.error('[EXPAND][Plugin error]', err); }
                };
              }
              return p;
            });
          }
          modalChart = new Chart(modalCanvas.getContext('2d'), configClonado);
          console.log('[EXPAND] Chart modal criado com sucesso');
          // Guardar √∫ltima config para eventual re-render
          window.__ultimoConfigExpand = configClonado;
          // Checar tamanho ap√≥s render
          setTimeout(()=>{
            const rect = modalCanvas.getBoundingClientRect();
            console.log('[EXPAND] Tamanho canvas modal:', rect.width+'x'+rect.height);
            if (rect.width < 250 || rect.height < 250) {
              console.warn('[EXPAND] Canvas pequeno detectado. For√ßando re-render com timeout.');
              try {
                modalChart.destroy();
                modalChart = new Chart(modalCanvas.getContext('2d'), window.__ultimoConfigExpand);
                console.log('[EXPAND] Re-render for√ßado conclu√≠do');
              } catch(err2) { console.error('[EXPAND] Falha re-render for√ßado', err2); }
            }
          }, 120);
        } catch(e) {
          console.error('Erro criando gr√°fico expandido', e);
          // Mant√©m modal aberto para permitir inspe√ß√£o / erro vis√≠vel
          Swal.fire('Erro', 'Falha ao desenhar gr√°fico expandido. Verifique o console.', 'error');
        }
      });
    }
    // Fallback: expandir dentro do card original (mantido dentro do script)
    function aplicarFallbackInPlace(graficoId) {
      // Fecha modal imediatamente sem anima√ß√£o
      fecharModal(true);
      const canvasOriginal = document.getElementById(graficoId);
      if (!canvasOriginal) { console.error('[FALLBACK] Canvas original n√£o encontrado:', graficoId); return; }
      const card = canvasOriginal.closest('.grafico-card');
      if (!card) { console.error('[FALLBACK] Card n√£o encontrado'); return; }
      card.classList.add('expanded-inplace');
      card.style.position='relative';
      card.style.zIndex='9998';
      card.style.boxShadow='0 6px 28px #193b7c55';
      card.style.minHeight='600px';
      canvasOriginal.style.height='560px';
      canvasOriginal.style.maxHeight='560px';
      if (charts[graficoId]) {
        try { charts[graficoId].resize(); } catch(e){ console.error('[FALLBACK] Erro resize', e); }
      }
      if (!card.querySelector('.close-inplace')) {
        const btn = document.createElement('button');
        btn.textContent='Fechar';
        btn.className='btn-acao close-inplace';
        btn.style.position='absolute'; btn.style.top='10px'; btn.style.left='10px';
        btn.onclick=function(){
          card.classList.remove('expanded-inplace');
          card.style.minHeight='';
          canvasOriginal.style.height=''; canvasOriginal.style.maxHeight='';
          btn.remove();
          document.querySelectorAll('.expand-btn').forEach(b=>{ b.disabled=false; b.style.opacity=''; });
        };
        card.appendChild(btn);
      }
      document.querySelectorAll('.expand-btn').forEach(b=>{ b.disabled=false; b.style.opacity=''; });
    }

    // Fun√ß√£o √∫nica para fechar modal (com op√ß√£o de imediato)
    function fecharModal(imediato=false) {
      if (imediato) {
        modalOverlay.classList.remove('active');
        if (modalChart) { try { modalChart.destroy(); } catch(e){} }
        modalChart=null; modalOpen=false; document.body.style.overflow='';
        document.querySelectorAll('.expand-btn').forEach(b=>{ b.disabled=false; b.style.opacity=''; });
        return;
      }
      modalOverlay.classList.remove('active');
      setTimeout(()=>{
        if (modalChart) try { modalChart.destroy(); } catch(e){}
        modalChart = null;
        modalOpen = false;
        document.body.style.overflow = '';
        document.querySelectorAll('.expand-btn').forEach(b=>{ b.disabled = false; b.style.opacity=''; });
      }, 320);
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.expand-btn').forEach(btn=>{
        btn.addEventListener('click', expandirGrafico);
      });
      document.getElementById('modalClose').onclick = fecharModal;
      modalOverlay.onclick = e => { if (e.target===modalOverlay) fecharModal(); };
      document.addEventListener('keydown',function(e){ if (modalOverlay.classList.contains('active') && e.key==='Escape') fecharModal(); });
      lucide.createIcons();

      // Bot√£o Estoque: abrir seletor de arquivo diretamente
      document.getElementById('btn-estoque').addEventListener('click', () => {
        // Mostrar instru√ß√£o antes de abrir seletor
        Swal.fire({
          title: 'üì¶ Lan√ßar Estoque Mensal',
          html: `
            <div style="text-align:left;">
              <p>Selecione os <strong>3 arquivos CSV</strong> de estoque:</p>
              <ul style="margin:10px 0; padding-left:20px;">
                <li>Campos Novos</li>
                <li>Rio do Sul</li>
                <li>Lages</li>
              </ul>
              <p><small>üí° Dica: Segure <strong>Ctrl</strong> para selecionar m√∫ltiplos arquivos</small></p>
            </div>
          `,
          icon: 'info',
          showCancelButton: true,
          confirmButtonText: 'Selecionar Arquivos',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#193b7c'
        }).then((result) => {
          if (result.isConfirmed) {
            document.getElementById('csv-estoque-file').click();
          }
        });
      });

      // Upload CSV Estoque (m√∫ltiplos arquivos)
      document.getElementById('csv-estoque-file').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          // Verificar se todos s√£o CSV
          const arquivos = Array.from(e.target.files);
          const todosCSV = arquivos.every(f => f.name.toLowerCase().endsWith('.csv'));
          
          if (todosCSV) {
            processarCSVEstoque(e.target.files);
          } else {
            Swal.fire('Erro!', 'Por favor, selecione apenas arquivos CSV.', 'error');
          }
          e.target.value = ''; // Limpar input
        }
      });

      // Bot√£o An√°lise de Estoque
      document.getElementById('btn-analise-estoque').addEventListener('click', () => {
        document.getElementById('csv-analise-estoque-file').click();
      });
      
      // Fechar an√°lise de estoque
      document.getElementById('btn-fechar-analise').addEventListener('click', () => {
        document.getElementById('secao-analise-estoque').style.display = 'none';
      });
      
      // Upload CSV An√°lise de Estoque
      document.getElementById('csv-analise-estoque-file').addEventListener('change', (e) => {
        if (e.target.files.length) {
          const file = e.target.files[0];
          if (file.name.toLowerCase().endsWith('.csv')) {
            processarAnaliseEstoque(file);
          } else {
            Swal.fire('Erro!', 'Por favor, selecione um arquivo CSV.', 'error');
          }
          e.target.value = '';
        }
      });
      
      // Bot√£o Importar CSV Vendas
      document.getElementById('btn-importar').addEventListener('click', () => {
        const upload = document.getElementById('upload-container');
        upload.style.display = (upload.style.display === 'block') ? 'none' : 'block';
      });
      // Selecionar arquivo via bot√£o
      document.getElementById('btn-select-file').addEventListener('click', () => {
        document.getElementById('csv-file').click();
      });
      // Drag and drop upload
      const uploadContainer = document.getElementById('upload-container');
      uploadContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadContainer.classList.add('dragover');
      });
      uploadContainer.addEventListener('dragleave', () => {
        uploadContainer.classList.remove('dragover');
      });
      uploadContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadContainer.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          const file = e.dataTransfer.files[0];
          if (file.name.toLowerCase().endsWith('.csv')) {
            exibirInfoArquivo(file);
            processarCSV(file);
          } else {
            Swal.fire('Erro!', 'Por favor, selecione um arquivo CSV.', 'error');
          }
        }
      });
      // Upload via file input
      document.getElementById('csv-file').addEventListener('change', (e) => {
        if (e.target.files.length) {
          const file = e.target.files[0];
          exibirInfoArquivo(file);
          processarCSV(file);
        }
      });
      // Bot√£o Metas Mensais
      const btnMetasMensais = document.getElementById('btn-metas-mensais');
      if (btnMetasMensais) {
        btnMetasMensais.addEventListener('click', () => { abrirModalMetasMensais(); });
      }
    });

    document.getElementById('data-inicio').onchange = ()=>{ if(!modalOpen) analisarDashboard(); };
    document.getElementById('data-fim').onchange = ()=>{ if(!modalOpen) analisarDashboard(); };
    document.getElementById('filtro-filial').onchange = ()=>{ if(!modalOpen) analisarDashboard(); };
    const filtroProdutoEl = document.getElementById('filtro-produto');
    if (filtroProdutoEl) {
      filtroProdutoEl.addEventListener('input', ()=>{ if(!modalOpen) analisarDashboard(); });
    }

    // Cache de seletores DOM frequentes
    const elDataInicio = document.getElementById('data-inicio');
    const elDataFim = document.getElementById('data-fim');
    const elFiltroFilial = document.getElementById('filtro-filial');
    const elFiltroProduto = document.getElementById('filtro-produto');
    const elDynamicTitle = document.getElementById('dynamic-title');
    
    userData = await garantirAutenticacao();
    
    // Atualizar t√≠tulo com filiais do usu√°rio
    if (userData.filial && userData.filial.length > 0) {
      elDynamicTitle.textContent = `Filiais: ${userData.filial.join(", ")}`;
    } else {
      elDynamicTitle.textContent = 'Todas as Filiais';
    }
    
    // Carregar metas do Firebase
    await getMetasFirebase();
    await getMetasMensaisFirebase();
    
    setDatasPadrao(); await carregarDados(); await carregarEstoqueMensal(); analisarDashboard();

    // ========== METAS FIREBASE - Fun√ß√µes e Modal ==========
    // Criar bot√£o de metas e modal
    function ensureMetasUI() {
      // Bot√£o j√° existe no HTML, apenas adicionar o evento
      let btn = document.getElementById('btn-metas');
      if (btn) {
        btn.onclick = () => abrirModalMetas();
      }

      // Modal
      let modal = document.getElementById('modalMetas');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalMetas';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.background = 'rgba(0,0,0,0.35)';
        modal.style.display = 'none';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        const content = document.createElement('div');
        content.style.background = '#fff';
        content.style.borderRadius = '12px';
        content.style.boxShadow = '0 6px 20px rgba(25,59,124,0.12)';
        content.style.width = '520px';
        content.style.maxWidth = '92vw';
        content.style.padding = '16px';
        content.style.position = 'relative';
        const title = document.createElement('h3');
        title.textContent = 'Definir Metas por Filial (Litros)';
        title.style.margin = '0 0 10px';
        title.style.color = '#193B7C';
        title.style.textAlign = 'center';
        const form = document.createElement('div');
        form.style.display = 'grid';
        form.style.gridTemplateColumns = '1fr 1fr';
        form.style.gap = '10px';
        const metas = getMetasStorage();
        filiaisMeta.forEach(f => {
          const wrap = document.createElement('div');
          const label = document.createElement('label');
          label.textContent = f.nome;
          label.style.fontSize = '12px';
          label.style.color = '#193B7C';
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.step = '1';
          input.value = metas[f.id] || '';
          input.id = 'meta-filial-' + f.id;
          input.style.width = '100%';
          input.style.padding = '10px';
          input.style.border = '1px solid #e0e6f0';
          input.style.borderRadius = '8px';
          wrap.appendChild(label);
          wrap.appendChild(input);
          form.appendChild(wrap);
        });
        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.justifyContent = 'flex-end';
        actions.style.gap = '8px';
        actions.style.marginTop = '10px';
        const btnCancel = document.createElement('button');
        btnCancel.textContent = 'Cancelar';
        btnCancel.style.background = '#f0f3f8';
        btnCancel.style.color = '#193B7C';
        btnCancel.style.border = 'none';
        btnCancel.style.padding = '8px 12px';
        btnCancel.style.borderRadius = '8px';
        const btnSave = document.createElement('button');
        btnSave.textContent = 'Salvar';
        btnSave.style.background = '#193B7C';
        btnSave.style.color = '#fff';
        btnSave.style.border = 'none';
        btnSave.style.padding = '8px 12px';
        btnSave.style.borderRadius = '8px';
        actions.appendChild(btnCancel);
        actions.appendChild(btnSave);
        content.appendChild(title);
        content.appendChild(form);
        content.appendChild(actions);
        modal.appendChild(content);
        document.body.appendChild(modal);

        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
        btnCancel.addEventListener('click', () => { modal.style.display = 'none'; });
        btnSave.addEventListener('click', async () => {
          const m = getMetasStorage();
          filiaisMeta.forEach(f => {
            const val = Number(document.getElementById('meta-filial-' + f.id).value || 0);
            m[f.id] = val;
          });
          // Salvar no Firebase
          const salvoComSucesso = await salvarMetasFirebase(m);
          if (salvoComSucesso) {
            setMetasStorage(m);
            modal.style.display = 'none';
            atualizarMetasNoGraficoFiliais(m);
            analisarDashboard();
            Swal.fire({
              toast: true,
              position: 'top-end',
              icon: 'success',
              title: 'Metas salvas com sucesso!',
              showConfirmButton: false,
              timer: 2000
            });
          }
        });
      }
    }

    function abrirModalMetas() {
      const modal = document.getElementById('modalMetas');
      if (!modal) return;
      // Preencher com valores atuais
      const metas = getMetasStorage();
      filiaisMeta.forEach(f => {
        const el = document.getElementById('meta-filial-' + f.id);
        if (el) el.value = metas[f.id] || '';
      });
      modal.style.display = 'flex';
    }
    
    function criarModalMetasMensais() {
      let modal = document.getElementById('modalMetasMensais');
      if (modal) return;
      modal = document.createElement('div');
      modal.id = 'modalMetasMensais';
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(25,59,124,0.5);display:none;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(3px);';
      const content = document.createElement('div');
      content.style.cssText = 'background:#fff;border-radius:20px;box-shadow:0 10px 40px rgba(25,59,124,0.25);width:900px;max-width:95vw;max-height:90vh;overflow:hidden;position:relative;';
      const header = document.createElement('div');
      header.style.cssText = 'background:linear-gradient(135deg, #193B7C 0%, #2d5aa0 100%);padding:28px 32px;';
      const title = document.createElement('h2');
      title.textContent = 'Configurar Metas Mensais por Filial';
      title.style.cssText = 'margin:0 0 8px;color:#fff;text-align:center;font-size:1.5em;font-weight:600;';
      const subtitle = document.createElement('p');
      subtitle.textContent = 'Defina metas individuais (em litros) para cada m√™s. Deixe em branco para usar a meta padr√£o.';
      subtitle.style.cssText = 'text-align:center;color:#e8f0ff;font-size:0.9em;margin:0;opacity:0.95;';
      header.appendChild(title);
      header.appendChild(subtitle);
      const bodyContent = document.createElement('div');
      bodyContent.style.cssText = 'padding:28px 32px;overflow:auto;max-height:calc(90vh - 180px);';
      const anoAtual = new Date().getFullYear();
      const selectAno = document.createElement('select');
      selectAno.id = 'select-ano-metas';
      selectAno.style.cssText = 'width:180px;padding:12px 16px;border:2px solid #193B7C;border-radius:10px;font-size:1.05em;margin:0 auto 28px;display:block;background:#fff;color:#193B7C;font-weight:600;cursor:pointer;transition:all 0.2s;';
      selectAno.onmouseover = () => { selectAno.style.borderColor = '#2d5aa0'; selectAno.style.boxShadow = '0 2px 8px rgba(25,59,124,0.15)'; };
      selectAno.onmouseout = () => { selectAno.style.borderColor = '#193B7C'; selectAno.style.boxShadow = 'none'; };
      for (let i = anoAtual - 1; i <= anoAtual + 1; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        if (i === anoAtual) opt.selected = true;
        selectAno.appendChild(opt);
      }
      const tabela = document.createElement('table');
      tabela.style.cssText = 'width:100%;border-collapse:separate;border-spacing:0;margin-bottom:20px;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.08);';
      const thead = document.createElement('thead');
      const trHead = document.createElement('tr');
      trHead.innerHTML = '<th style="padding:14px 16px;background:linear-gradient(135deg, #193B7C 0%, #2d5aa0 100%);color:#fff;font-weight:600;font-size:0.95em;text-align:left;border:none;">M√™s</th>';
      filiaisMeta.forEach(f => {
        trHead.innerHTML += `<th style="padding:14px 16px;background:linear-gradient(135deg, #193B7C 0%, #2d5aa0 100%);color:#fff;font-weight:600;font-size:0.95em;text-align:center;border:none;">${f.nome}</th>`;
      });
      thead.appendChild(trHead);
      tabela.appendChild(thead);
      const tbody = document.createElement('tbody');
      tbody.id = 'tbody-metas-mensais';
      const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      function renderizarMeses(ano) {
        tbody.innerHTML = '';
        const metasMensais = getMetasMensaisStorage();
        meses.forEach((nomeMes, idx) => {
          const mesNum = idx + 1;
          const chave = `${ano}-${String(mesNum).padStart(2, '0')}`;
          const tr = document.createElement('tr');
          tr.style.cssText = `background:${idx % 2 === 0 ? '#f8f9fc' : '#fff'};transition:background 0.2s;`;
          tr.onmouseover = () => { tr.style.background = '#e8f0ff'; };
          tr.onmouseout = () => { tr.style.background = idx % 2 === 0 ? '#f8f9fc' : '#fff'; };
          const tdMes = document.createElement('td');
          tdMes.textContent = nomeMes;
          tdMes.style.cssText = 'padding:12px 16px;border:none;border-bottom:1px solid #e8ecf3;font-weight:600;color:#193b7c;font-size:0.95em;';
          tr.appendChild(tdMes);
          filiaisMeta.forEach(f => {
            const td = document.createElement('td');
            td.style.cssText = 'padding:8px 12px;border:none;border-bottom:1px solid #e8ecf3;text-align:center;';
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '0';
            input.step = '1';
            input.placeholder = 'Meta';
            input.dataset.ano = ano;
            input.dataset.mes = mesNum;
            input.dataset.filial = f.id;
            input.value = (metasMensais[chave] && metasMensais[chave][f.id]) || '';
            input.style.cssText = 'width:100%;padding:10px 12px;border:2px solid #e0e6f0;border-radius:8px;text-align:center;font-size:0.95em;transition:all 0.2s;background:#fff;';
            input.onfocus = () => { input.style.borderColor = '#193B7C'; input.style.boxShadow = '0 0 0 3px rgba(25,59,124,0.1)'; };
            input.onblur = () => { input.style.borderColor = '#e0e6f0'; input.style.boxShadow = 'none'; };
            td.appendChild(input);
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }
      selectAno.addEventListener('change', () => { renderizarMeses(parseInt(selectAno.value)); });
      renderizarMeses(anoAtual);
      tabela.appendChild(tbody);
      bodyContent.appendChild(selectAno);
      bodyContent.appendChild(tabela);
      const actions = document.createElement('div');
      actions.style.cssText = 'display:flex;justify-content:flex-end;gap:12px;padding:20px 32px;background:#f8f9fc;border-top:1px solid #e8ecf3;';
      const btnCancel = document.createElement('button');
      btnCancel.textContent = 'Cancelar';
      btnCancel.style.cssText = 'background:#fff;color:#193B7C;border:2px solid #e0e6f0;padding:11px 24px;border-radius:10px;cursor:pointer;font-size:1em;font-weight:600;transition:all 0.2s;';
      btnCancel.onmouseover = () => { btnCancel.style.background = '#f0f3f8'; btnCancel.style.borderColor = '#193B7C'; };
      btnCancel.onmouseout = () => { btnCancel.style.background = '#fff'; btnCancel.style.borderColor = '#e0e6f0'; };
      btnCancel.onclick = () => modal.style.display = 'none';
      const btnSave = document.createElement('button');
      btnSave.textContent = 'üíæ Salvar Metas';
      btnSave.style.cssText = 'background:linear-gradient(135deg, #193B7C 0%, #2d5aa0 100%);color:#fff;border:none;padding:12px 28px;border-radius:10px;cursor:pointer;font-size:1em;font-weight:600;box-shadow:0 4px 12px rgba(25,59,124,0.3);transition:all 0.2s;';
      btnSave.onmouseover = () => { btnSave.style.transform = 'translateY(-2px)'; btnSave.style.boxShadow = '0 6px 16px rgba(25,59,124,0.4)'; };
      btnSave.onmouseout = () => { btnSave.style.transform = 'translateY(0)'; btnSave.style.boxShadow = '0 4px 12px rgba(25,59,124,0.3)'; };
      btnSave.onclick = async () => {
        const metasMensais = getMetasMensaisStorage();
        const inputs = tbody.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
          const ano = input.dataset.ano;
          const mes = String(input.dataset.mes).padStart(2, '0');
          const filialId = input.dataset.filial;
          const chave = `${ano}-${mes}`;
          const valor = input.value.trim();
          if (!metasMensais[chave]) metasMensais[chave] = {};
          if (valor !== '') {
            metasMensais[chave][filialId] = Number(valor);
          } else {
            delete metasMensais[chave][filialId];
          }
          if (Object.keys(metasMensais[chave]).length === 0) {
            delete metasMensais[chave];
          }
        });
        // Salvar no Firebase com feedback
        Swal.fire({title:'Salvando...',text:'Aguarde...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
        const salvoComSucesso = await salvarMetasMensaisFirebase(metasMensais);
        if (salvoComSucesso) {
          setMetasMensaisStorage(metasMensais);
          modal.style.display = 'none';
          Swal.fire({ 
            icon: 'success', 
            title: 'Metas mensais salvas!', 
            text: 'Os gr√°ficos ser√£o atualizados agora.' 
          }).then(() => {
            analisarDashboard();
          });
        } else {
          Swal.fire('Erro', 'Falha ao salvar as metas mensais. Tente novamente.', 'error');
        }
      };
      actions.appendChild(btnCancel);
      actions.appendChild(btnSave);
      content.appendChild(header);
      content.appendChild(bodyContent);
      content.appendChild(actions);
      modal.appendChild(content);
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    }
    function abrirModalMetasMensais() {
      criarModalMetasMensais();
      const modal = document.getElementById('modalMetasMensais');
      if (modal) modal.style.display = 'flex';
    }

    function atualizarMetasNoGraficoFiliais(metasObj) {
      const chart = window.charts && window.charts.graficoFiliais ? window.charts.graficoFiliais : null;
      const canvas = document.getElementById('graficoFiliais');
      if (!chart || !canvas) return;
      const labels = chart.data.labels || [];
      const metasData = labels.map(l => {
        const id = /campos/i.test(l) ? '2' : /rio.*sul/i.test(l) ? '6' : '1';
        return Number((metasObj || {})[id] || 0);
      });
      let metaIdx = chart.data.datasets.findIndex(ds => ds.label === 'Meta (L)');
      const metaDataset = {
        type: 'bar',
        label: 'Meta (L)',
        data: metasData,
        backgroundColor: 'rgba(249,168,37,0.6)',
        borderColor: 'rgba(249,168,37,1)',
        borderWidth: 1,
        categoryPercentage: 0.6,
        barPercentage: 0.7,
        yAxisID: chart.options.scales && chart.options.scales.y ? 'y' : undefined,
      };
      if (metaIdx === -1) {
        chart.data.datasets.unshift(metaDataset);
      } else {
        chart.data.datasets[metaIdx] = metaDataset;
        // Garantir que "Meta (L)" fique como primeira coluna para compara√ß√£o clara
        if (metaIdx !== 0) {
          const ds = chart.data.datasets.splice(metaIdx, 1)[0];
          chart.data.datasets.unshift(ds);
        }
      }
      chart.update();
    }

    // Garantir que a meta apare√ßa assim que o gr√°fico for criado
    function ensureMetaOnFiliais() {
      const metas = getMetasStorage();
      let tries = 0;
      const maxTries = 20; // ~4s
      const timer = setInterval(() => {
        tries++;
        const chart = window.charts && window.charts.graficoFiliais ? window.charts.graficoFiliais : null;
        const canvas = document.getElementById('graficoFiliais');
        if (chart && canvas) {
          clearInterval(timer);
          atualizarMetasNoGraficoFiliais(metas);
        } else if (tries >= maxTries) {
          clearInterval(timer);
        }
      }, 200);
    }
    
    // Inicializar metas: bot√£o/modal e gr√°fico ap√≥s carregar
    console.log('[Init] Chamando ensureMetasUI()...');
    ensureMetasUI();
    ensureMetaOnFiliais();
  </script>
  <script type="module" src="/assets/js/firebase-config.js"></script>
  <script type="module" src="/assets/js/auth.js"></script>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/components/Sidebar.js"></script>
</body>
</html>
